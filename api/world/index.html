
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://TannerTorrey3.github.io/DSG-JIT/api/world/">
      
      
        <link rel="prev" href="../scene_graph/">
      
      
        <link rel="next" href="../datasets/">
      
      
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>World Model - DSG-JIT</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="deep-purple" data-md-color-accent="teal">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#world-model-modules" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="DSG-JIT" class="md-header__button md-logo" aria-label="DSG-JIT" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            DSG-JIT
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              World Model
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="deep-purple" data-md-color-accent="teal"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="teal"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/TannerTorrey3/DSG-JIT" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    TannerTorrey3/DSG-JIT
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="DSG-JIT" class="md-nav__button md-logo" aria-label="DSG-JIT" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    DSG-JIT
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/TannerTorrey3/DSG-JIT" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    TannerTorrey3/DSG-JIT
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Architecture
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../benchmarks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Benchmarks
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Examples
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../roadmap/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Roadmap
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../glossary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Glossary
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" checked>
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    API
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    API
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../core/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Core
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../slam/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SLAM
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sensors/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sensors
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../optimization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Optimization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../scene_graph/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Scene Graph
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    World Model
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    World Model
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#worldmodel" class="md-nav__link">
    <span class="md-ellipsis">
      
        world.model
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="world.model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#world.model--key-responsibilities" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key responsibilities
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model--typical-usage" class="md-nav__link">
    <span class="md-ellipsis">
      
        Typical usage
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model--design-goals" class="md-nav__link">
    <span class="md-ellipsis">
      
        Design goals
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#world.model.ActiveWindowTemplate" class="md-nav__link">
    <span class="md-ellipsis">
      
        ActiveWindowTemplate
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#world.model.FactorSlot" class="md-nav__link">
    <span class="md-ellipsis">
      
        FactorSlot
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#world.model.VarSlot" class="md-nav__link">
    <span class="md-ellipsis">
      
        VarSlot
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#world.model.WorldModel" class="md-nav__link">
    <span class="md-ellipsis">
      
        WorldModel
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="WorldModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.add_agent_pose" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_agent_pose
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.add_camera_bearings" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_camera_bearings
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.add_factor" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_factor
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.add_imu_preintegration_factor" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_imu_preintegration_factor
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.add_lidar_ranges" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_lidar_ranges
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.add_object" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_object
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.add_place" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_place
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.add_pose" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_pose
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.add_room" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_room
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.add_variable" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_variable
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.build_objective" class="md-nav__link">
    <span class="md-ellipsis">
      
        build_objective
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.build_residual" class="md-nav__link">
    <span class="md-ellipsis">
      
        build_residual
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="build_residual">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.build_residual--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.build_residual--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.build_residual_function_se3_odom_param_multi" class="md-nav__link">
    <span class="md-ellipsis">
      
        build_residual_function_se3_odom_param_multi
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="build_residual_function_se3_odom_param_multi">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.build_residual_function_se3_odom_param_multi--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.build_residual_function_voxel_point_param" class="md-nav__link">
    <span class="md-ellipsis">
      
        build_residual_function_voxel_point_param
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="build_residual_function_voxel_point_param">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.build_residual_function_voxel_point_param--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.build_residual_function_voxel_point_param_multi" class="md-nav__link">
    <span class="md-ellipsis">
      
        build_residual_function_voxel_point_param_multi
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="build_residual_function_voxel_point_param_multi">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.build_residual_function_voxel_point_param_multi--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.build_residual_function_with_type_weights" class="md-nav__link">
    <span class="md-ellipsis">
      
        build_residual_function_with_type_weights
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.configure_factor_slot" class="md-nav__link">
    <span class="md-ellipsis">
      
        configure_factor_slot
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.fixed_lag_marginalize" class="md-nav__link">
    <span class="md-ellipsis">
      
        fixed_lag_marginalize
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.get_residual" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_residual
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_residual">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.get_residual--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.get_residual--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.get_residuals" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_residuals
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.get_variable_value" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_variable_value
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.init_active_template" class="md-nav__link">
    <span class="md-ellipsis">
      
        init_active_template
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.list_residual_types" class="md-nav__link">
    <span class="md-ellipsis">
      
        list_residual_types
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="list_residual_types">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.list_residual_types--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.marginalize_variables" class="md-nav__link">
    <span class="md-ellipsis">
      
        marginalize_variables
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.optimize" class="md-nav__link">
    <span class="md-ellipsis">
      
        optimize
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.pack_state" class="md-nav__link">
    <span class="md-ellipsis">
      
        pack_state
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.register_residual" class="md-nav__link">
    <span class="md-ellipsis">
      
        register_residual
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="register_residual">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.register_residual--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.set_variable_slot" class="md-nav__link">
    <span class="md-ellipsis">
      
        set_variable_slot
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.snapshot_state" class="md-nav__link">
    <span class="md-ellipsis">
      
        snapshot_state
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.unpack_state" class="md-nav__link">
    <span class="md-ellipsis">
      
        unpack_state
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.unpack_state_inplace" class="md-nav__link">
    <span class="md-ellipsis">
      
        unpack_state_inplace
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#world.model.marginal_prior_residual" class="md-nav__link">
    <span class="md-ellipsis">
      
        marginal_prior_residual
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#worldscene_graph" class="md-nav__link">
    <span class="md-ellipsis">
      
        world.scene_graph
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="world.scene_graph">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#world.scene_graph--typical-usage" class="md-nav__link">
    <span class="md-ellipsis">
      
        Typical usage
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph--design-goals" class="md-nav__link">
    <span class="md-ellipsis">
      
        Design goals
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphNoiseConfig" class="md-nav__link">
    <span class="md-ellipsis">
      
        SceneGraphNoiseConfig
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld" class="md-nav__link">
    <span class="md-ellipsis">
      
        SceneGraphWorld
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SceneGraphWorld">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_agent_pose_landmark_bearing" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_agent_pose_landmark_bearing
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_agent_pose_landmark_relative" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_agent_pose_landmark_relative
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_agent_pose_place_attachment" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_agent_pose_place_attachment
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_agent_pose_se3" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_agent_pose_se3
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_agent_pose_voxel_point" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_agent_pose_voxel_point
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_agent_range_measurement" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_agent_range_measurement
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_agent_temporal_smoothness" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_agent_temporal_smoothness
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_landmark3d" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_landmark3d
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_named_object3d" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_named_object3d
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_object3d" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_object3d
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_object_room_edge" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_object_room_edge
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_odom_se3_additive" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_odom_se3_additive
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_odom_se3_geodesic" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_odom_se3_geodesic
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_place1d" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_place1d
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_place3d" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_place3d
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_place_attachment" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_place_attachment
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_pose_landmark_bearing" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_pose_landmark_bearing
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_pose_landmark_relative" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_pose_landmark_relative
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_pose_se3" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_pose_se3
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_pose_voxel_point" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_pose_voxel_point
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_range_measurement" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_range_measurement
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_room" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_room
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_room1d" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_room1d
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_room_place_edge" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_room_place_edge
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_temporal_smoothness" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_temporal_smoothness
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_voxel_cell" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_voxel_cell
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_voxel_point_observation" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_voxel_point_observation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_voxel_smoothness" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_voxel_smoothness
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.attach_object_to_pose" class="md-nav__link">
    <span class="md-ellipsis">
      
        attach_object_to_pose
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.attach_pose_to_place_x" class="md-nav__link">
    <span class="md-ellipsis">
      
        attach_pose_to_place_x
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.attach_pose_to_room_x" class="md-nav__link">
    <span class="md-ellipsis">
      
        attach_pose_to_room_x
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.dump_state" class="md-nav__link">
    <span class="md-ellipsis">
      
        dump_state
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.enable_active_template" class="md-nav__link">
    <span class="md-ellipsis">
      
        enable_active_template
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.get_object3d" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_object3d
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.get_place" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_place
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.get_pose" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_pose
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.optimize" class="md-nav__link">
    <span class="md-ellipsis">
      
        optimize
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.optimize_active_batch" class="md-nav__link">
    <span class="md-ellipsis">
      
        optimize_active_batch
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.optimize_global_offline" class="md-nav__link">
    <span class="md-ellipsis">
      
        optimize_global_offline
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.visualize_web" class="md-nav__link">
    <span class="md-ellipsis">
      
        visualize_web
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#world.scene_graph.SceneNodeState" class="md-nav__link">
    <span class="md-ellipsis">
      
        SceneNodeState
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#worldvoxel_grid" class="md-nav__link">
    <span class="md-ellipsis">
      
        world.voxel_grid
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="world.voxel_grid">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#world.voxel_grid--key-responsibilities" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key responsibilities
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.voxel_grid--role-in-the-dsg-jit-stack" class="md-nav__link">
    <span class="md-ellipsis">
      
        Role in the DSG-JIT stack
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.voxel_grid--integration-points" class="md-nav__link">
    <span class="md-ellipsis">
      
        Integration points
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.voxel_grid--design-goals" class="md-nav__link">
    <span class="md-ellipsis">
      
        Design goals
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#world.voxel_grid.VoxelGridSpec" class="md-nav__link">
    <span class="md-ellipsis">
      
        VoxelGridSpec
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#world.voxel_grid.build_voxel_grid" class="md-nav__link">
    <span class="md-ellipsis">
      
        build_voxel_grid
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#world.voxel_grid.connect_grid_neighbors_1d_x" class="md-nav__link">
    <span class="md-ellipsis">
      
        connect_grid_neighbors_1d_x
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#worldtraining" class="md-nav__link">
    <span class="md-ellipsis">
      
        world.training
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="world.training">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#world.training--typical-structure" class="md-nav__link">
    <span class="md-ellipsis">
      
        Typical structure
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.training--design-goals" class="md-nav__link">
    <span class="md-ellipsis">
      
        Design goals
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#world.training.DSGTrainer" class="md-nav__link">
    <span class="md-ellipsis">
      
        DSGTrainer
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DSGTrainer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#world.training.DSGTrainer.__post_init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __post_init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.training.DSGTrainer.solve_state" class="md-nav__link">
    <span class="md-ellipsis">
      
        solve_state
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.training.DSGTrainer.unpack_state" class="md-nav__link">
    <span class="md-ellipsis">
      
        unpack_state
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#world.training.InnerGDConfig" class="md-nav__link">
    <span class="md-ellipsis">
      
        InnerGDConfig
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#worldvisualization" class="md-nav__link">
    <span class="md-ellipsis">
      
        world.visualization
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#world.visualization.VisEdge" class="md-nav__link">
    <span class="md-ellipsis">
      
        VisEdge
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#world.visualization.VisNode" class="md-nav__link">
    <span class="md-ellipsis">
      
        VisNode
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#world.visualization.export_factor_graph_for_vis" class="md-nav__link">
    <span class="md-ellipsis">
      
        export_factor_graph_for_vis
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#world.visualization.plot_dynamic_trajectories_3d" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot_dynamic_trajectories_3d
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#world.visualization.plot_factor_graph_2d" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot_factor_graph_2d
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#world.visualization.plot_factor_graph_3d" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot_factor_graph_3d
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#world.visualization.plot_scenegraph_3d" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot_scenegraph_3d
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#worlddynamic_scene_graph" class="md-nav__link">
    <span class="md-ellipsis">
      
        world.dynamic_scene_graph
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="world.dynamic_scene_graph">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#world.dynamic_scene_graph--design-goals" class="md-nav__link">
    <span class="md-ellipsis">
      
        Design goals
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.dynamic_scene_graph--typical-usage" class="md-nav__link">
    <span class="md-ellipsis">
      
        Typical usage
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#world.dynamic_scene_graph.DynamicSceneGraph" class="md-nav__link">
    <span class="md-ellipsis">
      
        DynamicSceneGraph
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DynamicSceneGraph">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#world.dynamic_scene_graph.DynamicSceneGraph--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.dynamic_scene_graph.DynamicSceneGraph.add_agent" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_agent
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.dynamic_scene_graph.DynamicSceneGraph.add_agent_pose" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_agent_pose
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.dynamic_scene_graph.DynamicSceneGraph.add_agent_trajectory" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_agent_trajectory
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.dynamic_scene_graph.DynamicSceneGraph.add_odom_tx" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_odom_tx
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.dynamic_scene_graph.DynamicSceneGraph.add_range_obs" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_range_obs
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.dynamic_scene_graph.DynamicSceneGraph.all_pose_time_keys" class="md-nav__link">
    <span class="md-ellipsis">
      
        all_pose_time_keys
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.dynamic_scene_graph.DynamicSceneGraph.get_agent_pose_nodes" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_agent_pose_nodes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.dynamic_scene_graph.DynamicSceneGraph.get_agent_times" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_agent_times
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.dynamic_scene_graph.DynamicSceneGraph.get_agent_trajectory" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_agent_trajectory
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.dynamic_scene_graph.DynamicSceneGraph.get_all_trajectories" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_all_trajectories
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../datasets/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Datasets
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Tutorials
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Tutorials
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Introduction
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_2" >
        
          
          <label class="md-nav__link" for="__nav_8_2" id="__nav_8_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Core Concepts
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Core Concepts
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/mini_world/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Mini World Factor Graph
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/manifold_geometry_se3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Manifold Geometry SE(3)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/scene_graph_world/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Building a Semantic Scene Graph World
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/scene_graph_objects/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Working with Objects in Scene Graphs
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/differentiable_voxel_obs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Differentiable Voxel Observations
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/visual_factor_graph/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Visualizing a Factor Graph in 3D
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/scenegraph_3d/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    3D Scene Graph Construction & Visualization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/scenegraph_demo/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Scene Graph Demo - Rooms, Places, Poses, and Objects
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/dynamic_scenegraph_demo/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Dynamic Scene Graph Demo
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_3" >
        
          
          <label class="md-nav__link" for="__nav_8_3" id="__nav_8_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    SE(3) & SLAM
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    SE(3) & SLAM
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/manifold_geometry_se3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Manifold Geometry SE(3)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/scene_graph_world/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Building a Semantic Scene Graph World
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/dynamic_trajectories/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Dynamic Trajectories
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/differentiable_se3_odom_chain/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Differentiable SE(3) Odometry Chain
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/scenegraph_type_weights/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Learnable Factor-Type Weights in a Scene Graph
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/hybrid_se3_voxel_joint_learning/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Hybrid SE(3) & Voxel Joint Parameter Learning
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/hybrid_dsg/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Hybrid Differentiable Scene Graphs
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/visual_factor_graph/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Visualizing a Factor Graph in 3D
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/scenegraph_3d/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    3D Scene Graph Construction & Visualization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/dynamic_scenegraph_demo/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Dynamic Scene Graph Demo
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/sliding_window/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SlidingWindow Optimization with Active Templates
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_4" >
        
          
          <label class="md-nav__link" for="__nav_8_4" id="__nav_8_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Voxel Grids & Spatial Fields
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Voxel Grids & Spatial Fields
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/differentiable_voxel_obs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Differentiable Voxel Observations
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/multi_voxel_param/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Multi-Voxel Parameter Optimization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/trainer_voxel_point_multi/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Multi-Voxel Point Observation Learning
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/multi_voxel_param_weight/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Joint Learning of Voxel Observation Parameters & Type Weights
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/hybrid_se3_voxel_joint_learning/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Hybrid SE(3) & Voxel Joint Parameter Learning
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/hybrid_dsg/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Hybrid Differentiable Scene Graphs
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_5" >
        
          
          <label class="md-nav__link" for="__nav_8_5" id="__nav_8_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Static Scene Graphs
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Static Scene Graphs
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/scene_graph_world/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Building a Semantic Scene Graph World
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/scene_graph_objects/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Working with Objects in Scene Graphs
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/scene_graph_objects_jit/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Scene Graph Objects (JIT)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/dynamic_trajectories/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Dynamic Trajectories
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/scenegraph_demo/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Scene Graph Demo - Rooms, Places, Poses, and Objects
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_6" >
        
          
          <label class="md-nav__link" for="__nav_8_6" id="__nav_8_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Dynamic Scene Graphs
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Dynamic Scene Graphs
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/scenegraph_type_weights/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Learnable Factor-Type Weights in a Scene Graph
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/trainer_voxel_point_multi/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Multi-Voxel Point Observation Learning
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/hybrid_se3_voxel_joint_learning/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Hybrid SE(3) & Voxel Joint Parameter Learning
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/hybrid_dsg/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Hybrid Differentiable Scene Graphs
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/scenegraph_3d/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    3D Scene Graph Construction & Visualization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/dynamic_scenegraph_demo/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Dynamic Scene Graph Demo
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/range_sensor_dsg/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Range Sensor Dynamic Scene Graph
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/sensor_dsg_mapping/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sensor DSG Mapping (End-to-End)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/sliding_window/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SlidingWindow Optimization with Active Templates
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_7" >
        
          
          <label class="md-nav__link" for="__nav_8_7" id="__nav_8_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Sensors & Fusion
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Sensors & Fusion
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/range_sensor_dsg/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Range Sensor Dynamic Scene Graph
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/sensor_fusion_demo/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sensor Fusion Sandbox - Camera, LiDAR, and IMU Streams
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/sensor_dsg_mapping/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sensor DSG Mapping (End-to-End)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_8" >
        
          
          <label class="md-nav__link" for="__nav_8_8" id="__nav_8_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Learning & Hybrid Modules
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Learning & Hybrid Modules
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/multi_voxel_param/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Multi-Voxel Parameter Optimization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/differentiable_se3_odom_chain/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Differentiable SE(3) Odometry Chain
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/learn_type_weights/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Learning Factor-Type Weights
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/scenegraph_type_weights/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Learnable Factor-Type Weights in a Scene Graph
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/trainer_voxel_point_multi/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Multi-Voxel Point Observation Learning
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/multi_voxel_param_weight/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Joint Learning of Voxel Observation Parameters & Type Weights
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/hybrid_se3_voxel_joint_learning/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Hybrid SE(3) & Voxel Joint Parameter Learning
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/hybrid_dsg/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Hybrid Differentiable Scene Graphs
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_9" >
        
          
          <label class="md-nav__link" for="__nav_8_9" id="__nav_8_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    JAX & JIT
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    JAX & JIT
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/scene_graph_objects_jit/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Scene Graph Objects (JIT)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/differentiable_voxel_obs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Differentiable Voxel Observations
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/visual_factor_graph/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Visualizing a Factor Graph in 3D
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/sliding_window/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SlidingWindow Optimization with Active Templates
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#worldmodel" class="md-nav__link">
    <span class="md-ellipsis">
      
        world.model
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="world.model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#world.model--key-responsibilities" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key responsibilities
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model--typical-usage" class="md-nav__link">
    <span class="md-ellipsis">
      
        Typical usage
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model--design-goals" class="md-nav__link">
    <span class="md-ellipsis">
      
        Design goals
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#world.model.ActiveWindowTemplate" class="md-nav__link">
    <span class="md-ellipsis">
      
        ActiveWindowTemplate
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#world.model.FactorSlot" class="md-nav__link">
    <span class="md-ellipsis">
      
        FactorSlot
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#world.model.VarSlot" class="md-nav__link">
    <span class="md-ellipsis">
      
        VarSlot
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#world.model.WorldModel" class="md-nav__link">
    <span class="md-ellipsis">
      
        WorldModel
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="WorldModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.add_agent_pose" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_agent_pose
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.add_camera_bearings" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_camera_bearings
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.add_factor" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_factor
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.add_imu_preintegration_factor" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_imu_preintegration_factor
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.add_lidar_ranges" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_lidar_ranges
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.add_object" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_object
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.add_place" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_place
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.add_pose" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_pose
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.add_room" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_room
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.add_variable" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_variable
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.build_objective" class="md-nav__link">
    <span class="md-ellipsis">
      
        build_objective
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.build_residual" class="md-nav__link">
    <span class="md-ellipsis">
      
        build_residual
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="build_residual">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.build_residual--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.build_residual--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.build_residual_function_se3_odom_param_multi" class="md-nav__link">
    <span class="md-ellipsis">
      
        build_residual_function_se3_odom_param_multi
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="build_residual_function_se3_odom_param_multi">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.build_residual_function_se3_odom_param_multi--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.build_residual_function_voxel_point_param" class="md-nav__link">
    <span class="md-ellipsis">
      
        build_residual_function_voxel_point_param
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="build_residual_function_voxel_point_param">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.build_residual_function_voxel_point_param--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.build_residual_function_voxel_point_param_multi" class="md-nav__link">
    <span class="md-ellipsis">
      
        build_residual_function_voxel_point_param_multi
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="build_residual_function_voxel_point_param_multi">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.build_residual_function_voxel_point_param_multi--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.build_residual_function_with_type_weights" class="md-nav__link">
    <span class="md-ellipsis">
      
        build_residual_function_with_type_weights
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.configure_factor_slot" class="md-nav__link">
    <span class="md-ellipsis">
      
        configure_factor_slot
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.fixed_lag_marginalize" class="md-nav__link">
    <span class="md-ellipsis">
      
        fixed_lag_marginalize
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.get_residual" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_residual
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_residual">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.get_residual--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.get_residual--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.get_residuals" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_residuals
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.get_variable_value" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_variable_value
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.init_active_template" class="md-nav__link">
    <span class="md-ellipsis">
      
        init_active_template
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.list_residual_types" class="md-nav__link">
    <span class="md-ellipsis">
      
        list_residual_types
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="list_residual_types">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.list_residual_types--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.marginalize_variables" class="md-nav__link">
    <span class="md-ellipsis">
      
        marginalize_variables
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.optimize" class="md-nav__link">
    <span class="md-ellipsis">
      
        optimize
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.pack_state" class="md-nav__link">
    <span class="md-ellipsis">
      
        pack_state
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.register_residual" class="md-nav__link">
    <span class="md-ellipsis">
      
        register_residual
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="register_residual">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.register_residual--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.set_variable_slot" class="md-nav__link">
    <span class="md-ellipsis">
      
        set_variable_slot
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.snapshot_state" class="md-nav__link">
    <span class="md-ellipsis">
      
        snapshot_state
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.unpack_state" class="md-nav__link">
    <span class="md-ellipsis">
      
        unpack_state
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.model.WorldModel.unpack_state_inplace" class="md-nav__link">
    <span class="md-ellipsis">
      
        unpack_state_inplace
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#world.model.marginal_prior_residual" class="md-nav__link">
    <span class="md-ellipsis">
      
        marginal_prior_residual
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#worldscene_graph" class="md-nav__link">
    <span class="md-ellipsis">
      
        world.scene_graph
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="world.scene_graph">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#world.scene_graph--typical-usage" class="md-nav__link">
    <span class="md-ellipsis">
      
        Typical usage
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph--design-goals" class="md-nav__link">
    <span class="md-ellipsis">
      
        Design goals
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphNoiseConfig" class="md-nav__link">
    <span class="md-ellipsis">
      
        SceneGraphNoiseConfig
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld" class="md-nav__link">
    <span class="md-ellipsis">
      
        SceneGraphWorld
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SceneGraphWorld">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_agent_pose_landmark_bearing" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_agent_pose_landmark_bearing
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_agent_pose_landmark_relative" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_agent_pose_landmark_relative
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_agent_pose_place_attachment" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_agent_pose_place_attachment
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_agent_pose_se3" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_agent_pose_se3
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_agent_pose_voxel_point" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_agent_pose_voxel_point
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_agent_range_measurement" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_agent_range_measurement
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_agent_temporal_smoothness" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_agent_temporal_smoothness
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_landmark3d" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_landmark3d
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_named_object3d" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_named_object3d
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_object3d" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_object3d
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_object_room_edge" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_object_room_edge
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_odom_se3_additive" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_odom_se3_additive
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_odom_se3_geodesic" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_odom_se3_geodesic
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_place1d" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_place1d
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_place3d" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_place3d
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_place_attachment" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_place_attachment
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_pose_landmark_bearing" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_pose_landmark_bearing
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_pose_landmark_relative" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_pose_landmark_relative
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_pose_se3" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_pose_se3
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_pose_voxel_point" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_pose_voxel_point
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_range_measurement" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_range_measurement
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_room" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_room
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_room1d" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_room1d
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_room_place_edge" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_room_place_edge
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_temporal_smoothness" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_temporal_smoothness
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_voxel_cell" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_voxel_cell
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_voxel_point_observation" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_voxel_point_observation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.add_voxel_smoothness" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_voxel_smoothness
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.attach_object_to_pose" class="md-nav__link">
    <span class="md-ellipsis">
      
        attach_object_to_pose
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.attach_pose_to_place_x" class="md-nav__link">
    <span class="md-ellipsis">
      
        attach_pose_to_place_x
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.attach_pose_to_room_x" class="md-nav__link">
    <span class="md-ellipsis">
      
        attach_pose_to_room_x
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.dump_state" class="md-nav__link">
    <span class="md-ellipsis">
      
        dump_state
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.enable_active_template" class="md-nav__link">
    <span class="md-ellipsis">
      
        enable_active_template
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.get_object3d" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_object3d
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.get_place" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_place
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.get_pose" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_pose
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.optimize" class="md-nav__link">
    <span class="md-ellipsis">
      
        optimize
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.optimize_active_batch" class="md-nav__link">
    <span class="md-ellipsis">
      
        optimize_active_batch
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.optimize_global_offline" class="md-nav__link">
    <span class="md-ellipsis">
      
        optimize_global_offline
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.scene_graph.SceneGraphWorld.visualize_web" class="md-nav__link">
    <span class="md-ellipsis">
      
        visualize_web
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#world.scene_graph.SceneNodeState" class="md-nav__link">
    <span class="md-ellipsis">
      
        SceneNodeState
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#worldvoxel_grid" class="md-nav__link">
    <span class="md-ellipsis">
      
        world.voxel_grid
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="world.voxel_grid">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#world.voxel_grid--key-responsibilities" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key responsibilities
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.voxel_grid--role-in-the-dsg-jit-stack" class="md-nav__link">
    <span class="md-ellipsis">
      
        Role in the DSG-JIT stack
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.voxel_grid--integration-points" class="md-nav__link">
    <span class="md-ellipsis">
      
        Integration points
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.voxel_grid--design-goals" class="md-nav__link">
    <span class="md-ellipsis">
      
        Design goals
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#world.voxel_grid.VoxelGridSpec" class="md-nav__link">
    <span class="md-ellipsis">
      
        VoxelGridSpec
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#world.voxel_grid.build_voxel_grid" class="md-nav__link">
    <span class="md-ellipsis">
      
        build_voxel_grid
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#world.voxel_grid.connect_grid_neighbors_1d_x" class="md-nav__link">
    <span class="md-ellipsis">
      
        connect_grid_neighbors_1d_x
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#worldtraining" class="md-nav__link">
    <span class="md-ellipsis">
      
        world.training
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="world.training">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#world.training--typical-structure" class="md-nav__link">
    <span class="md-ellipsis">
      
        Typical structure
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.training--design-goals" class="md-nav__link">
    <span class="md-ellipsis">
      
        Design goals
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#world.training.DSGTrainer" class="md-nav__link">
    <span class="md-ellipsis">
      
        DSGTrainer
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DSGTrainer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#world.training.DSGTrainer.__post_init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __post_init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.training.DSGTrainer.solve_state" class="md-nav__link">
    <span class="md-ellipsis">
      
        solve_state
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.training.DSGTrainer.unpack_state" class="md-nav__link">
    <span class="md-ellipsis">
      
        unpack_state
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#world.training.InnerGDConfig" class="md-nav__link">
    <span class="md-ellipsis">
      
        InnerGDConfig
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#worldvisualization" class="md-nav__link">
    <span class="md-ellipsis">
      
        world.visualization
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#world.visualization.VisEdge" class="md-nav__link">
    <span class="md-ellipsis">
      
        VisEdge
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#world.visualization.VisNode" class="md-nav__link">
    <span class="md-ellipsis">
      
        VisNode
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#world.visualization.export_factor_graph_for_vis" class="md-nav__link">
    <span class="md-ellipsis">
      
        export_factor_graph_for_vis
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#world.visualization.plot_dynamic_trajectories_3d" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot_dynamic_trajectories_3d
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#world.visualization.plot_factor_graph_2d" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot_factor_graph_2d
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#world.visualization.plot_factor_graph_3d" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot_factor_graph_3d
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#world.visualization.plot_scenegraph_3d" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot_scenegraph_3d
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#worlddynamic_scene_graph" class="md-nav__link">
    <span class="md-ellipsis">
      
        world.dynamic_scene_graph
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="world.dynamic_scene_graph">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#world.dynamic_scene_graph--design-goals" class="md-nav__link">
    <span class="md-ellipsis">
      
        Design goals
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.dynamic_scene_graph--typical-usage" class="md-nav__link">
    <span class="md-ellipsis">
      
        Typical usage
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#world.dynamic_scene_graph.DynamicSceneGraph" class="md-nav__link">
    <span class="md-ellipsis">
      
        DynamicSceneGraph
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DynamicSceneGraph">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#world.dynamic_scene_graph.DynamicSceneGraph--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.dynamic_scene_graph.DynamicSceneGraph.add_agent" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_agent
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.dynamic_scene_graph.DynamicSceneGraph.add_agent_pose" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_agent_pose
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.dynamic_scene_graph.DynamicSceneGraph.add_agent_trajectory" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_agent_trajectory
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.dynamic_scene_graph.DynamicSceneGraph.add_odom_tx" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_odom_tx
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.dynamic_scene_graph.DynamicSceneGraph.add_range_obs" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_range_obs
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.dynamic_scene_graph.DynamicSceneGraph.all_pose_time_keys" class="md-nav__link">
    <span class="md-ellipsis">
      
        all_pose_time_keys
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.dynamic_scene_graph.DynamicSceneGraph.get_agent_pose_nodes" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_agent_pose_nodes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.dynamic_scene_graph.DynamicSceneGraph.get_agent_times" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_agent_times
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.dynamic_scene_graph.DynamicSceneGraph.get_agent_trajectory" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_agent_trajectory
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world.dynamic_scene_graph.DynamicSceneGraph.get_all_trajectories" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_all_trajectories
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="world-model-modules">World Model Modules</h1>
<p>This section documents the high-level world model, scene-graph integration, voxel grid management, and training utilities.</p>
<hr />
<h2 id="worldmodel"><code>world.model</code></h2>


<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">

        <p>World-level wrapper and optimization front-end around the core factor graph.</p>
<p>This module defines the <em>world model</em> abstraction: a typed layer on top of
<code>core.factor_graph.FactorGraph</code> that understands high-level entities
(poses, places, rooms, voxels, objects, agents) and also centralizes
residual construction, JIT compilation, and solver orchestration.</p>
<p>In other words, :class:<code>WorldModel</code> is the bridge between:</p>
<pre><code> Low-level optimization (factor graph, residual functions, manifolds)
 High-level scene graph abstractions (poses, agents, rooms, voxels)
 Application code that wants a simple, stable API for "optimize my world"
</code></pre>
<p>The underlying :class:<code>FactorGraph</code> remains a relatively small, generic
data structure that stores variables and factors and knows nothing about
JAX, JIT, or manifolds. All JAX-specific logic (residual registries,
vmap-based batching, GaussNewton wrappers, etc.) is owned by the world
model.</p>
<h3 id="world.model--key-responsibilities">Key responsibilities</h3>
<ul>
<li>Manage the underlying :class:<code>FactorGraph</code> instance.</li>
<li>Provide ergonomic helpers to:
     Add variables with automatically assigned :class:<code>NodeId</code>s.
     Add typed factors (e.g. priors, odometry, attachments, voxel terms).
     Pack / unpack state vectors for optimization.</li>
<li>Maintain simple bookkeeping structures (e.g. maps from user-facing
  handles / indices back to :class:<code>NodeId</code>s) so that experiments and
  higher-level layers do not need to manipulate :class:<code>NodeId</code> directly.</li>
<li>Maintain a residual-function registry that maps factor-type strings
  (e.g. <code>"odom_se3"</code>, <code>"voxel_point_obs"</code>) to JAX-compatible
  residuals.</li>
<li>Build unified, vmap-optimized residual and objective functions on
  demand, caching compiled versions keyed by graph structure.</li>
<li>Expose convenient optimization entry points (e.g. :meth:<code>optimize</code>,
  or :class:<code>optimization.jit_wrappers.JittedGN</code>) that operate directly
  on the world model.</li>
</ul>
<h3 id="world.model--typical-usage">Typical usage</h3>
<p>Experiments and higher layers typically:</p>
<pre><code>1. Construct a :class:`WorldModel`.
2. Add variables &amp; factors according to a scenario.
3. Register residual functions for each factor type of interest.
4. Build a residual or objective from the world model and call into
   :mod:`dsg_jit.optimization.solvers` or :mod:`dsg_jit.optimization.jit_wrappers`
   to run GaussNewton (potentially manifold-aware) or gradient-based
   optimization.
5. Decode and interpret the optimized state via the world models
   convenience accessors, or export it to higher-level scene-graph
   structures.
</code></pre>
<h3 id="world.model--design-goals">Design goals</h3>
<ul>
<li><strong>Backend separation</strong>: keep :class:<code>FactorGraph</code> as a minimal,
  backend-agnostic data structure (variables, factors, connectivity),
  while :class:<code>WorldModel</code> owns JAX-facing logic such as residual
  construction, vmap batching, and JIT caching.</li>
<li><strong>Scene-friendly</strong>: provide enough structure that scene graphs, voxel
  modules, and DSG layers can build on top of the world model without
  duplicating graph or optimization logic.</li>
<li><strong>Ergonomic but explicit</strong>: favor simple, explicit methods
  (<code>add_variable</code>, <code>add_factor</code>, <code>register_residual</code>, <code>optimize</code>)
  over hidden magic, so that experiments remain easy to debug and extend.</li>
</ul>










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="world.model.ActiveWindowTemplate" class="doc doc-heading">
              <code class="highlight language-python"><span class="n">ActiveWindowTemplate</span><span class="p">(</span><span class="n">variable_slots</span><span class="p">,</span> <span class="n">factor_slots</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">



        <p>Defines a fixed-capacity active factor graph template for JIT-stable operation.
Each variable/factor slot is identified by (type, slot_idx).</p>











<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="world.model.FactorSlot" class="doc doc-heading">
              <code class="highlight language-python"><span class="n">FactorSlot</span><span class="p">(</span><span class="n">factor_type</span><span class="p">,</span> <span class="n">slot_idx</span><span class="p">,</span> <span class="n">factor_id</span><span class="p">,</span> <span class="n">var_slot_keys</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">



        <p>Bookkeeping for a factor slot in the active template.</p>











<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="world.model.VarSlot" class="doc doc-heading">
              <code class="highlight language-python"><span class="n">VarSlot</span><span class="p">(</span><span class="n">var_type</span><span class="p">,</span> <span class="n">slot_idx</span><span class="p">,</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">



        <p>Bookkeeping for a variable slot in the active template.</p>











<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="world.model.WorldModel" class="doc doc-heading">
              <code class="highlight language-python"><span class="n">WorldModel</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">



        <p>High-level world model built on top of :class:<code>FactorGraph</code>.</p>


<details class="modes" open>
  <summary>Modes</summary>
  <ul>
<li>Dynamic/unbounded FG (legacy, research mode): Variables and factors can be added/removed dynamically.</li>
<li>Fixed-capacity active template (real-time / JIT-stable mode): A fixed set of variable/factor slots is preallocated for JIT-compatibility and in-place updates.</li>
</ul>
</details>        <p>In addition to wrapping the core factor graph, this class keeps simple
bookkeeping dictionaries that make it easier to build static and dynamic
scene graphs on top of DSG-JIT. These maps are deliberately lightweight
and optional: if you never pass a name when adding variables, the
underlying optimization behavior is unchanged.</p>








                  <details class="mkdocstrings-source">
                    <summary>Source code in <code>dsg-jit/dsg_jit/world/model.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># Core factor graph</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fg</span> <span class="o">=</span> <span class="n">FactorGraph</span><span class="p">()</span>
    <span class="c1"># Semantic maps; these are purely for convenience and do not affect</span>
    <span class="c1"># the underlying optimization.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pose_ids</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">room_ids</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">place_ids</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">object_ids</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># Mapping: agent_id -&gt; {timestep -&gt; NodeId}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">agent_pose_ids</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># Residual Registry</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_residual_registry</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ResidualFn</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_compiled_solvers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># Active window template fields (for slot-based mode)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_active_template</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ActiveWindowTemplate</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_var_slots</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">VarSlot</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_factor_slots</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">FactorSlot</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_active_factor_mask</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">FactorId</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</code></pre></div></td></tr></table></div>
                  </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="world.model.WorldModel.add_agent_pose" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_agent_pose</span><span class="p">(</span><span class="n">agent_id</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">var_type</span><span class="o">=</span><span class="s1">&#39;pose&#39;</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Add (and register) a pose for a particular agent at a timestep.</p>
<p>This convenience helper is meant for dynamic scene graphs where you
track multiple agents over time. It simply delegates to
:meth:<code>add_variable</code> and then records the mapping <code>(agent_id, t)</code>.</p>
<p>:param agent_id: String identifier for the agent (e.g. <code>"robot_0"</code>).
:param t: Discrete timestep index.
:param value: Initial pose value for this agent at time <code>t</code>.
:param var_type: Underlying variable type to use (defaults to
    <code>"pose"</code>; you can change this to <code>"pose_se3"</code> in advanced
    use-cases).
:returns: The :class:<code>NodeId</code> of the new agent pose variable.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_agent_pose</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">t</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">value</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">var_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;pose&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NodeId</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add (and register) a pose for a particular agent at a timestep.</span>

<span class="sd">    This convenience helper is meant for dynamic scene graphs where you</span>
<span class="sd">    track multiple agents over time. It simply delegates to</span>
<span class="sd">    :meth:`add_variable` and then records the mapping ``(agent_id, t)``.</span>

<span class="sd">    :param agent_id: String identifier for the agent (e.g. ``&quot;robot_0&quot;``).</span>
<span class="sd">    :param t: Discrete timestep index.</span>
<span class="sd">    :param value: Initial pose value for this agent at time ``t``.</span>
<span class="sd">    :param var_type: Underlying variable type to use (defaults to</span>
<span class="sd">        ``&quot;pose&quot;``; you can change this to ``&quot;pose_se3&quot;`` in advanced</span>
<span class="sd">        use-cases).</span>
<span class="sd">    :returns: The :class:`NodeId` of the new agent pose variable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="n">var_type</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">agent_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_pose_ids</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent_pose_ids</span><span class="p">[</span><span class="n">agent_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">agent_pose_ids</span><span class="p">[</span><span class="n">agent_id</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">nid</span>
    <span class="k">return</span> <span class="n">nid</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.model.WorldModel.add_camera_bearings" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_camera_bearings</span><span class="p">(</span><span class="n">pose_id</span><span class="p">,</span> <span class="n">landmark_ids</span><span class="p">,</span> <span class="n">bearings</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">factor_type</span><span class="o">=</span><span class="s1">&#39;pose_landmark_bearing&#39;</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Add one or more camera bearing factors for a single pose.</p>
<p>This is a thin convenience wrapper for camera-like measurements that
observe known landmarks via bearing (direction) only. It assumes that
the underlying factor type is implemented by a residual such as
:func:<code>slam.measurements.pose_landmark_bearing_residual</code>.</p>
<p>Each row of :param:<code>bearings</code> is expected to correspond to one
landmark in :param:<code>landmark_ids</code>. The dimensionality (e.g. 2D angle
or 3D unit vector) is left to the residual function.</p>
<p>:param pose_id: Identifier of the pose variable from which all
    bearings are taken.
:param landmark_ids: List of landmark node identifiers, one per row
    in <code>bearings</code>.
:param bearings: Array of shape <code>(N, D)</code> containing bearing
    measurements in the sensor or camera frame.
:param weight: Optional scalar weight or inverse noise level applied
    uniformly to all bearings in this call. If <code>None</code>, the default
    inside the residual is used.
:param factor_type: Factor type string to register in the underlying
    :class:<code>FactorGraph</code>. Defaults to <code>"pose_landmark_bearing"</code>.
:returns: The :class:<code>FactorId</code> of the last factor added. One factor
    is added per (pose, landmark) pair.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_camera_bearings</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">pose_id</span><span class="p">:</span> <span class="n">NodeId</span><span class="p">,</span>
    <span class="n">landmark_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">NodeId</span><span class="p">],</span>
    <span class="n">bearings</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">weight</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">factor_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;pose_landmark_bearing&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FactorId</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add one or more camera bearing factors for a single pose.</span>

<span class="sd">    This is a thin convenience wrapper for camera-like measurements that</span>
<span class="sd">    observe known landmarks via bearing (direction) only. It assumes that</span>
<span class="sd">    the underlying factor type is implemented by a residual such as</span>
<span class="sd">    :func:`slam.measurements.pose_landmark_bearing_residual`.</span>

<span class="sd">    Each row of :param:`bearings` is expected to correspond to one</span>
<span class="sd">    landmark in :param:`landmark_ids`. The dimensionality (e.g. 2D angle</span>
<span class="sd">    or 3D unit vector) is left to the residual function.</span>

<span class="sd">    :param pose_id: Identifier of the pose variable from which all</span>
<span class="sd">        bearings are taken.</span>
<span class="sd">    :param landmark_ids: List of landmark node identifiers, one per row</span>
<span class="sd">        in ``bearings``.</span>
<span class="sd">    :param bearings: Array of shape ``(N, D)`` containing bearing</span>
<span class="sd">        measurements in the sensor or camera frame.</span>
<span class="sd">    :param weight: Optional scalar weight or inverse noise level applied</span>
<span class="sd">        uniformly to all bearings in this call. If ``None``, the default</span>
<span class="sd">        inside the residual is used.</span>
<span class="sd">    :param factor_type: Factor type string to register in the underlying</span>
<span class="sd">        :class:`FactorGraph`. Defaults to ``&quot;pose_landmark_bearing&quot;``.</span>
<span class="sd">    :returns: The :class:`FactorId` of the last factor added. One factor</span>
<span class="sd">        is added per (pose, landmark) pair.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">bearings</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">landmark_ids</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;add_camera_bearings expected len(landmark_ids) == bearings.shape[0], &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">landmark_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="n">bearings</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="n">last_fid</span><span class="p">:</span> <span class="n">FactorId</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">lm_id</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">landmark_ids</span><span class="p">,</span> <span class="n">bearings</span><span class="p">):</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;bearing&quot;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">b</span><span class="p">)}</span>
        <span class="k">if</span> <span class="n">weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>
        <span class="n">last_fid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_factor</span><span class="p">(</span><span class="n">factor_type</span><span class="p">,</span> <span class="p">[</span><span class="n">pose_id</span><span class="p">,</span> <span class="n">lm_id</span><span class="p">],</span> <span class="n">params</span><span class="p">)</span>

    <span class="c1"># mypy/linters: last_fid will never be None if bearings is non-empty.</span>
    <span class="k">if</span> <span class="n">last_fid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;add_camera_bearings called with empty bearings array.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">last_fid</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.model.WorldModel.add_factor" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_factor</span><span class="p">(</span><span class="n">f_type</span><span class="p">,</span> <span class="n">var_ids</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Add a new factor to the underlying factor graph.</p>
<p>This allocates a fresh :class:<code>FactorId</code>, normalizes the input
variable identifiers to :class:<code>NodeId</code> instances, constructs a
:class:<code>core.types.Factor</code>, and registers it in :attr:<code>fg</code>.</p>
<p>:param f_type: String identifying the factor type. This must match a
    key in :attr:<code>FactorGraph.residual_fns</code> so that the appropriate
    residual function can be looked up during optimization.
:param var_ids: Iterable of variable identifiers (ints or
    :class:<code>NodeId</code> instances) that this factor connects.
:param params: Dictionary of factor parameters passed through to the
    residual function (e.g. measurements, noise models, weights).
:returns: The :class:<code>FactorId</code> of the newly added factor.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">var_ids</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FactorId</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a new factor to the underlying factor graph.</span>

<span class="sd">    This allocates a fresh :class:`FactorId`, normalizes the input</span>
<span class="sd">    variable identifiers to :class:`NodeId` instances, constructs a</span>
<span class="sd">    :class:`core.types.Factor`, and registers it in :attr:`fg`.</span>

<span class="sd">    :param f_type: String identifying the factor type. This must match a</span>
<span class="sd">        key in :attr:`FactorGraph.residual_fns` so that the appropriate</span>
<span class="sd">        residual function can be looked up during optimization.</span>
<span class="sd">    :param var_ids: Iterable of variable identifiers (ints or</span>
<span class="sd">        :class:`NodeId` instances) that this factor connects.</span>
<span class="sd">    :param params: Dictionary of factor parameters passed through to the</span>
<span class="sd">        residual function (e.g. measurements, noise models, weights).</span>
<span class="sd">    :returns: The :class:`FactorId` of the newly added factor.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Allocate a fresh FactorId. We cannot rely on len(self.fg.factors)</span>
    <span class="c1"># when factors may have been removed (e.g. after marginalization),</span>
    <span class="c1"># so we take the maximum existing id and add one.</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fg</span><span class="o">.</span><span class="n">factors</span><span class="p">:</span>
        <span class="n">max_existing_id</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span> <span class="k">for</span> <span class="n">fid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fg</span><span class="o">.</span><span class="n">factors</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">fid_int</span> <span class="o">=</span> <span class="n">max_existing_id</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fid_int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">fid</span> <span class="o">=</span> <span class="n">FactorId</span><span class="p">(</span><span class="n">fid_int</span><span class="p">)</span>

    <span class="c1"># Normalize everything to NodeId</span>
    <span class="n">node_ids</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">NodeId</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">vid</span><span class="p">))</span> <span class="k">for</span> <span class="n">vid</span> <span class="ow">in</span> <span class="n">var_ids</span><span class="p">)</span>

    <span class="n">f</span> <span class="o">=</span> <span class="n">Factor</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="n">fid</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="n">f_type</span><span class="p">,</span>
        <span class="n">var_ids</span><span class="o">=</span><span class="n">node_ids</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fg</span><span class="o">.</span><span class="n">add_factor</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="c1"># Adding a factor changes the factor graph structure; clear cached</span>
    <span class="c1"># compiled solvers / residuals so they can be rebuilt consistently.</span>
    <span class="k">return</span> <span class="n">fid</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.model.WorldModel.add_imu_preintegration_factor" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_imu_preintegration_factor</span><span class="p">(</span><span class="n">pose_i</span><span class="p">,</span> <span class="n">pose_j</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">factor_type</span><span class="o">=</span><span class="s1">&#39;pose_imu_preintegration&#39;</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Add an IMU preintegration-style factor between two poses.</p>
<p>This is intended to work with a preintegrated IMU summary (e.g. as
produced by :mod:<code>sensors.imu</code>), where <code>delta</code> contains fields such
as <code>"dR"</code>, <code>"dv"</code>, <code>"dp"</code>, and corresponding covariance or
information terms.</p>
<p>The exact keys expected in <code>delta</code> are left to the residual
implementation for <code>factor_type</code>, but by storing the dictionary
unchanged in <code>params["delta"]</code> we keep this interface flexible.</p>
<p>:param pose_i: NodeId of the starting pose (time :math:<code>t_k</code>).
:param pose_j: NodeId of the ending pose (time :math:<code>t_{k+1}</code>).
:param delta: Dictionary describing the preintegrated IMU increment
    between <code>pose_i</code> and <code>pose_j</code>. All arrays should be JAX
    arrays or types convertible via :func:<code>jax.numpy.asarray</code>.
:param weight: Optional scalar weight / scaling to apply to the IMU
    factor inside the residual.
:param factor_type: Factor type string to register; by default this is
    <code>"pose_imu_preintegration"</code>.
:returns: The :class:<code>FactorId</code> of the created IMU factor.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_imu_preintegration_factor</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">pose_i</span><span class="p">:</span> <span class="n">NodeId</span><span class="p">,</span>
    <span class="n">pose_j</span><span class="p">:</span> <span class="n">NodeId</span><span class="p">,</span>
    <span class="n">delta</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
    <span class="n">weight</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">factor_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;pose_imu_preintegration&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FactorId</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add an IMU preintegration-style factor between two poses.</span>

<span class="sd">    This is intended to work with a preintegrated IMU summary (e.g. as</span>
<span class="sd">    produced by :mod:`sensors.imu`), where ``delta`` contains fields such</span>
<span class="sd">    as ``&quot;dR&quot;``, ``&quot;dv&quot;``, ``&quot;dp&quot;``, and corresponding covariance or</span>
<span class="sd">    information terms.</span>

<span class="sd">    The exact keys expected in ``delta`` are left to the residual</span>
<span class="sd">    implementation for ``factor_type``, but by storing the dictionary</span>
<span class="sd">    unchanged in ``params[&quot;delta&quot;]`` we keep this interface flexible.</span>

<span class="sd">    :param pose_i: NodeId of the starting pose (time :math:`t_k`).</span>
<span class="sd">    :param pose_j: NodeId of the ending pose (time :math:`t_{k+1}`).</span>
<span class="sd">    :param delta: Dictionary describing the preintegrated IMU increment</span>
<span class="sd">        between ``pose_i`` and ``pose_j``. All arrays should be JAX</span>
<span class="sd">        arrays or types convertible via :func:`jax.numpy.asarray`.</span>
<span class="sd">    :param weight: Optional scalar weight / scaling to apply to the IMU</span>
<span class="sd">        factor inside the residual.</span>
<span class="sd">    :param factor_type: Factor type string to register; by default this is</span>
<span class="sd">        ``&quot;pose_imu_preintegration&quot;``.</span>
<span class="sd">    :returns: The :class:`FactorId` of the created IMU factor.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">delta</span><span class="o">.</span><span class="n">items</span><span class="p">()}}</span>
    <span class="k">if</span> <span class="n">weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">params</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_factor</span><span class="p">(</span><span class="n">factor_type</span><span class="p">,</span> <span class="p">[</span><span class="n">pose_i</span><span class="p">,</span> <span class="n">pose_j</span><span class="p">],</span> <span class="n">params</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.model.WorldModel.add_lidar_ranges" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_lidar_ranges</span><span class="p">(</span><span class="n">pose_id</span><span class="p">,</span> <span class="n">landmark_ids</span><span class="p">,</span> <span class="n">ranges</span><span class="p">,</span> <span class="n">directions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">factor_type</span><span class="o">=</span><span class="s1">&#39;pose_lidar_range&#39;</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Add LiDAR-style range factors for a single pose.</p>
<p>This helper is intended for simple range-only or range-with-direction
measurements to known landmarks, coming from a LiDAR or depth sensor.</p>
<p>The interpretation of <code>directions</code> depends on the chosen residual
implementation, but a common convention is that each row is a unit
vector in the sensor frame pointing toward the target.</p>
<p>:param pose_id: Identifier of the pose variable from which ranges
    are measured.
:param landmark_ids: List of landmark node identifiers, one per range
    sample.
:param ranges: Array of shape <code>(N,)</code> holding range values in meters.
:param directions: Optional array of shape <code>(N, 3)</code> with unit
    direction vectors associated with each range measurement.
:param weight: Optional scalar weight applied to all range factors.
:param factor_type: Factor type string to register; by default this is
    <code>"pose_lidar_range"</code>. The residual function for this type is
    expected to consume <code>"range"</code> and optionally <code>"direction"</code> in
    <code>params</code>.
:returns: The :class:<code>FactorId</code> of the last factor added.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_lidar_ranges</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">pose_id</span><span class="p">:</span> <span class="n">NodeId</span><span class="p">,</span>
    <span class="n">landmark_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">NodeId</span><span class="p">],</span>
    <span class="n">ranges</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">directions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">weight</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">factor_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;pose_lidar_range&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FactorId</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add LiDAR-style range factors for a single pose.</span>

<span class="sd">    This helper is intended for simple range-only or range-with-direction</span>
<span class="sd">    measurements to known landmarks, coming from a LiDAR or depth sensor.</span>

<span class="sd">    The interpretation of ``directions`` depends on the chosen residual</span>
<span class="sd">    implementation, but a common convention is that each row is a unit</span>
<span class="sd">    vector in the sensor frame pointing toward the target.</span>

<span class="sd">    :param pose_id: Identifier of the pose variable from which ranges</span>
<span class="sd">        are measured.</span>
<span class="sd">    :param landmark_ids: List of landmark node identifiers, one per range</span>
<span class="sd">        sample.</span>
<span class="sd">    :param ranges: Array of shape ``(N,)`` holding range values in meters.</span>
<span class="sd">    :param directions: Optional array of shape ``(N, 3)`` with unit</span>
<span class="sd">        direction vectors associated with each range measurement.</span>
<span class="sd">    :param weight: Optional scalar weight applied to all range factors.</span>
<span class="sd">    :param factor_type: Factor type string to register; by default this is</span>
<span class="sd">        ``&quot;pose_lidar_range&quot;``. The residual function for this type is</span>
<span class="sd">        expected to consume ``&quot;range&quot;`` and optionally ``&quot;direction&quot;`` in</span>
<span class="sd">        ``params``.</span>
<span class="sd">    :returns: The :class:`FactorId` of the last factor added.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ranges</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">landmark_ids</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;add_lidar_ranges expected len(landmark_ids) == ranges.shape[0], &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">landmark_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="n">ranges</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">directions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">directions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ranges</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;add_lidar_ranges expected directions.shape[0] == ranges.shape[0], &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;got </span><span class="si">{</span><span class="n">directions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="n">ranges</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="n">last_fid</span><span class="p">:</span> <span class="n">FactorId</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lm_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">landmark_ids</span><span class="p">):</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;range&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">ranges</span><span class="p">[</span><span class="n">i</span><span class="p">])}</span>
        <span class="k">if</span> <span class="n">directions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;direction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">directions</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>
        <span class="n">last_fid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_factor</span><span class="p">(</span><span class="n">factor_type</span><span class="p">,</span> <span class="p">[</span><span class="n">pose_id</span><span class="p">,</span> <span class="n">lm_id</span><span class="p">],</span> <span class="n">params</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">last_fid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;add_lidar_ranges called with empty ranges array.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">last_fid</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.model.WorldModel.add_object" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_object</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Add an object centroid variable (3D point).</p>
<p>:param center: 3D position of the object centroid.
:param name: Optional semantic name to register in :attr:<code>object_ids</code>.
:returns: The :class:<code>NodeId</code> of the new object variable.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">center</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NodeId</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add an object centroid variable (3D point).</span>

<span class="sd">    :param center: 3D position of the object centroid.</span>
<span class="sd">    :param name: Optional semantic name to register in :attr:`object_ids`.</span>
<span class="sd">    :returns: The :class:`NodeId` of the new object variable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="n">center</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">object_ids</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">nid</span>
    <span class="k">return</span> <span class="n">nid</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.model.WorldModel.add_place" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_place</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Add a place / waypoint variable (3D point).</p>
<p>:param center: 3D position of the place/waypoint.
:param name: Optional semantic name to register in :attr:<code>place_ids</code>.
:returns: The :class:<code>NodeId</code> of the new place variable.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_place</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">center</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NodeId</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a place / waypoint variable (3D point).</span>

<span class="sd">    :param center: 3D position of the place/waypoint.</span>
<span class="sd">    :param name: Optional semantic name to register in :attr:`place_ids`.</span>
<span class="sd">    :returns: The :class:`NodeId` of the new place variable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;place&quot;</span><span class="p">,</span> <span class="n">center</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">place_ids</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">nid</span>
    <span class="k">return</span> <span class="n">nid</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.model.WorldModel.add_pose" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_pose</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Add an SE(3) pose variable.</p>
<p>This is a thin wrapper around :meth:<code>add_variable</code>. If <code>name</code> is
provided, the pose is also registered in :attr:<code>pose_ids</code>, which can
be useful for scene-graph style code that wants stable, human-readable
handles.</p>
<p>:param value: Initial pose value, typically a 6D se(3) vector.
:param name: Optional semantic name used as a key in :attr:<code>pose_ids</code>.
:returns: The :class:<code>NodeId</code> of the newly created pose variable.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_pose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NodeId</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add an SE(3) pose variable.</span>

<span class="sd">    This is a thin wrapper around :meth:`add_variable`. If ``name`` is</span>
<span class="sd">    provided, the pose is also registered in :attr:`pose_ids`, which can</span>
<span class="sd">    be useful for scene-graph style code that wants stable, human-readable</span>
<span class="sd">    handles.</span>

<span class="sd">    :param value: Initial pose value, typically a 6D se(3) vector.</span>
<span class="sd">    :param name: Optional semantic name used as a key in :attr:`pose_ids`.</span>
<span class="sd">    :returns: The :class:`NodeId` of the newly created pose variable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;pose&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pose_ids</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">nid</span>
    <span class="k">return</span> <span class="n">nid</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.model.WorldModel.add_room" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_room</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Add a room center variable (3D point).</p>
<p>:param center: 3D position of the room center.
:param name: Optional semantic name to register in :attr:<code>room_ids</code>.
:returns: The :class:<code>NodeId</code> of the new room variable.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_room</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">center</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NodeId</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a room center variable (3D point).</span>

<span class="sd">    :param center: 3D position of the room center.</span>
<span class="sd">    :param name: Optional semantic name to register in :attr:`room_ids`.</span>
<span class="sd">    :returns: The :class:`NodeId` of the new room variable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;room&quot;</span><span class="p">,</span> <span class="n">center</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">room_ids</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">nid</span>
    <span class="k">return</span> <span class="n">nid</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.model.WorldModel.add_variable" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_variable</span><span class="p">(</span><span class="n">var_type</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Add a new variable to the underlying factor graph.</p>
<p>This allocates a fresh :class:<code>NodeId</code>, constructs a
:class:<code>core.types.Variable</code> with the given type and initial value,
registers it in :attr:<code>fg</code>, and returns the newly created id.</p>
<p>:param var_type: String describing the variable type (e.g. <code>"pose"</code>,
    <code>"room"</code>, <code>"place"</code>, <code>"object"</code>). This is used by
    residual functions and manifold metadata to interpret the state.
:param value: Initial value for the variable, represented as a
    1D JAX array. The dimensionality is inferred from
    <code>value.shape[0]</code>.
:returns: The :class:<code>NodeId</code> of the newly added variable.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_variable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NodeId</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a new variable to the underlying factor graph.</span>

<span class="sd">    This allocates a fresh :class:`NodeId`, constructs a</span>
<span class="sd">    :class:`core.types.Variable` with the given type and initial value,</span>
<span class="sd">    registers it in :attr:`fg`, and returns the newly created id.</span>

<span class="sd">    :param var_type: String describing the variable type (e.g. ``&quot;pose&quot;``,</span>
<span class="sd">        ``&quot;room&quot;``, ``&quot;place&quot;``, ``&quot;object&quot;``). This is used by</span>
<span class="sd">        residual functions and manifold metadata to interpret the state.</span>
<span class="sd">    :param value: Initial value for the variable, represented as a</span>
<span class="sd">        1D JAX array. The dimensionality is inferred from</span>
<span class="sd">        ``value.shape[0]``.</span>
<span class="sd">    :returns: The :class:`NodeId` of the newly added variable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Allocate a fresh NodeId. We cannot rely on len(self.fg.variables)</span>
    <span class="c1"># when variables may have been removed (e.g. after marginalization),</span>
    <span class="c1"># so we take the maximum existing id and add one.</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fg</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
        <span class="n">max_existing_id</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">nid</span><span class="p">)</span> <span class="k">for</span> <span class="n">nid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fg</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">nid_int</span> <span class="o">=</span> <span class="n">max_existing_id</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nid_int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">nid</span> <span class="o">=</span> <span class="n">NodeId</span><span class="p">(</span><span class="n">nid_int</span><span class="p">)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">nid</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">var_type</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fg</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="c1"># Graph structure has changed; clear any cached compiled solvers</span>
    <span class="c1"># and residuals so they can be rebuilt on demand.</span>
    <span class="k">return</span> <span class="n">nid</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.model.WorldModel.build_objective" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">build_objective</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Construct a scalar objective <code>f(x) = ||r(x)||^2</code>.</p>
<p>This wraps :meth:<code>build_residual</code> and returns a function
that computes the squared L2 norm of the residual vector.</p>
<p>:return: JIT-compiled objective function <code>f(x)</code>.
:rtype: Callable[[jnp.ndarray], jnp.ndarray]</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_objective</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Construct a scalar objective ``f(x) = ||r(x)||^2``.</span>

<span class="sd">    This wraps :meth:`build_residual` and returns a function</span>
<span class="sd">    that computes the squared L2 norm of the residual vector.</span>

<span class="sd">    :return: JIT-compiled objective function ``f(x)``.</span>
<span class="sd">    :rtype: Callable[[jnp.ndarray], jnp.ndarray]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">residual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_residual</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">objective</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">residual</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">r</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">objective</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.model.WorldModel.build_residual" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">build_residual</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">use_type_weights</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">learn_odom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">learn_voxel_points</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Construct a unified residual function for the current world.</p>
<p>This method is the WorldModel-level entry point for building a
JAX-compatible residual function that stacks all factor residuals.
It is intended to subsume the various specialized builders that
previously lived on :class:<code>FactorGraph</code>, such as:</p>
<ul>
<li><code>build_residual_function_with_type_weights</code></li>
<li><code>build_residual_function_se3_odom_param_multi</code></li>
<li><code>build_residual_function_voxel_point_param[_multi]</code></li>
</ul>
<p>Instead of having separate entry points, this method exposes a
single interface whose behavior is controlled by configuration
flags and a structured "hyper-parameter" argument passed at call
time.</p>
<h5 id="world.model.WorldModel.build_residual--parameters">Parameters</h5>
<p>use_type_weights : bool, optional
    Currently unused in this implementation. Reserved for future
    integration with type-weighted residuals.
learn_odom : bool, optional
    Currently unused in this implementation. Reserved for future
    integration with learnable odometry parameters.
learn_voxel_points : bool, optional
    Currently unused in this implementation. Reserved for future
    integration with learnable voxel observation points.</p>
<h5 id="world.model.WorldModel.build_residual--returns">Returns</h5>
<p>callable
    A JAX-compatible residual function. In the simplest case
    (all flags <code>False</code>) the signature is <code>r(x)</code> where <code>x</code> is
    a packed state vector.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_residual</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">use_type_weights</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">learn_odom</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">learn_voxel_points</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Construct a unified residual function for the current world.</span>

<span class="sd">    This method is the WorldModel-level entry point for building a</span>
<span class="sd">    JAX-compatible residual function that stacks all factor residuals.</span>
<span class="sd">    It is intended to subsume the various specialized builders that</span>
<span class="sd">    previously lived on :class:`FactorGraph`, such as:</span>

<span class="sd">    * ``build_residual_function_with_type_weights``</span>
<span class="sd">    * ``build_residual_function_se3_odom_param_multi``</span>
<span class="sd">    * ``build_residual_function_voxel_point_param[_multi]``</span>

<span class="sd">    Instead of having separate entry points, this method exposes a</span>
<span class="sd">    single interface whose behavior is controlled by configuration</span>
<span class="sd">    flags and a structured &quot;hyper-parameter&quot; argument passed at call</span>
<span class="sd">    time.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    use_type_weights : bool, optional</span>
<span class="sd">        Currently unused in this implementation. Reserved for future</span>
<span class="sd">        integration with type-weighted residuals.</span>
<span class="sd">    learn_odom : bool, optional</span>
<span class="sd">        Currently unused in this implementation. Reserved for future</span>
<span class="sd">        integration with learnable odometry parameters.</span>
<span class="sd">    learn_voxel_points : bool, optional</span>
<span class="sd">        Currently unused in this implementation. Reserved for future</span>
<span class="sd">        integration with learnable voxel observation points.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    callable</span>
<span class="sd">        A JAX-compatible residual function. In the simplest case</span>
<span class="sd">        (all flags ``False``) the signature is ``r(x)`` where ``x`` is</span>
<span class="sd">        a packed state vector.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># NOTE: For now, the configuration flags are accepted but not yet</span>
    <span class="c1"># wired into the implementation. They are kept in the signature to</span>
    <span class="c1"># preserve the planned API surface and avoid breaking callers.</span>
    <span class="k">if</span> <span class="n">use_type_weights</span> <span class="ow">or</span> <span class="n">learn_odom</span> <span class="ow">or</span> <span class="n">learn_voxel_points</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;Hyper-parameterized residuals are provided by dedicated &quot;</span>
            <span class="s2">&quot;WorldModel helper methods (e.g. &quot;</span>
            <span class="s2">&quot;build_residual_function_with_type_weights, &quot;</span>
            <span class="s2">&quot;build_residual_function_se3_odom_param_multi). &quot;</span>
            <span class="s2">&quot;The generic build_residual hyper-parameter flags are not &quot;</span>
            <span class="s2">&quot;yet implemented.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Slot-based mode: Use a constant cache key and enforce fixed structure.</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_template</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cache_key</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;residual&quot;</span><span class="p">,</span> <span class="s2">&quot;active_template&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Legacy dynamic mode: cache by structure.</span>
        <span class="n">factors</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fg</span><span class="o">.</span><span class="n">factors</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">var_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fg</span><span class="o">.</span><span class="n">variables</span><span class="p">)</span>
        <span class="n">sig_parts</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">var_ids</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">factors</span><span class="p">]</span>
        <span class="n">structure_sig</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;v</span><span class="si">{</span><span class="n">var_count</span><span class="si">}</span><span class="s2">|&quot;</span> <span class="o">+</span> <span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sig_parts</span><span class="p">)</span>
        <span class="n">cache_key</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;residual&quot;</span><span class="p">,</span> <span class="n">structure_sig</span><span class="p">)</span>

    <span class="n">cached</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compiled_solvers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cached</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cached</span>

    <span class="c1"># Group factors as before.</span>
    <span class="n">factors</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fg</span><span class="o">.</span><span class="n">factors</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="n">group_to_factors</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]],</span> <span class="n">List</span><span class="p">[</span><span class="n">Factor</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">factors</span><span class="p">:</span>
        <span class="n">var_dims</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">nid</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">var_ids</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fg</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
            <span class="n">var_dims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">shape_sig</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">var_dims</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">shape_sig</span><span class="p">)</span>
        <span class="n">group_to_factors</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="n">residual_fns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_residual_registry</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pack_state</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">residual</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stacked residual function over all factors for the current graph, with slot-based activity mask if present.&quot;&quot;&quot;</span>
        <span class="n">var_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unpack_state</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
        <span class="n">res_chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">f_type</span><span class="p">,</span> <span class="n">_shape_sig</span><span class="p">),</span> <span class="n">flist</span> <span class="ow">in</span> <span class="n">group_to_factors</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">res_fn</span> <span class="o">=</span> <span class="n">residual_fns</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">f_type</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">res_fn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No residual fn registered for factor type &#39;</span><span class="si">{</span><span class="n">f_type</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">flist</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># Singleton group</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">flist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">flist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">vs</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_values</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="k">for</span> <span class="n">nid</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">var_ids</span><span class="p">]</span>
                <span class="n">stacked</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">vs</span><span class="p">)</span>
                <span class="c1"># Slot-based: multiply by &quot;active&quot; param if present</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">res_fn</span><span class="p">(</span><span class="n">stacked</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
                <span class="n">activity</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;active&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">r</span> <span class="o">*</span> <span class="n">activity</span>
                <span class="n">res_chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,)))</span>
                <span class="k">continue</span>
            <span class="c1"># Batched path</span>
            <span class="n">stacked_states</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">params_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">flist</span><span class="p">:</span>
                <span class="n">vs</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_values</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="k">for</span> <span class="n">nid</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">var_ids</span><span class="p">]</span>
                <span class="n">stacked_states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">vs</span><span class="p">))</span>
                <span class="n">params_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
            <span class="n">stacked_states_arr</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">stacked_states</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">params_tree</span> <span class="o">=</span> <span class="n">jtu</span><span class="o">.</span><span class="n">tree_map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="o">*</span><span class="n">vals</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
                <span class="p">),</span>
                <span class="o">*</span><span class="n">params_list</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">single_factor_residual</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">res_fn</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
                <span class="n">activity</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;active&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">r</span> <span class="o">*</span> <span class="n">activity</span>
            <span class="n">batched_res</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="n">single_factor_residual</span><span class="p">)(</span>
                <span class="n">stacked_states_arr</span><span class="p">,</span> <span class="n">params_tree</span>
            <span class="p">)</span>
            <span class="n">res_chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batched_res</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,)))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">res_chunks</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">res_chunks</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">residual_jit</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">residual</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_compiled_solvers</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">residual_jit</span>
    <span class="k">return</span> <span class="n">residual_jit</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.model.WorldModel.build_residual_function_se3_odom_param_multi" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">build_residual_function_se3_odom_param_multi</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Build a residual function with learnable SE(3) odometry.</p>
<p>All factors of type <code>"odom_se3"</code> are treated as depending on a
parameter array <code>theta</code> of shape <code>(K, 6)</code>, where <code>K</code> is the
number of odometry factors. Each row of <code>theta</code> represents a
perturbable se(3) measurement.</p>
<h5 id="world.model.WorldModel.build_residual_function_se3_odom_param_multi--returns">Returns</h5>
<p>(residual_fn, index)
    <code>residual_fn(x, theta)</code> and the pack index mapping from
    :meth:<code>pack_state</code>.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_residual_function_se3_odom_param_multi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build a residual function with learnable SE(3) odometry.</span>

<span class="sd">    All factors of type ``\&quot;odom_se3\&quot;`` are treated as depending on a</span>
<span class="sd">    parameter array ``theta`` of shape ``(K, 6)``, where ``K`` is the</span>
<span class="sd">    number of odometry factors. Each row of ``theta`` represents a</span>
<span class="sd">    perturbable se(3) measurement.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    (residual_fn, index)</span>
<span class="sd">        ``residual_fn(x, theta)`` and the pack index mapping from</span>
<span class="sd">        :meth:`pack_state`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">factors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fg</span><span class="o">.</span><span class="n">factors</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="n">residual_fns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_residual_registry</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pack_state</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">residual</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">theta</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : jnp.ndarray</span>
<span class="sd">            Flat state vector.</span>
<span class="sd">        theta : jnp.ndarray</span>
<span class="sd">            Shape (K, 6), per-odom se(3) measurement.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">var_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unpack_state</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
        <span class="n">res_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">odom_idx</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">factors</span><span class="p">:</span>
            <span class="n">res_fn</span> <span class="o">=</span> <span class="n">residual_fns</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">res_fn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No residual fn registered for factor type &#39;</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                <span class="p">)</span>

            <span class="n">stacked</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">var_values</span><span class="p">[</span><span class="n">vid</span><span class="p">]</span> <span class="k">for</span> <span class="n">vid</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">var_ids</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;odom_se3&quot;</span><span class="p">:</span>
                <span class="n">meas</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[</span><span class="n">odom_idx</span><span class="p">]</span>  <span class="c1"># (6,)</span>
                <span class="n">odom_idx</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">base_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
                <span class="n">base_params</span><span class="p">[</span><span class="s2">&quot;measurement&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">meas</span>
                <span class="n">params</span> <span class="o">=</span> <span class="n">base_params</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">params</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">params</span>

            <span class="n">r</span> <span class="o">=</span> <span class="n">res_fn</span><span class="p">(</span><span class="n">stacked</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;weight&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="n">res_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">*</span> <span class="n">r</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">res_list</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">res_list</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">residual</span><span class="p">,</span> <span class="n">index</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.model.WorldModel.build_residual_function_voxel_point_param" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">build_residual_function_voxel_point_param</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Build a residual function with a shared voxel observation point.</p>
<p>All factors of type <code>"voxel_point_obs"</code> will use a dynamic
<code>point_world</code> argument passed at call time, rather than a fixed
value stored in the factor params.</p>
<h5 id="world.model.WorldModel.build_residual_function_voxel_point_param--returns">Returns</h5>
<p>(residual_fn, index)
    <code>residual_fn(x, point_world)</code> where <code>point_world</code> has
    shape (3,).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_residual_function_voxel_point_param</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build a residual function with a shared voxel observation point.</span>

<span class="sd">    All factors of type ``\&quot;voxel_point_obs\&quot;`` will use a dynamic</span>
<span class="sd">    ``point_world`` argument passed at call time, rather than a fixed</span>
<span class="sd">    value stored in the factor params.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    (residual_fn, index)</span>
<span class="sd">        ``residual_fn(x, point_world)`` where ``point_world`` has</span>
<span class="sd">        shape (3,).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">factors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fg</span><span class="o">.</span><span class="n">factors</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="n">residual_fns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_residual_registry</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pack_state</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">residual</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">point_world</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : jnp.ndarray</span>
<span class="sd">            Flat state vector.</span>
<span class="sd">        point_world : jnp.ndarray</span>
<span class="sd">            Shape (3,), observation point in world coords for ALL</span>
<span class="sd">            voxel_point_obs factors. For now we assume a single</span>
<span class="sd">            voxel_point_obs, or that all share the same point.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">var_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unpack_state</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
        <span class="n">res_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">factors</span><span class="p">:</span>
            <span class="n">res_fn</span> <span class="o">=</span> <span class="n">residual_fns</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">res_fn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No residual fn registered for factor type &#39;</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                <span class="p">)</span>

            <span class="n">stacked</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">var_values</span><span class="p">[</span><span class="n">vid</span><span class="p">]</span> <span class="k">for</span> <span class="n">vid</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">var_ids</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;voxel_point_obs&quot;</span><span class="p">:</span>
                <span class="n">base_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
                <span class="n">base_params</span><span class="p">[</span><span class="s2">&quot;point_world&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">point_world</span>
                <span class="n">params</span> <span class="o">=</span> <span class="n">base_params</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">params</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">params</span>

            <span class="n">r</span> <span class="o">=</span> <span class="n">res_fn</span><span class="p">(</span><span class="n">stacked</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;weight&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="n">res_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">*</span> <span class="n">r</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">res_list</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">res_list</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">residual</span><span class="p">,</span> <span class="n">index</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.model.WorldModel.build_residual_function_voxel_point_param_multi" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">build_residual_function_voxel_point_param_multi</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Build a residual function with per-factor voxel observation points.</p>
<p>Each <code>"voxel_point_obs"</code> factor consumes a row of the parameter
array <code>theta</code> of shape <code>(K, 3)</code>, where <code>K</code> is the number of
such factors.</p>
<h5 id="world.model.WorldModel.build_residual_function_voxel_point_param_multi--returns">Returns</h5>
<p>(residual_fn, index)
    <code>residual_fn(x, theta)</code> where <code>theta</code> has shape (K, 3).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_residual_function_voxel_point_param_multi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build a residual function with per-factor voxel observation points.</span>

<span class="sd">    Each ``\&quot;voxel_point_obs\&quot;`` factor consumes a row of the parameter</span>
<span class="sd">    array ``theta`` of shape ``(K, 3)``, where ``K`` is the number of</span>
<span class="sd">    such factors.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    (residual_fn, index)</span>
<span class="sd">        ``residual_fn(x, theta)`` where ``theta`` has shape (K, 3).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">factors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fg</span><span class="o">.</span><span class="n">factors</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="n">residual_fns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_residual_registry</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pack_state</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">residual</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">theta</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : jnp.ndarray</span>
<span class="sd">            Flat state vector.</span>
<span class="sd">        theta : jnp.ndarray</span>
<span class="sd">            Shape (K, 3), per-voxel-point observation in world</span>
<span class="sd">            coordinates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">var_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unpack_state</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
        <span class="n">res_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">obs_idx</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># python counter over voxel_point_obs factors</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">factors</span><span class="p">:</span>
            <span class="n">res_fn</span> <span class="o">=</span> <span class="n">residual_fns</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">res_fn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No residual fn registered for factor type &#39;</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                <span class="p">)</span>

            <span class="n">stacked</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">var_values</span><span class="p">[</span><span class="n">vid</span><span class="p">]</span> <span class="k">for</span> <span class="n">vid</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">var_ids</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;voxel_point_obs&quot;</span><span class="p">:</span>
                <span class="n">point_world</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[</span><span class="n">obs_idx</span><span class="p">]</span>  <span class="c1"># (3,)</span>
                <span class="n">obs_idx</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">base_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
                <span class="n">base_params</span><span class="p">[</span><span class="s2">&quot;point_world&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">point_world</span>
                <span class="n">params</span> <span class="o">=</span> <span class="n">base_params</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">params</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">params</span>

            <span class="n">r</span> <span class="o">=</span> <span class="n">res_fn</span><span class="p">(</span><span class="n">stacked</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;weight&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="n">res_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">*</span> <span class="n">r</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">res_list</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">res_list</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">residual</span><span class="p">,</span> <span class="n">index</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.model.WorldModel.build_residual_function_with_type_weights" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">build_residual_function_with_type_weights</span><span class="p">(</span><span class="n">factor_type_order</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Build a residual function that supports learnable type weights.</p>
<p>The returned function has signature <code>r(x, log_scales)</code> where
<code>log_scales[i]</code> is the log-weight associated with
<code>factor_type_order[i]</code>. Missing types default to unit weight.</p>
<p>This is a WorldModel-based version of the old FactorGraph helper,
implemented in terms of <code>pack_state</code>, <code>unpack_state</code>, and the
WorldModel residual registry.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span>
<span class="normal">955</span>
<span class="normal">956</span>
<span class="normal">957</span>
<span class="normal">958</span>
<span class="normal">959</span>
<span class="normal">960</span>
<span class="normal">961</span>
<span class="normal">962</span>
<span class="normal">963</span>
<span class="normal">964</span>
<span class="normal">965</span>
<span class="normal">966</span>
<span class="normal">967</span>
<span class="normal">968</span>
<span class="normal">969</span>
<span class="normal">970</span>
<span class="normal">971</span>
<span class="normal">972</span>
<span class="normal">973</span>
<span class="normal">974</span>
<span class="normal">975</span>
<span class="normal">976</span>
<span class="normal">977</span>
<span class="normal">978</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_residual_function_with_type_weights</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">factor_type_order</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build a residual function that supports learnable type weights.</span>

<span class="sd">    The returned function has signature ``r(x, log_scales)`` where</span>
<span class="sd">    ``log_scales[i]`` is the log-weight associated with</span>
<span class="sd">    ``factor_type_order[i]``. Missing types default to unit weight.</span>

<span class="sd">    This is a WorldModel-based version of the old FactorGraph helper,</span>
<span class="sd">    implemented in terms of ``pack_state``, ``unpack_state``, and the</span>
<span class="sd">    WorldModel residual registry.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">factors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fg</span><span class="o">.</span><span class="n">factors</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="n">residual_fns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_residual_registry</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pack_state</span><span class="p">()</span>

    <span class="n">type_to_idx</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">factor_type_order</span><span class="p">)}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">residual</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">log_scales</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="n">var_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unpack_state</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
        <span class="n">res_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">factor</span> <span class="ow">in</span> <span class="n">factors</span><span class="p">:</span>
            <span class="n">res_fn</span> <span class="o">=</span> <span class="n">residual_fns</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">factor</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">res_fn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No residual fn registered for factor type &#39;</span><span class="si">{</span><span class="n">factor</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                <span class="p">)</span>

            <span class="n">stacked</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                <span class="p">[</span><span class="n">var_values</span><span class="p">[</span><span class="n">vid</span><span class="p">]</span> <span class="k">for</span> <span class="n">vid</span> <span class="ow">in</span> <span class="n">factor</span><span class="o">.</span><span class="n">var_ids</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
            <span class="p">)</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">res_fn</span><span class="p">(</span><span class="n">stacked</span><span class="p">,</span> <span class="n">factor</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>  <span class="c1"># (k,)</span>

            <span class="n">idx</span> <span class="o">=</span> <span class="n">type_to_idx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">factor</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">scale</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_scales</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">scale</span> <span class="o">=</span> <span class="mf">1.0</span>

            <span class="n">r_scaled</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="n">r</span>
            <span class="n">r_scaled</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">r_scaled</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,))</span>
            <span class="n">res_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r_scaled</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">res_list</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">res_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">residual</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.model.WorldModel.configure_factor_slot" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">configure_factor_slot</span><span class="p">(</span><span class="n">factor_type</span><span class="p">,</span> <span class="n">slot_idx</span><span class="p">,</span> <span class="n">var_ids</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Configure a factor slot in the active template: set variable ids, params, and activity.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">configure_factor_slot</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">factor_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">slot_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">var_ids</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">NodeId</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
    <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
    <span class="n">active</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Configure a factor slot in the active template: set variable ids, params, and activity.&quot;&quot;&quot;</span>
    <span class="n">slot_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">factor_type</span><span class="p">,</span> <span class="n">slot_idx</span><span class="p">)</span>
    <span class="n">slot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_factor_slots</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">slot_key</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">slot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Factor slot </span><span class="si">{</span><span class="n">slot_key</span><span class="si">}</span><span class="s2"> not found in active template.&quot;</span><span class="p">)</span>
    <span class="n">fid</span> <span class="o">=</span> <span class="n">slot</span><span class="o">.</span><span class="n">factor_id</span>
    <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fg</span><span class="o">.</span><span class="n">factors</span><span class="p">[</span><span class="n">fid</span><span class="p">]</span>
    <span class="c1"># Update factor&#39;s var_ids and params in place.</span>
    <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;var_ids&quot;</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">var_ids</span><span class="p">))</span>

    <span class="c1"># IMPORTANT: preserve existing keys so vmapped stacking sees a</span>
    <span class="c1"># consistent pytree structure across all factors in a batched group.</span>
    <span class="n">new_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
    <span class="n">new_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="c1"># Normalize scalar params to JAX arrays for stable stacking.</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">new_params</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
            <span class="n">new_params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">new_params</span><span class="p">[</span><span class="s2">&quot;active&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">1.0</span> <span class="k">if</span> <span class="n">active</span> <span class="k">else</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">new_params</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_active_factor_mask</span><span class="p">[</span><span class="n">fid</span><span class="p">]</span> <span class="o">=</span> <span class="n">active</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.model.WorldModel.fixed_lag_marginalize" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">fixed_lag_marginalize</span><span class="p">(</span><span class="n">keep_ids</span><span class="p">,</span> <span class="n">damping</span><span class="o">=</span><span class="mf">1e-06</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Disabled: Fixed-lag marginalization is not supported in active template mode.
Use bounded active templates for sliding window/fixed-lag smoothing instead.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">fixed_lag_marginalize</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">keep_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">NodeId</span><span class="p">],</span>
    <span class="n">damping</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-6</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Disabled: Fixed-lag marginalization is not supported in active template mode.</span>
<span class="sd">    Use bounded active templates for sliding window/fixed-lag smoothing instead.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_template</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Fixed-lag smoothing is handled via bounded active templates.</span>
        <span class="c1"># This method is disabled in slot-based mode.</span>
        <span class="k">return</span>
    <span class="c1"># (Legacy code for dynamic mode could be restored here if needed.)</span>
    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.model.WorldModel.get_residual" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_residual</span><span class="p">(</span><span class="n">factor_type</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Return the residual function registered for a given factor type.</p>
<h5 id="world.model.WorldModel.get_residual--parameters">Parameters</h5>
<p>factor_type : str
    String identifier for the factor type.</p>
<h5 id="world.model.WorldModel.get_residual--returns">Returns</h5>
<p>callable or None
    The residual function previously registered via
    :meth:<code>register_residual</code>, or <code>None</code> if no function is
    registered for the requested type.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_residual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factor_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the residual function registered for a given factor type.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    factor_type : str</span>
<span class="sd">        String identifier for the factor type.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    callable or None</span>
<span class="sd">        The residual function previously registered via</span>
<span class="sd">        :meth:`register_residual`, or ``None`` if no function is</span>
<span class="sd">        registered for the requested type.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_residual_registry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">factor_type</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.model.WorldModel.get_residuals" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_residuals</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Returns the residual registry, all currently registered residuals.</p>
<p>:return: Dict[str, ResidualFn]</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_residuals</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ResidualFn</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the residual registry, all currently registered residuals.</span>

<span class="sd">    :return: Dict[str, ResidualFn]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_residual_registry</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.model.WorldModel.get_variable_value" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_variable_value</span><span class="p">(</span><span class="n">nid</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Return the current value of a variable.</p>
<p>This is a thin convenience wrapper over the underlying
:class:<code>FactorGraph</code> variable storage and is useful when building
dynamic scene graphs that want to query individual nodes.</p>
<p>:param nid: Identifier of the variable.
:returns: A JAX array holding the variable's current value.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_variable_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nid</span><span class="p">:</span> <span class="n">NodeId</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the current value of a variable.</span>

<span class="sd">    This is a thin convenience wrapper over the underlying</span>
<span class="sd">    :class:`FactorGraph` variable storage and is useful when building</span>
<span class="sd">    dynamic scene graphs that want to query individual nodes.</span>

<span class="sd">    :param nid: Identifier of the variable.</span>
<span class="sd">    :returns: A JAX array holding the variable&#39;s current value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fg</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.model.WorldModel.init_active_template" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">init_active_template</span><span class="p">(</span><span class="n">template</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Initialize a fixed-capacity active factor graph template for JIT-stable operation.
All variables and factors are preallocated; structure is fixed.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">init_active_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="p">:</span> <span class="n">ActiveWindowTemplate</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize a fixed-capacity active factor graph template for JIT-stable operation.</span>
<span class="sd">    All variables and factors are preallocated; structure is fixed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Reset the factor graph and slot bookkeeping.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fg</span> <span class="o">=</span> <span class="n">FactorGraph</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_active_template</span> <span class="o">=</span> <span class="n">template</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_var_slots</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_factor_slots</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_active_factor_mask</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="c1"># Pre-allocate variable slots.</span>
    <span class="k">for</span> <span class="n">var_type</span><span class="p">,</span> <span class="n">slot_idx</span><span class="p">,</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">template</span><span class="o">.</span><span class="n">variable_slots</span><span class="p">:</span>
        <span class="n">init_val</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dim</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">node_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="n">var_type</span><span class="p">,</span> <span class="n">init_val</span><span class="p">)</span>
        <span class="n">slot_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">var_type</span><span class="p">,</span> <span class="n">slot_idx</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_var_slots</span><span class="p">[</span><span class="n">slot_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">VarSlot</span><span class="p">(</span><span class="n">var_type</span><span class="p">,</span> <span class="n">slot_idx</span><span class="p">,</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>
    <span class="c1"># Pre-allocate factor slots (inactive by default).</span>
    <span class="k">for</span> <span class="n">factor_type</span><span class="p">,</span> <span class="n">slot_idx</span><span class="p">,</span> <span class="n">var_slot_keys</span> <span class="ow">in</span> <span class="n">template</span><span class="o">.</span><span class="n">factor_slots</span><span class="p">:</span>
        <span class="n">var_ids</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_var_slots</span><span class="p">[</span><span class="n">vk</span><span class="p">]</span><span class="o">.</span><span class="n">node_id</span> <span class="k">for</span> <span class="n">vk</span> <span class="ow">in</span> <span class="n">var_slot_keys</span><span class="p">)</span>

        <span class="c1"># Compute the stacked state dimension for this factor slot.</span>
        <span class="n">stacked_dim</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">vk</span> <span class="ow">in</span> <span class="n">var_slot_keys</span><span class="p">:</span>
            <span class="n">stacked_dim</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_var_slots</span><span class="p">[</span><span class="n">vk</span><span class="p">]</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>

        <span class="c1"># IMPORTANT: In slot-based mode we rely on vmap + tree stacking.</span>
        <span class="c1"># That requires that all factors within a batched group have the</span>
        <span class="c1"># same params keys and compatible shapes.</span>
        <span class="k">if</span> <span class="n">factor_type</span> <span class="o">==</span> <span class="s2">&quot;prior&quot;</span><span class="p">:</span>
            <span class="c1"># Prior residual typically expects a 6D target for SE(3) poses.</span>
            <span class="c1"># We default to zeros and unit weight.</span>
            <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">stacked_dim</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                <span class="s2">&quot;active&quot;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="k">elif</span> <span class="n">factor_type</span> <span class="o">==</span> <span class="s2">&quot;odom_se3&quot;</span><span class="p">:</span>
            <span class="c1"># Odometry measurement lives in the se(3) tangent space (6D),</span>
            <span class="c1"># even though the stacked state for two poses is 12D.</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;measurement&quot;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">6</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                <span class="s2">&quot;active&quot;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="k">elif</span> <span class="n">factor_type</span> <span class="o">==</span> <span class="s2">&quot;marginal_prior&quot;</span><span class="p">:</span>
            <span class="c1"># Dense Gaussian prior induced by marginalization.</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">stacked_dim</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                <span class="s2">&quot;sqrt_info&quot;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">stacked_dim</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                <span class="s2">&quot;active&quot;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Generic fallback: only active + weight.</span>
            <span class="c1"># Callers can override/extend keys via configure_factor_slot.</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                <span class="s2">&quot;active&quot;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="p">}</span>

        <span class="n">factor_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_factor</span><span class="p">(</span><span class="n">factor_type</span><span class="p">,</span> <span class="n">var_ids</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
        <span class="n">slot_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">factor_type</span><span class="p">,</span> <span class="n">slot_idx</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_factor_slots</span><span class="p">[</span><span class="n">slot_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">FactorSlot</span><span class="p">(</span><span class="n">factor_type</span><span class="p">,</span> <span class="n">slot_idx</span><span class="p">,</span> <span class="n">factor_id</span><span class="p">,</span> <span class="n">var_slot_keys</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_active_factor_mask</span><span class="p">[</span><span class="n">factor_id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.model.WorldModel.list_residual_types" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">list_residual_types</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>List all factor types with registered residual functions.</p>
<p>This is a convenience helper for debugging, diagnostics, and tests
to verify that the WorldModel has been configured with the expected
residuals for the current application.</p>
<h5 id="world.model.WorldModel.list_residual_types--returns">Returns</h5>
<p>list of str
    Sorted list of factor type strings for which residuals have
    been registered.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">list_residual_types</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;List all factor types with registered residual functions.</span>

<span class="sd">    This is a convenience helper for debugging, diagnostics, and tests</span>
<span class="sd">    to verify that the WorldModel has been configured with the expected</span>
<span class="sd">    residuals for the current application.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of str</span>
<span class="sd">        Sorted list of factor type strings for which residuals have</span>
<span class="sd">        been registered.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_residual_registry</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.model.WorldModel.marginalize_variables" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">marginalize_variables</span><span class="p">(</span><span class="n">marginalized_ids</span><span class="p">,</span> <span class="n">damping</span><span class="o">=</span><span class="mf">1e-06</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Disabled: Marginalization is not supported in active template mode.
Use bounded active templates for fixed-lag smoothing instead.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">marginalize_variables</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">marginalized_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">NodeId</span><span class="p">],</span>
    <span class="n">damping</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-6</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Disabled: Marginalization is not supported in active template mode.</span>
<span class="sd">    Use bounded active templates for fixed-lag smoothing instead.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If in active template mode, do nothing and explain.</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_template</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Fixed-lag smoothing is handled via bounded active templates.</span>
        <span class="c1"># This method is disabled in slot-based mode.</span>
        <span class="k">return</span>
    <span class="c1"># (Legacy code for dynamic mode could be restored here if needed.)</span>
    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.model.WorldModel.optimize" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">optimize</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">iters</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;gd&#39;</span><span class="p">,</span> <span class="n">damping</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">max_step_norm</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Run a local optimizer on the current world state.</p>
<p>This method packs the current variables into a flat state vector,
constructs an appropriate objective or residual function, runs one
of the supported optimizers, and writes the optimized state back
into :attr:<code>fg.variables</code>.</p>
<p>Supported methods:</p>
<ul>
<li><code>"gd"</code>: vanilla gradient descent on the scalar objective
  :math:<code>\|r(x)\|^2</code>.</li>
<li><code>"newton"</code>: damped Newton on the same scalar objective.</li>
<li><code>"gn"</code>: Gauss--Newton on the stacked residual vector assuming
  Euclidean variables.</li>
<li><code>"manifold_gn"</code>: manifold-aware Gauss--Newton that uses
  :func:<code>slam.manifold.build_manifold_metadata</code> to handle SE(3)
  and Euclidean blocks differently.</li>
<li><code>"gn_jit"</code>: JIT-compiled Gauss--Newton using
  :class:<code>optimization.jit_wrappers.JittedGN</code>.</li>
</ul>
<p>:param lr: Learning rate for gradient-descent-based methods
    (currently used when <code>method == "gd"</code>).
:param iters: Maximum number of iterations for the chosen optimizer.
:param method: Name of the optimization method to use. See the list
    above for supported values.
:param damping: Damping / regularization parameter used by the
    Newton and Gauss--Newton variants.
:param max_step_norm: Maximum allowed step norm for Gauss--Newton
    methods; steps larger than this are clamped to improve stability.
:returns: <code>None</code>. The world model is updated in place.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">optimize</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">lr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="n">iters</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
    <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;gd&quot;</span><span class="p">,</span>
    <span class="n">damping</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span>
    <span class="n">max_step_norm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run a local optimizer on the current world state.</span>

<span class="sd">    This method packs the current variables into a flat state vector,</span>
<span class="sd">    constructs an appropriate objective or residual function, runs one</span>
<span class="sd">    of the supported optimizers, and writes the optimized state back</span>
<span class="sd">    into :attr:`fg.variables`.</span>

<span class="sd">    Supported methods:</span>

<span class="sd">    - ``&quot;gd&quot;``: vanilla gradient descent on the scalar objective</span>
<span class="sd">      :math:`\\|r(x)\\|^2`.</span>
<span class="sd">    - ``&quot;newton&quot;``: damped Newton on the same scalar objective.</span>
<span class="sd">    - ``&quot;gn&quot;``: Gauss--Newton on the stacked residual vector assuming</span>
<span class="sd">      Euclidean variables.</span>
<span class="sd">    - ``&quot;manifold_gn&quot;``: manifold-aware Gauss--Newton that uses</span>
<span class="sd">      :func:`slam.manifold.build_manifold_metadata` to handle SE(3)</span>
<span class="sd">      and Euclidean blocks differently.</span>
<span class="sd">    - ``&quot;gn_jit&quot;``: JIT-compiled Gauss--Newton using</span>
<span class="sd">      :class:`optimization.jit_wrappers.JittedGN`.</span>

<span class="sd">    :param lr: Learning rate for gradient-descent-based methods</span>
<span class="sd">        (currently used when ``method == &quot;gd&quot;``).</span>
<span class="sd">    :param iters: Maximum number of iterations for the chosen optimizer.</span>
<span class="sd">    :param method: Name of the optimization method to use. See the list</span>
<span class="sd">        above for supported values.</span>
<span class="sd">    :param damping: Damping / regularization parameter used by the</span>
<span class="sd">        Newton and Gauss--Newton variants.</span>
<span class="sd">    :param max_step_norm: Maximum allowed step norm for Gauss--Newton</span>
<span class="sd">        methods; steps larger than this are clamped to improve stability.</span>
<span class="sd">    :returns: ``None``. The world model is updated in place.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x_init</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pack_state</span><span class="p">()</span>
    <span class="n">residual_fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_residual</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;gd&quot;</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_objective</span><span class="p">()</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="n">GDConfig</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="n">max_iters</span><span class="o">=</span><span class="n">iters</span><span class="p">)</span>
        <span class="n">x_opt</span> <span class="o">=</span> <span class="n">gradient_descent</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">x_init</span><span class="p">,</span> <span class="n">cfg</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;newton&quot;</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_objective</span><span class="p">()</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="n">NewtonConfig</span><span class="p">(</span><span class="n">max_iters</span><span class="o">=</span><span class="n">iters</span><span class="p">,</span> <span class="n">damping</span><span class="o">=</span><span class="n">damping</span><span class="p">)</span>
        <span class="n">x_opt</span> <span class="o">=</span> <span class="n">damped_newton</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">x_init</span><span class="p">,</span> <span class="n">cfg</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;gn&quot;</span><span class="p">:</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="n">GNConfig</span><span class="p">(</span><span class="n">max_iters</span><span class="o">=</span><span class="n">iters</span><span class="p">,</span> <span class="n">damping</span><span class="o">=</span><span class="n">damping</span><span class="p">,</span> <span class="n">max_step_norm</span><span class="o">=</span><span class="n">max_step_norm</span><span class="p">)</span>
        <span class="n">x_opt</span> <span class="o">=</span> <span class="n">gauss_newton</span><span class="p">(</span><span class="n">residual_fn</span><span class="p">,</span> <span class="n">x_init</span><span class="p">,</span> <span class="n">cfg</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;manifold_gn&quot;</span><span class="p">:</span>
        <span class="n">block_slices</span><span class="p">,</span> <span class="n">manifold_types</span> <span class="o">=</span> <span class="n">build_manifold_metadata</span><span class="p">(</span><span class="n">packed_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pack_state</span><span class="p">(),</span><span class="n">fg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fg</span><span class="p">)</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="n">GNConfig</span><span class="p">(</span><span class="n">max_iters</span><span class="o">=</span><span class="n">iters</span><span class="p">,</span> <span class="n">damping</span><span class="o">=</span><span class="n">damping</span><span class="p">,</span> <span class="n">max_step_norm</span><span class="o">=</span><span class="n">max_step_norm</span><span class="p">)</span>
        <span class="n">x_opt</span> <span class="o">=</span> <span class="n">gauss_newton_manifold</span><span class="p">(</span>
            <span class="n">residual_fn</span><span class="p">,</span> <span class="n">x_init</span><span class="p">,</span> <span class="n">block_slices</span><span class="p">,</span> <span class="n">manifold_types</span><span class="p">,</span> <span class="n">cfg</span>
        <span class="p">)</span>

    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;gn_jit&quot;</span><span class="p">:</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="n">GNConfig</span><span class="p">(</span><span class="n">max_iters</span><span class="o">=</span><span class="n">iters</span><span class="p">,</span> <span class="n">damping</span><span class="o">=</span><span class="n">damping</span><span class="p">,</span> <span class="n">max_step_norm</span><span class="o">=</span><span class="n">max_step_norm</span><span class="p">)</span>
        <span class="n">jgn</span> <span class="o">=</span> <span class="n">JittedGN</span><span class="o">.</span><span class="n">from_residual</span><span class="p">(</span><span class="n">residual_fn</span><span class="p">,</span> <span class="n">cfg</span><span class="p">)</span>
        <span class="n">x_opt</span> <span class="o">=</span> <span class="n">jgn</span><span class="p">(</span><span class="n">x_init</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown optimization method &#39;</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

    <span class="c1"># Write back</span>
    <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unpack_state</span><span class="p">(</span><span class="n">x_opt</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">nid</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fg</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">val</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.model.WorldModel.pack_state" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">pack_state</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Pack all variable values into a single flat JAX array.</p>
<p>The variables are ordered by sorted :class:<code>NodeId</code> to ensure stable
indexing across calls.</p>
<p>:return: Tuple of <code>(x, index)</code> where <code>x</code> is the concatenated
    state vector and <code>index</code> is the mapping produced by
    :meth:<code>_build_state_index</code>.
:rtype: Tuple[jnp.ndarray, Dict[NodeId, Tuple[int, int]]]</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">pack_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pack all variable values into a single flat JAX array.</span>

<span class="sd">    The variables are ordered by sorted :class:`NodeId` to ensure stable</span>
<span class="sd">    indexing across calls.</span>

<span class="sd">    :return: Tuple of ``(x, index)`` where ``x`` is the concatenated</span>
<span class="sd">        state vector and ``index`` is the mapping produced by</span>
<span class="sd">        :meth:`_build_state_index`.</span>
<span class="sd">    :rtype: Tuple[jnp.ndarray, Dict[NodeId, Tuple[int, int]]]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_state_index</span><span class="p">()</span>
    <span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">node_id</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fg</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fg</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span>
        <span class="n">chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">chunks</span><span class="p">),</span> <span class="n">index</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.model.WorldModel.register_residual" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">register_residual</span><span class="p">(</span><span class="n">factor_type</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Register a residual function for a given factor type.</p>
<p>This is the WorldModel-level registry that associates factor type
strings (e.g. <code>"odom_se3"</code>, <code>"voxel_point_obs"</code>) with
JAX-compatible residual functions. The registered functions are
consumed by higher-level residual builders such as
:meth:<code>build_residual</code>.</p>
<h5 id="world.model.WorldModel.register_residual--parameters">Parameters</h5>
<p>factor_type : str
    String identifier for the factor type. This must match the
    <code>type</code> field stored in :class:<code>Factor</code> instances in the
    underlying :class:<code>FactorGraph</code>.
fn : Callable
    Residual function implementing the measurement model. The
    exact signature is intentionally flexible, but it is expected
    to be compatible with the unified residual builder returned by
    :meth:<code>build_residual</code> (e.g. it may be vmapped across factors
    of a given type).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">register_residual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factor_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Register a residual function for a given factor type.</span>

<span class="sd">    This is the WorldModel-level registry that associates factor type</span>
<span class="sd">    strings (e.g. ``&quot;odom_se3&quot;``, ``&quot;voxel_point_obs&quot;``) with</span>
<span class="sd">    JAX-compatible residual functions. The registered functions are</span>
<span class="sd">    consumed by higher-level residual builders such as</span>
<span class="sd">    :meth:`build_residual`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    factor_type : str</span>
<span class="sd">        String identifier for the factor type. This must match the</span>
<span class="sd">        ``type`` field stored in :class:`Factor` instances in the</span>
<span class="sd">        underlying :class:`FactorGraph`.</span>
<span class="sd">    fn : Callable</span>
<span class="sd">        Residual function implementing the measurement model. The</span>
<span class="sd">        exact signature is intentionally flexible, but it is expected</span>
<span class="sd">        to be compatible with the unified residual builder returned by</span>
<span class="sd">        :meth:`build_residual` (e.g. it may be vmapped across factors</span>
<span class="sd">        of a given type).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_residual_registry</span><span class="p">[</span><span class="n">factor_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">fn</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.model.WorldModel.set_variable_slot" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">set_variable_slot</span><span class="p">(</span><span class="n">var_type</span><span class="p">,</span> <span class="n">slot_idx</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Set the value of a variable slot in the active template.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_variable_slot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">slot_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NodeId</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set the value of a variable slot in the active template.&quot;&quot;&quot;</span>
    <span class="n">slot_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">var_type</span><span class="p">,</span> <span class="n">slot_idx</span><span class="p">)</span>
    <span class="n">slot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_var_slots</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">slot_key</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">slot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Variable slot </span><span class="si">{</span><span class="n">slot_key</span><span class="si">}</span><span class="s2"> not found in active template.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">slot</span><span class="o">.</span><span class="n">dim</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Value shape </span><span class="si">{</span><span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> does not match slot dim </span><span class="si">{</span><span class="n">slot</span><span class="o">.</span><span class="n">dim</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fg</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">slot</span><span class="o">.</span><span class="n">node_id</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">slot</span><span class="o">.</span><span class="n">node_id</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.model.WorldModel.snapshot_state" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">snapshot_state</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Capture a shallow snapshot of the current world state.</p>
<p>The snapshot maps integer node ids to their current values. This is
intentionally simple and serialization-friendly, and is meant to be
consumed by higher-level dynamic scene graph structures that want to
record the evolution of the world over time.</p>
<p>:returns: A dictionary mapping <code>int(NodeId)</code> to JAX arrays.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">snapshot_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Capture a shallow snapshot of the current world state.</span>

<span class="sd">    The snapshot maps integer node ids to their current values. This is</span>
<span class="sd">    intentionally simple and serialization-friendly, and is meant to be</span>
<span class="sd">    consumed by higher-level dynamic scene graph structures that want to</span>
<span class="sd">    record the evolution of the world over time.</span>

<span class="sd">    :returns: A dictionary mapping ``int(NodeId)`` to JAX arrays.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="n">nid</span><span class="p">):</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">nid</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fg</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.model.WorldModel.unpack_state" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">unpack_state</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Unpack a flat state vector back into per-variable arrays.</p>
<p>:param x: Flattened state vector produced by :meth:<code>pack_state</code> or
    produced by an optimizer.
:type x: jnp.ndarray
:param index: Mapping from :class:<code>NodeId</code> to <code>(start, dim)</code> blocks
    as returned by :meth:<code>_build_state_index</code>.
:type index: Dict[NodeId, Tuple[int, int]]
:return: Mapping from node id to its corresponding slice of <code>x</code>.
:rtype: Dict[NodeId, jnp.ndarray]</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">unpack_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeId</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeId</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Unpack a flat state vector back into per-variable arrays.</span>

<span class="sd">    :param x: Flattened state vector produced by :meth:`pack_state` or</span>
<span class="sd">        produced by an optimizer.</span>
<span class="sd">    :type x: jnp.ndarray</span>
<span class="sd">    :param index: Mapping from :class:`NodeId` to ``(start, dim)`` blocks</span>
<span class="sd">        as returned by :meth:`_build_state_index`.</span>
<span class="sd">    :type index: Dict[NodeId, Tuple[int, int]]</span>
<span class="sd">    :return: Mapping from node id to its corresponding slice of ``x``.</span>
<span class="sd">    :rtype: Dict[NodeId, jnp.ndarray]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeId</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">node_id</span><span class="p">,</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span> <span class="ow">in</span> <span class="n">index</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">result</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">start</span><span class="o">+</span><span class="n">dim</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.model.WorldModel.unpack_state_inplace" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">unpack_state_inplace</span><span class="p">(</span><span class="n">x_opt</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Write the optimized state vector back into the FactorGraph variable table.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">unpack_state_inplace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_opt</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write the optimized state vector back into the FactorGraph variable table.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pack_state</span><span class="p">()</span>  <span class="c1"># index maps node_id -&gt; (start, end)</span>

    <span class="k">for</span> <span class="n">node_id</span><span class="p">,</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span> <span class="ow">in</span> <span class="n">index</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">block</span> <span class="o">=</span> <span class="n">x_opt</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
        <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fg</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span>
        <span class="n">var</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">block</span>  <span class="c1"># overwrite stored variable value</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h2 id="world.model.marginal_prior_residual" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">marginal_prior_residual</span><span class="p">(</span><span class="n">stacked</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Residual for a dense Gaussian prior induced by marginalization.</p>
<p>This residual encodes a quadratic term of the form</p>
<pre><code>1/2 (x - )^T H (x - )
</code></pre>
<p>via a Cholesky factorization H = L^T L. The parameters are:</p>
<pre><code>mean       : , a 1D array of the same shape as ``stacked``.
sqrt_info  : L, a square matrix such that L^T L  H.
</code></pre>
<p>The returned residual is L @ (x - ), so that the overall contribution
to the objective is 1/2 ||L (x - )||^2.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">marginal_prior_residual</span><span class="p">(</span><span class="n">stacked</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Residual for a dense Gaussian prior induced by marginalization.</span>

<span class="sd">    This residual encodes a quadratic term of the form</span>

<span class="sd">        1/2 (x - )^T H (x - )</span>

<span class="sd">    via a Cholesky factorization H = L^T L. The parameters are:</span>

<span class="sd">        mean       : , a 1D array of the same shape as ``stacked``.</span>
<span class="sd">        sqrt_info  : L, a square matrix such that L^T L  H.</span>

<span class="sd">    The returned residual is L @ (x - ), so that the overall contribution</span>
<span class="sd">    to the objective is 1/2 ||L (x - )||^2.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span>
    <span class="n">sqrt_info</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;sqrt_info&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">sqrt_info</span> <span class="o">@</span> <span class="p">(</span><span class="n">stacked</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><hr />
<h2 id="worldscene_graph"><code>world.scene_graph</code></h2>


<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">

        <p>Dynamic 3D scene graph utilities built on top of the world model.</p>
<p>This module provides a <code>SceneGraphWorld</code> abstraction that organizes
poses, places, rooms, objects, and agents into a <em>dynamic scene graph</em>
backed by the differentiable factor graph.</p>
<p>Conceptually, this layer is responsible for:</p>
<pre><code> Creating typed nodes:
    - Robot / agent poses (SE3)
    - Places / topological nodes (1D)
    - Rooms / regions
    - Objects (points / positions in space)
 Adding semantic and metric relationships between them via factors:
    - Pose priors
    - SE3 odometry / loop closures
    - Poseplace attachments
    - Poseobject / objectplace relations
 Maintaining lightweight indexing:
    - Maps from (agent, time)  pose NodeId
    - Collections of place / room / object node ids
    - Optional trajectory dictionaries
</code></pre>
<p>What it does <strong>not</strong> do:
     It does not implement the optimizer itself.
     It does not hard-code SE3 math or Jacobians.
     It does not perform rendering or perception.</p>
<p>All numerical optimization is delegated to:</p>
<pre><code>- `world.model.WorldModel` (and its `FactorGraph`)
- `optimization.solvers` (GaussNewton / manifold variants)
- `slam.manifold` and `slam.measurements` for geometry and residuals
</code></pre>
<h3 id="world.scene_graph--typical-usage">Typical usage</h3>
<p>Experiments in <code>experiments/exp0X_*.py</code> follow a common pattern:</p>
<pre><code>1. Construct a `SceneGraphWorld`.
2. Add a small chain of poses, places, and objects.
3. Attach priors and odometry factors.
4. Optionally attach voxel or observation factors.
5. Optimize via GaussNewton (JIT or non-JIT).
6. Inspect the resulting scene graph state.
</code></pre>
<h3 id="world.scene_graph--design-goals">Design goals</h3>
<ul>
<li><strong>Ergonomics</strong>: hide raw <code>NodeId</code> and factor wiring behind friendly
  helpers like add pose, add agent pose, attach place, etc.</li>
<li><strong>Differentiable backbone</strong>: everything created here remains compatible
  with JAX JIT and automatic differentiation downstream.</li>
<li><strong>Extensibility</strong>: easy to add new relation types and node types
  without changing the optimizer or lower-level infrastructure.</li>
</ul>










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="world.scene_graph.SceneGraphNoiseConfig" class="doc doc-heading">
              <code class="highlight language-python"><span class="n">SceneGraphNoiseConfig</span><span class="p">(</span><span class="n">prior_pose_sigma</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">odom_se3_sigma</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">smooth_pose_sigma</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">pose_place_sigma</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">object_at_pose_sigma</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">pose_landmark_sigma</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">pose_landmark_bearing_sigma</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">pose_voxel_point_sigma</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">voxel_smoothness_sigma</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">voxel_point_obs_sigma</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">



        <p>Default noise (standard deviation) per factor type.</p>


<details class="these-are-in-the-same-units-as-the-residuals" open>
  <summary>These are in the same units as the residuals</summary>
  <ul>
<li>prior / odom / smoothness: R^6 pose (m, m, m, rad, rad, rad)</li>
<li>pose_place / object_at_pose: R^1 or R^3 (m)</li>
</ul>
</details>










<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="world.scene_graph.SceneGraphWorld" class="doc doc-heading">
              <code class="highlight language-python"><span class="n">SceneGraphWorld</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">



        <p>World-level dynamic scene graph wrapper that manages typed nodes and semantic relationships,
built atop the WorldModel. Provides ergonomic helpers for creating and connecting SE(3) poses,
places, rooms, objects, and agents, and maintains convenient indexing for scene-graph
experiments.</p>
<p>In addition to delegating numerical optimization to the underlying WorldModel,
SceneGraphWorld maintains its own lightweight memory of node states. This
persistent cache decouples the scene graph from the FactorGraph so that
sliding-window marginalization or variable removal at the optimization level
does not cause information loss at the scene-graph level.</p>








                  <details class="mkdocstrings-source">
                    <summary>Source code in <code>dsg-jit/dsg_jit/world/scene_graph.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">wm</span> <span class="o">=</span> <span class="n">WorldModel</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pose_trajectory</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">noise</span> <span class="o">=</span> <span class="n">SceneGraphNoiseConfig</span><span class="p">()</span>

    <span class="c1"># --- Named semantic node indexes ---</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">room_nodes</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">place_nodes</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">object_nodes</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># --- Semantic adjacency (for visualization / topology) ---</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">room_place_edges</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">object_room_edges</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># --- Persistent scene-graph memory of node states ---</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">SceneNodeState</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_factor_memory</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">SGFactorRecord</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_next_factor_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># --- Active-template mode (bounded FG / single-JIT) ---</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_active_template_enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># var_type -&gt; capacity (# slots)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_slot_capacity</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># node_id -&gt; (var_type, slot_idx)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_slot_assign</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># var_type -&gt; FIFO list of node_ids assigned (for eviction)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_slot_fifo</span><span class="p">:</span> <span class="n">DefaultDict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Deque</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">deque</span><span class="p">)</span>

    <span class="c1"># factor_type -&gt; capacity (# slots)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_factor_slot_capacity</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># factor_type -&gt; next slot index (round-robin)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_factor_slot_next</span><span class="p">:</span> <span class="n">DefaultDict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># --- Global residuals registry ---</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">register_residual</span><span class="p">(</span><span class="s2">&quot;prior&quot;</span><span class="p">,</span> <span class="n">prior_residual</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">register_residual</span><span class="p">(</span><span class="s2">&quot;odom_se3&quot;</span><span class="p">,</span> <span class="n">odom_se3_residual</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">register_residual</span><span class="p">(</span><span class="s2">&quot;odom_se3_geodesic&quot;</span><span class="p">,</span> <span class="n">odom_se3_geodesic_residual</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">register_residual</span><span class="p">(</span><span class="s2">&quot;pose_place_attachment&quot;</span><span class="p">,</span> <span class="n">pose_place_attachment_residual</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">register_residual</span><span class="p">(</span><span class="s2">&quot;object_at_pose&quot;</span><span class="p">,</span> <span class="n">object_at_pose_residual</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">register_residual</span><span class="p">(</span><span class="s2">&quot;pose_temporal_smoothness&quot;</span><span class="p">,</span> <span class="n">pose_temporal_smoothness_residual</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">register_residual</span><span class="p">(</span><span class="s2">&quot;pose_landmark_relative&quot;</span><span class="p">,</span> <span class="n">pose_landmark_relative_residual</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">register_residual</span><span class="p">(</span><span class="s2">&quot;pose_landmark_bearing&quot;</span><span class="p">,</span> <span class="n">pose_landmark_bearing_residual</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">register_residual</span><span class="p">(</span><span class="s2">&quot;pose_voxel_point&quot;</span><span class="p">,</span> <span class="n">pose_voxel_point_residual</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">register_residual</span><span class="p">(</span><span class="s2">&quot;voxel_smoothness&quot;</span><span class="p">,</span> <span class="n">voxel_smoothness_residual</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">register_residual</span><span class="p">(</span><span class="s2">&quot;voxel_point_obs&quot;</span><span class="p">,</span> <span class="n">voxel_point_observation_residual</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">register_residual</span><span class="p">(</span><span class="s2">&quot;range&quot;</span><span class="p">,</span> <span class="n">range_residual</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
                  </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="world.scene_graph.SceneGraphWorld.add_agent_pose_landmark_bearing" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_agent_pose_landmark_bearing</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">landmark_id</span><span class="p">,</span> <span class="n">bearing</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Add a bearing-only poselandmark constraint for an agent at time <code>t</code>.</p>
<p>This wraps :meth:<code>add_pose_landmark_bearing</code> and resolves the pose id
from :attr:<code>pose_trajectory</code>.</p>
<p>:param agent: Agent identifier.
:param t: Timestep index for the pose.
:param landmark_id: Node id of the 3D landmark variable.
:param bearing: Iterable of length 3 giving the bearing vector in the
    pose frame (it will be normalized internally).
:param sigma: Optional noise standard deviation. If <code>None</code>, falls back
    to :attr:<code>SceneGraphNoiseConfig.pose_landmark_bearing_sigma</code>.
:return: Integer factor id of the created bearing constraint.
:raises KeyError: If no pose has been registered for <code>(agent, t)</code>.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_agent_pose_landmark_bearing</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">agent</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">t</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">landmark_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">bearing</span><span class="p">,</span>
    <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add a bearing-only poselandmark constraint for an agent at time ``t``.</span>

<span class="sd">    This wraps :meth:`add_pose_landmark_bearing` and resolves the pose id</span>
<span class="sd">    from :attr:`pose_trajectory`.</span>

<span class="sd">    :param agent: Agent identifier.</span>
<span class="sd">    :param t: Timestep index for the pose.</span>
<span class="sd">    :param landmark_id: Node id of the 3D landmark variable.</span>
<span class="sd">    :param bearing: Iterable of length 3 giving the bearing vector in the</span>
<span class="sd">        pose frame (it will be normalized internally).</span>
<span class="sd">    :param sigma: Optional noise standard deviation. If ``None``, falls back</span>
<span class="sd">        to :attr:`SceneGraphNoiseConfig.pose_landmark_bearing_sigma`.</span>
<span class="sd">    :return: Integer factor id of the created bearing constraint.</span>
<span class="sd">    :raises KeyError: If no pose has been registered for ``(agent, t)``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose_trajectory</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No pose registered for agent=</span><span class="si">{</span><span class="n">agent</span><span class="si">!r}</span><span class="s2">, t=</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">pose_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose_trajectory</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_pose_landmark_bearing</span><span class="p">(</span>
        <span class="n">pose_id</span><span class="o">=</span><span class="n">pose_id</span><span class="p">,</span>
        <span class="n">landmark_id</span><span class="o">=</span><span class="n">landmark_id</span><span class="p">,</span>
        <span class="n">bearing</span><span class="o">=</span><span class="n">bearing</span><span class="p">,</span>
        <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.scene_graph.SceneGraphWorld.add_agent_pose_landmark_relative" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_agent_pose_landmark_relative</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">landmark_id</span><span class="p">,</span> <span class="n">measurement</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Add a relative poselandmark constraint for an agent at time <code>t</code>.</p>
<p>This is a small ergonomic wrapper around
:meth:<code>add_pose_landmark_relative</code> that resolves the pose id using
:attr:<code>pose_trajectory</code>.</p>
<p>:param agent: Agent identifier.
:param t: Timestep index for the pose.
:param landmark_id: Node id of the 3D landmark variable.
:param measurement: Iterable of length 3 giving the expected landmark
    position in the pose frame.
:param sigma: Optional noise standard deviation. If <code>None</code>, falls back
    to :attr:<code>SceneGraphNoiseConfig.pose_landmark_sigma</code>.
:return: Integer factor id of the created relative landmark constraint.
:raises KeyError: If no pose has been registered for <code>(agent, t)</code>.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_agent_pose_landmark_relative</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">agent</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">t</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">landmark_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">measurement</span><span class="p">,</span>
    <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add a relative poselandmark constraint for an agent at time ``t``.</span>

<span class="sd">    This is a small ergonomic wrapper around</span>
<span class="sd">    :meth:`add_pose_landmark_relative` that resolves the pose id using</span>
<span class="sd">    :attr:`pose_trajectory`.</span>

<span class="sd">    :param agent: Agent identifier.</span>
<span class="sd">    :param t: Timestep index for the pose.</span>
<span class="sd">    :param landmark_id: Node id of the 3D landmark variable.</span>
<span class="sd">    :param measurement: Iterable of length 3 giving the expected landmark</span>
<span class="sd">        position in the pose frame.</span>
<span class="sd">    :param sigma: Optional noise standard deviation. If ``None``, falls back</span>
<span class="sd">        to :attr:`SceneGraphNoiseConfig.pose_landmark_sigma`.</span>
<span class="sd">    :return: Integer factor id of the created relative landmark constraint.</span>
<span class="sd">    :raises KeyError: If no pose has been registered for ``(agent, t)``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose_trajectory</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No pose registered for agent=</span><span class="si">{</span><span class="n">agent</span><span class="si">!r}</span><span class="s2">, t=</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">pose_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose_trajectory</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_pose_landmark_relative</span><span class="p">(</span>
        <span class="n">pose_id</span><span class="o">=</span><span class="n">pose_id</span><span class="p">,</span>
        <span class="n">landmark_id</span><span class="o">=</span><span class="n">landmark_id</span><span class="p">,</span>
        <span class="n">measurement</span><span class="o">=</span><span class="n">measurement</span><span class="p">,</span>
        <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.scene_graph.SceneGraphWorld.add_agent_pose_place_attachment" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_agent_pose_place_attachment</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">place_id</span><span class="p">,</span> <span class="n">coord_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Attach an agent pose at time <code>t</code> to a place node.</p>
<p>This is a higher-level wrapper around :meth:<code>add_place_attachment</code>
which resolves the pose id via :attr:<code>pose_trajectory</code>.</p>
<p>:param agent: Agent identifier.
:param t: Integer timestep index.
:param place_id: Node id of the place variable (1D or 3D).
:param coord_index: Index of the pose coordinate to tie to the place
    (typically 0 for x, 1 for y, etc.). Defaults to 0.
:param sigma: Optional noise standard deviation. If <code>None</code>, falls back
    to :attr:<code>SceneGraphNoiseConfig.pose_place_sigma</code>.
:return: Integer factor id of the created attachment constraint.
:raises KeyError: If no pose has been registered for <code>(agent, t)</code>.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_agent_pose_place_attachment</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">agent</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">t</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">place_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">coord_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Attach an agent pose at time ``t`` to a place node.</span>

<span class="sd">    This is a higher-level wrapper around :meth:`add_place_attachment`</span>
<span class="sd">    which resolves the pose id via :attr:`pose_trajectory`.</span>

<span class="sd">    :param agent: Agent identifier.</span>
<span class="sd">    :param t: Integer timestep index.</span>
<span class="sd">    :param place_id: Node id of the place variable (1D or 3D).</span>
<span class="sd">    :param coord_index: Index of the pose coordinate to tie to the place</span>
<span class="sd">        (typically 0 for x, 1 for y, etc.). Defaults to 0.</span>
<span class="sd">    :param sigma: Optional noise standard deviation. If ``None``, falls back</span>
<span class="sd">        to :attr:`SceneGraphNoiseConfig.pose_place_sigma`.</span>
<span class="sd">    :return: Integer factor id of the created attachment constraint.</span>
<span class="sd">    :raises KeyError: If no pose has been registered for ``(agent, t)``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pose_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pose_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose_trajectory</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No pose registered for agent=</span><span class="si">{</span><span class="n">agent</span><span class="si">!r}</span><span class="s2">, t=</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">pose_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose_trajectory</span><span class="p">[</span><span class="n">pose_key</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_place_attachment</span><span class="p">(</span>
        <span class="n">pose_id</span><span class="o">=</span><span class="n">pose_id</span><span class="p">,</span>
        <span class="n">place_id</span><span class="o">=</span><span class="n">place_id</span><span class="p">,</span>
        <span class="n">coord_index</span><span class="o">=</span><span class="n">coord_index</span><span class="p">,</span>
        <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.scene_graph.SceneGraphWorld.add_agent_pose_se3" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_agent_pose_se3</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Add an SE(3) pose for a given agent at a specific timestep.</p>
<p>:param agent: Agent identifier (for example, a robot name).
:param t: Integer timestep index.
:param value: Length-6 array-like se(3) vector for the pose.
:return: Integer node id of the created pose variable.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_agent_pose_se3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add an SE(3) pose for a given agent at a specific timestep.</span>

<span class="sd">    :param agent: Agent identifier (for example, a robot name).</span>
<span class="sd">    :param t: Integer timestep index.</span>
<span class="sd">    :param value: Length-6 array-like se(3) vector for the pose.</span>
<span class="sd">    :return: Integer node id of the created pose variable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_template_enabled</span><span class="p">:</span>
        <span class="n">nid_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_assign_var_slot</span><span class="p">(</span><span class="s2">&quot;pose_se3&quot;</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nid_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;pose_se3&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_remember_node</span><span class="p">(</span><span class="n">nid_int</span><span class="p">,</span> <span class="s2">&quot;pose_se3&quot;</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pose_trajectory</span><span class="p">[(</span><span class="n">agent</span><span class="p">,</span> <span class="n">t</span><span class="p">)]</span> <span class="o">=</span> <span class="n">nid_int</span>
    <span class="k">return</span> <span class="n">nid_int</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.scene_graph.SceneGraphWorld.add_agent_pose_voxel_point" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_agent_pose_voxel_point</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">voxel_id</span><span class="p">,</span> <span class="n">point_meas</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Constrain a voxel cell using a point measurement from an agent pose.</p>
<p>This wraps :meth:<code>add_pose_voxel_point</code> and resolves the pose id from
:attr:<code>pose_trajectory</code>.</p>
<p>:param agent: Agent identifier.
:param t: Timestep index for the pose.
:param voxel_id: Node id of the voxel cell variable.
:param point_meas: Iterable of length 3 giving a point in the pose
    frame (for example, a back-projected LiDAR or depth sample).
:param sigma: Optional noise standard deviation. If <code>None</code>, falls
    back to :attr:<code>SceneGraphNoiseConfig.pose_voxel_point_sigma</code>.
:return: Integer factor id of the created voxel-point constraint.
:raises KeyError: If no pose has been registered for <code>(agent, t)</code>.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_agent_pose_voxel_point</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">agent</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">t</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">voxel_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">point_meas</span><span class="p">,</span>
    <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Constrain a voxel cell using a point measurement from an agent pose.</span>

<span class="sd">    This wraps :meth:`add_pose_voxel_point` and resolves the pose id from</span>
<span class="sd">    :attr:`pose_trajectory`.</span>

<span class="sd">    :param agent: Agent identifier.</span>
<span class="sd">    :param t: Timestep index for the pose.</span>
<span class="sd">    :param voxel_id: Node id of the voxel cell variable.</span>
<span class="sd">    :param point_meas: Iterable of length 3 giving a point in the pose</span>
<span class="sd">        frame (for example, a back-projected LiDAR or depth sample).</span>
<span class="sd">    :param sigma: Optional noise standard deviation. If ``None``, falls</span>
<span class="sd">        back to :attr:`SceneGraphNoiseConfig.pose_voxel_point_sigma`.</span>
<span class="sd">    :return: Integer factor id of the created voxel-point constraint.</span>
<span class="sd">    :raises KeyError: If no pose has been registered for ``(agent, t)``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose_trajectory</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No pose registered for agent=</span><span class="si">{</span><span class="n">agent</span><span class="si">!r}</span><span class="s2">, t=</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">pose_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose_trajectory</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_pose_voxel_point</span><span class="p">(</span>
        <span class="n">pose_id</span><span class="o">=</span><span class="n">pose_id</span><span class="p">,</span>
        <span class="n">voxel_id</span><span class="o">=</span><span class="n">voxel_id</span><span class="p">,</span>
        <span class="n">point_meas</span><span class="o">=</span><span class="n">point_meas</span><span class="p">,</span>
        <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.scene_graph.SceneGraphWorld.add_agent_range_measurement" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_agent_range_measurement</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">target_nid</span><span class="p">,</span> <span class="n">measured_range</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Add a range-only factor using an agent's pose at a given timestep.</p>
<p>This is a convenience wrapper around :meth:<code>add_range_measurement</code>
that looks up the pose node id from :attr:<code>pose_trajectory</code> using
<code>(agent, t)</code> and then creates a <code>"range"</code> factor to a target node.</p>
<p>:param agent: Agent identifier (for example, a robot name).
:param t: Integer timestep index for the agent pose.
:param target_nid: NodeId of the target variable (for example, <code>place3d</code>,
    <code>voxel_cell</code> or <code>object3d</code>).
:param measured_range: Observed distance (same units as the world coordinates).
:param sigma: Optional standard deviation of the measurement noise. If
    provided (and <code>weight</code> is <code>None</code>), it is converted to a weight via
    :func:<code>slam.measurements.sigma_to_weight</code>.
:param weight: Optional explicit weight. If both <code>sigma</code> and <code>weight</code>
    are given, <code>weight</code> takes precedence.
:return: Integer factor id of the created range factor.
:raises KeyError: If no pose has been registered for <code>(agent, t)</code>.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_agent_range_measurement</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">agent</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">t</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">target_nid</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">measured_range</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">weight</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add a range-only factor using an agent&#39;s pose at a given timestep.</span>

<span class="sd">    This is a convenience wrapper around :meth:`add_range_measurement`</span>
<span class="sd">    that looks up the pose node id from :attr:`pose_trajectory` using</span>
<span class="sd">    ``(agent, t)`` and then creates a ``&quot;range&quot;`` factor to a target node.</span>

<span class="sd">    :param agent: Agent identifier (for example, a robot name).</span>
<span class="sd">    :param t: Integer timestep index for the agent pose.</span>
<span class="sd">    :param target_nid: NodeId of the target variable (for example, ``place3d``,</span>
<span class="sd">        ``voxel_cell`` or ``object3d``).</span>
<span class="sd">    :param measured_range: Observed distance (same units as the world coordinates).</span>
<span class="sd">    :param sigma: Optional standard deviation of the measurement noise. If</span>
<span class="sd">        provided (and ``weight`` is ``None``), it is converted to a weight via</span>
<span class="sd">        :func:`slam.measurements.sigma_to_weight`.</span>
<span class="sd">    :param weight: Optional explicit weight. If both ``sigma`` and ``weight``</span>
<span class="sd">        are given, ``weight`` takes precedence.</span>
<span class="sd">    :return: Integer factor id of the created range factor.</span>
<span class="sd">    :raises KeyError: If no pose has been registered for ``(agent, t)``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pose_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pose_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose_trajectory</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No pose registered for agent=</span><span class="si">{</span><span class="n">agent</span><span class="si">!r}</span><span class="s2">, t=</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">pose_nid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose_trajectory</span><span class="p">[</span><span class="n">pose_key</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_range_measurement</span><span class="p">(</span>
        <span class="n">pose_nid</span><span class="o">=</span><span class="n">pose_nid</span><span class="p">,</span>
        <span class="n">target_nid</span><span class="o">=</span><span class="n">target_nid</span><span class="p">,</span>
        <span class="n">measured_range</span><span class="o">=</span><span class="n">measured_range</span><span class="p">,</span>
        <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span>
        <span class="n">weight</span><span class="o">=</span><span class="n">weight</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.scene_graph.SceneGraphWorld.add_agent_temporal_smoothness" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_agent_temporal_smoothness</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Enforce temporal smoothness between successive poses of a given agent.</p>
<p>This enforces a smoothness constraint between the poses at timesteps
<code>t</code> and <code>t+1</code> for the specified agent, using
:meth:<code>add_temporal_smoothness</code> internally.</p>
<p>:param agent: Agent identifier.
:param t: Timestep index for the first pose in the pair.
:param sigma: Optional standard deviation controlling smoothness. If
    <code>None</code>, falls back to :attr:<code>SceneGraphNoiseConfig.smooth_pose_sigma</code>.
:return: Integer factor id of the created smoothness constraint.
:raises KeyError: If either pose <code>(agent, t)</code> or <code>(agent, t+1)</code> has
    not been registered.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_agent_temporal_smoothness</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">agent</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">t</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Enforce temporal smoothness between successive poses of a given agent.</span>

<span class="sd">    This enforces a smoothness constraint between the poses at timesteps</span>
<span class="sd">    ``t`` and ``t+1`` for the specified agent, using</span>
<span class="sd">    :meth:`add_temporal_smoothness` internally.</span>

<span class="sd">    :param agent: Agent identifier.</span>
<span class="sd">    :param t: Timestep index for the first pose in the pair.</span>
<span class="sd">    :param sigma: Optional standard deviation controlling smoothness. If</span>
<span class="sd">        ``None``, falls back to :attr:`SceneGraphNoiseConfig.smooth_pose_sigma`.</span>
<span class="sd">    :return: Integer factor id of the created smoothness constraint.</span>
<span class="sd">    :raises KeyError: If either pose ``(agent, t)`` or ``(agent, t+1)`` has</span>
<span class="sd">        not been registered.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">key_t</span> <span class="o">=</span> <span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
    <span class="n">key_t1</span> <span class="o">=</span> <span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">key_t</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose_trajectory</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No pose registered for agent=</span><span class="si">{</span><span class="n">agent</span><span class="si">!r}</span><span class="s2">, t=</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">key_t1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose_trajectory</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No pose registered for agent=</span><span class="si">{</span><span class="n">agent</span><span class="si">!r}</span><span class="s2">, t=</span><span class="si">{</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">pose_id_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose_trajectory</span><span class="p">[</span><span class="n">key_t</span><span class="p">]</span>
    <span class="n">pose_id_t1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose_trajectory</span><span class="p">[</span><span class="n">key_t1</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_temporal_smoothness</span><span class="p">(</span>
        <span class="n">pose_id_t</span><span class="o">=</span><span class="n">pose_id_t</span><span class="p">,</span>
        <span class="n">pose_id_t1</span><span class="o">=</span><span class="n">pose_id_t1</span><span class="p">,</span>
        <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.scene_graph.SceneGraphWorld.add_landmark3d" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_landmark3d</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Add a 3D landmark node (R^3).</p>
<p>:param xyz: Iterable of length 3 giving world coordinates.
:return: Integer node id of the created landmark variable.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_landmark3d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xyz</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add a 3D landmark node (R^3).</span>

<span class="sd">    :param xyz: Iterable of length 3 giving world coordinates.</span>
<span class="sd">    :return: Integer node id of the created landmark variable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_template_enabled</span><span class="p">:</span>
        <span class="n">nid_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_assign_var_slot</span><span class="p">(</span><span class="s2">&quot;landmark3d&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nid_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;landmark3d&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_remember_node</span><span class="p">(</span><span class="n">nid_int</span><span class="p">,</span> <span class="s2">&quot;landmark3d&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">nid_int</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.scene_graph.SceneGraphWorld.add_named_object3d" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_named_object3d</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">xyz</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Add a 3D object and register it under a semantic name.</p>
<p>:param name: Identifier for the object (for example, <code>"chair_1"</code>).
:param xyz: Iterable of length 3 giving the world-frame position.
:return: Integer node id of the created object variable.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_named_object3d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">xyz</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add a 3D object and register it under a semantic name.</span>

<span class="sd">    :param name: Identifier for the object (for example, ``&quot;chair_1&quot;``).</span>
<span class="sd">    :param xyz: Iterable of length 3 giving the world-frame position.</span>
<span class="sd">    :return: Integer node id of the created object variable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">obj_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_object3d</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">object_nodes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj_id</span>
    <span class="k">return</span> <span class="n">obj_id</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.scene_graph.SceneGraphWorld.add_object3d" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_object3d</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Add an object with 3D position (R^3).</p>
<p>:param xyz: Iterable of length 3 giving the object position in
    world coordinates.
:return: Integer node id of the created object variable.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_object3d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xyz</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add an object with 3D position (R^3).</span>

<span class="sd">    :param xyz: Iterable of length 3 giving the object position in</span>
<span class="sd">        world coordinates.</span>
<span class="sd">    :return: Integer node id of the created object variable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_template_enabled</span><span class="p">:</span>
        <span class="n">nid_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_assign_var_slot</span><span class="p">(</span><span class="s2">&quot;object3d&quot;</span><span class="p">,</span> <span class="n">xyz</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nid_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;object3d&quot;</span><span class="p">,</span> <span class="n">xyz</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_remember_node</span><span class="p">(</span><span class="n">nid_int</span><span class="p">,</span> <span class="s2">&quot;object3d&quot;</span><span class="p">,</span> <span class="n">xyz</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">nid_int</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.scene_graph.SceneGraphWorld.add_object_room_edge" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_object_room_edge</span><span class="p">(</span><span class="n">object_id</span><span class="p">,</span> <span class="n">room_id</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Register a semantic edge between an object node and a room node.</p>
<p>This helper is intentionally lightweight: it does <em>not</em> add a numeric
factor to the underlying factor graph. Instead it records topological
connectivity for visualization and higher-level reasoning, similar to
classic dynamic scene-graph frameworks.</p>
<p>:param object_id: Integer node id of the object variable.
:param room_id: Integer node id of the room variable.
:return: None.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_object_room_edge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">object_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">room_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Register a semantic edge between an object node and a room node.</span>

<span class="sd">    This helper is intentionally lightweight: it does *not* add a numeric</span>
<span class="sd">    factor to the underlying factor graph. Instead it records topological</span>
<span class="sd">    connectivity for visualization and higher-level reasoning, similar to</span>
<span class="sd">    classic dynamic scene-graph frameworks.</span>

<span class="sd">    :param object_id: Integer node id of the object variable.</span>
<span class="sd">    :param room_id: Integer node id of the room variable.</span>
<span class="sd">    :return: None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">object_room_edges</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">object_id</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">room_id</span><span class="p">)))</span>
    <span class="c1"># Also register in the SceneGraph&#39;s factor memory for visualization.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_remember_factor</span><span class="p">(</span>
        <span class="n">f_type</span><span class="o">=</span><span class="s2">&quot;semantic_object_room&quot;</span><span class="p">,</span>
        <span class="n">var_ids</span><span class="o">=</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">object_id</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">room_id</span><span class="p">)),</span>
        <span class="n">params</span><span class="o">=</span><span class="p">{},</span>
        <span class="n">relation</span><span class="o">=</span><span class="s2">&quot;object-room&quot;</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.scene_graph.SceneGraphWorld.add_odom_se3_additive" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_odom_se3_additive</span><span class="p">(</span><span class="n">pose_i</span><span class="p">,</span> <span class="n">pose_j</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Add an additive SE(3) odometry factor in R^6.</p>
<p>The measurement is a translation along the x-axis plus zero rotation.</p>
<p>:param pose_i: Node id of the source pose.
:param pose_j: Node id of the destination pose.
:param dx: Translation along the x-axis in meters.
:param sigma: Optional standard deviation for the odometry noise. If
    <code>None</code>, :attr:<code>SceneGraphNoiseConfig.odom_se3_sigma</code> is used.
:return: Integer factor id of the created odometry constraint.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_odom_se3_additive</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">pose_i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">pose_j</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">dx</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add an additive SE(3) odometry factor in R^6.</span>

<span class="sd">    The measurement is a translation along the x-axis plus zero rotation.</span>

<span class="sd">    :param pose_i: Node id of the source pose.</span>
<span class="sd">    :param pose_j: Node id of the destination pose.</span>
<span class="sd">    :param dx: Translation along the x-axis in meters.</span>
<span class="sd">    :param sigma: Optional standard deviation for the odometry noise. If</span>
<span class="sd">        ``None``, :attr:`SceneGraphNoiseConfig.odom_se3_sigma` is used.</span>
<span class="sd">    :return: Integer factor id of the created odometry constraint.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">meas</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dx</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">sigma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="o">.</span><span class="n">odom_se3_sigma</span>

    <span class="n">weight</span> <span class="o">=</span> <span class="n">sigma_to_weight</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>

    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;measurement&quot;</span><span class="p">:</span> <span class="n">meas</span><span class="p">,</span>
        <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="n">weight</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">remembered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remember_factor</span><span class="p">(</span>
        <span class="n">f_type</span><span class="o">=</span><span class="s2">&quot;odom_se3&quot;</span><span class="p">,</span>
        <span class="n">var_ids</span><span class="o">=</span><span class="p">(</span><span class="n">pose_i</span><span class="p">,</span> <span class="n">pose_j</span><span class="p">),</span>
        <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
        <span class="n">relation</span><span class="o">=</span><span class="s2">&quot;factor:odom_se3&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_template_enabled</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assign_factor_slot</span><span class="p">(</span><span class="s2">&quot;odom_se3&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">pose_i</span><span class="p">,</span> <span class="n">pose_j</span><span class="p">),</span> <span class="n">params</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">remembered</span><span class="p">)</span>

    <span class="n">fid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">add_factor</span><span class="p">(</span>
        <span class="s2">&quot;odom_se3&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="n">pose_i</span><span class="p">,</span> <span class="n">pose_j</span><span class="p">),</span>
        <span class="n">params</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.scene_graph.SceneGraphWorld.add_odom_se3_geodesic" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_odom_se3_geodesic</span><span class="p">(</span><span class="n">pose_i</span><span class="p">,</span> <span class="n">pose_j</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">yaw</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Add a geodesic SE(3) odometry factor.</p>
<p>The measurement is parameterized as translation + yaw in se(3).</p>
<p>:param pose_i: Node id of the source pose.
:param pose_j: Node id of the destination pose.
:param dx: Translation along the x-axis in meters.
:param yaw: Heading change around the z-axis in radians.
:param sigma: Optional standard deviation for the odometry noise. If
    <code>None</code>, :attr:<code>SceneGraphNoiseConfig.odom_se3_sigma</code> is used.
:return: Integer factor id of the created odometry constraint.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_odom_se3_geodesic</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">pose_i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">pose_j</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">dx</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">yaw</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add a geodesic SE(3) odometry factor.</span>

<span class="sd">    The measurement is parameterized as translation + yaw in se(3).</span>

<span class="sd">    :param pose_i: Node id of the source pose.</span>
<span class="sd">    :param pose_j: Node id of the destination pose.</span>
<span class="sd">    :param dx: Translation along the x-axis in meters.</span>
<span class="sd">    :param yaw: Heading change around the z-axis in radians.</span>
<span class="sd">    :param sigma: Optional standard deviation for the odometry noise. If</span>
<span class="sd">        ``None``, :attr:`SceneGraphNoiseConfig.odom_se3_sigma` is used.</span>
<span class="sd">    :return: Integer factor id of the created odometry constraint.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">meas</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dx</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">yaw</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">sigma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="o">.</span><span class="n">odom_se3_sigma</span>

    <span class="n">weight</span> <span class="o">=</span> <span class="n">sigma_to_weight</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>

    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;measurement&quot;</span><span class="p">:</span> <span class="n">meas</span><span class="p">,</span>
        <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="n">weight</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">remembered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remember_factor</span><span class="p">(</span>
        <span class="n">f_type</span><span class="o">=</span><span class="s2">&quot;odom_se3_geodesic&quot;</span><span class="p">,</span>
        <span class="n">var_ids</span><span class="o">=</span><span class="p">(</span><span class="n">pose_i</span><span class="p">,</span> <span class="n">pose_j</span><span class="p">),</span>
        <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
        <span class="n">relation</span><span class="o">=</span><span class="s2">&quot;factor:odom_se3_geodesic&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_template_enabled</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assign_factor_slot</span><span class="p">(</span><span class="s2">&quot;odom_se3_geodesic&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">pose_i</span><span class="p">,</span> <span class="n">pose_j</span><span class="p">),</span> <span class="n">params</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">remembered</span><span class="p">)</span>

    <span class="n">fid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">add_factor</span><span class="p">(</span>
        <span class="s2">&quot;odom_se3_geodesic&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="n">pose_i</span><span class="p">,</span> <span class="n">pose_j</span><span class="p">),</span>
        <span class="n">params</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.scene_graph.SceneGraphWorld.add_place1d" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_place1d</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Add a 1D place variable.</p>
<p>:param x: Scalar position along a 1D axis (e.g. corridor coordinate).
:return: Integer node id of the created place variable.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_place1d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add a 1D place variable.</span>

<span class="sd">    :param x: Scalar position along a 1D axis (e.g. corridor coordinate).</span>
<span class="sd">    :return: Integer node id of the created place variable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_template_enabled</span><span class="p">:</span>
        <span class="n">nid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_assign_var_slot</span><span class="p">(</span><span class="s2">&quot;place1d&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;place1d&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_remember_node</span><span class="p">(</span><span class="n">nid</span><span class="p">,</span> <span class="s2">&quot;place1d&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">nid</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.scene_graph.SceneGraphWorld.add_place3d" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_place3d</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">xyz</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Add a 3D place node (R^3) with a human-readable name.</p>
<p>This is a semantic helper for dynamic scene-graph style usage.</p>
<p>:param name: Identifier for the place (for example, <code>"place_A"</code>).
:param xyz: Iterable of length 3 giving the world-frame position.
:return: Integer node id of the created place variable.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_place3d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">xyz</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add a 3D place node (R^3) with a human-readable name.</span>

<span class="sd">    This is a semantic helper for dynamic scene-graph style usage.</span>

<span class="sd">    :param name: Identifier for the place (for example, ``&quot;place_A&quot;``).</span>
<span class="sd">    :param xyz: Iterable of length 3 giving the world-frame position.</span>
<span class="sd">    :return: Integer node id of the created place variable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_template_enabled</span><span class="p">:</span>
        <span class="n">nid_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_assign_var_slot</span><span class="p">(</span><span class="s2">&quot;place3d&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nid_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;place3d&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_remember_node</span><span class="p">(</span><span class="n">nid_int</span><span class="p">,</span> <span class="s2">&quot;place3d&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">place_nodes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">nid_int</span>
    <span class="k">return</span> <span class="n">nid_int</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.scene_graph.SceneGraphWorld.add_place_attachment" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_place_attachment</span><span class="p">(</span><span class="n">pose_id</span><span class="p">,</span> <span class="n">place_id</span><span class="p">,</span> <span class="n">coord_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Attach a SE(3) pose to a place node (1D or 3D).</p>
<p>This is a higher-level, dimension-aware wrapper around the
<code>pose_place_attachment</code> residual, and is intended for scene-graph
style experiments where places may be either 1D (topological) or
3D (metric positions).</p>
<p>:param pose_id: Node id of the SE(3) pose variable.
:param place_id: Node id of the place variable. The underlying state
    dimension is inferred at runtime from the factor graph (for
    example, 1 for <code>place1d</code> or 3 for <code>place3d</code>).
:param coord_index: Index of the pose coordinate to tie to the place
    (typically 0 for x, 1 for y, etc.). Defaults to 0.
:param sigma: Optional noise standard deviation. If <code>None</code>, falls
    back to :attr:<code>SceneGraphNoiseConfig.pose_place_sigma</code>.
:return: Integer factor id of the created attachment constraint.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_place_attachment</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">pose_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">place_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">coord_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Attach a SE(3) pose to a place node (1D or 3D).</span>

<span class="sd">    This is a higher-level, dimension-aware wrapper around the</span>
<span class="sd">    ``pose_place_attachment`` residual, and is intended for scene-graph</span>
<span class="sd">    style experiments where places may be either 1D (topological) or</span>
<span class="sd">    3D (metric positions).</span>

<span class="sd">    :param pose_id: Node id of the SE(3) pose variable.</span>
<span class="sd">    :param place_id: Node id of the place variable. The underlying state</span>
<span class="sd">        dimension is inferred at runtime from the factor graph (for</span>
<span class="sd">        example, 1 for ``place1d`` or 3 for ``place3d``).</span>
<span class="sd">    :param coord_index: Index of the pose coordinate to tie to the place</span>
<span class="sd">        (typically 0 for x, 1 for y, etc.). Defaults to 0.</span>
<span class="sd">    :param sigma: Optional noise standard deviation. If ``None``, falls</span>
<span class="sd">        back to :attr:`SceneGraphNoiseConfig.pose_place_sigma`.</span>
<span class="sd">    :return: Integer factor id of the created attachment constraint.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Infer place dimensionality from the underlying variable.</span>
    <span class="n">place_nid</span> <span class="o">=</span> <span class="n">NodeId</span><span class="p">(</span><span class="n">place_id</span><span class="p">)</span>
    <span class="n">place_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">fg</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">place_nid</span><span class="p">]</span>
    <span class="n">place_dim_val</span> <span class="o">=</span> <span class="n">place_var</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">pose_dim</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">place_dim</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">place_dim_val</span><span class="p">)</span>
    <span class="n">pose_coord_index</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coord_index</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sigma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="o">.</span><span class="n">pose_place_sigma</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">sigma_to_weight</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>

    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;pose_dim&quot;</span><span class="p">:</span> <span class="n">pose_dim</span><span class="p">,</span>
        <span class="s2">&quot;place_dim&quot;</span><span class="p">:</span> <span class="n">place_dim</span><span class="p">,</span>
        <span class="s2">&quot;pose_coord_index&quot;</span><span class="p">:</span> <span class="n">pose_coord_index</span><span class="p">,</span>
        <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="n">weight</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">remembered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remember_factor</span><span class="p">(</span>
        <span class="n">f_type</span><span class="o">=</span><span class="s2">&quot;pose_place_attachment&quot;</span><span class="p">,</span>
        <span class="n">var_ids</span><span class="o">=</span><span class="p">(</span><span class="n">pose_id</span><span class="p">,</span> <span class="n">place_id</span><span class="p">),</span>
        <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
        <span class="n">relation</span><span class="o">=</span><span class="s2">&quot;pose-place&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_template_enabled</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assign_factor_slot</span><span class="p">(</span><span class="s2">&quot;pose_place_attachment&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">pose_id</span><span class="p">,</span> <span class="n">place_id</span><span class="p">),</span> <span class="n">params</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">remembered</span><span class="p">)</span>

    <span class="n">fid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">add_factor</span><span class="p">(</span>
        <span class="s2">&quot;pose_place_attachment&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="n">pose_id</span><span class="p">,</span> <span class="n">place_id</span><span class="p">),</span>
        <span class="n">params</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.scene_graph.SceneGraphWorld.add_pose_landmark_bearing" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_pose_landmark_bearing</span><span class="p">(</span><span class="n">pose_id</span><span class="p">,</span> <span class="n">landmark_id</span><span class="p">,</span> <span class="n">bearing</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Add a bearing-only constraint from pose to landmark.</p>
<p>:param pose_id: Node id of the SE(3) pose variable.
:param landmark_id: Node id of the 3D landmark variable.
:param bearing: Iterable of length 3 giving the bearing vector in the
    pose frame (will be normalized internally).
:param sigma: Optional noise standard deviation. If <code>None</code>,
    :attr:<code>SceneGraphNoiseConfig.pose_landmark_bearing_sigma</code> is used.
:return: Integer factor id of the created bearing constraint.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_pose_landmark_bearing</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">pose_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">landmark_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">bearing</span><span class="p">,</span>
    <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add a bearing-only constraint from pose to landmark.</span>

<span class="sd">    :param pose_id: Node id of the SE(3) pose variable.</span>
<span class="sd">    :param landmark_id: Node id of the 3D landmark variable.</span>
<span class="sd">    :param bearing: Iterable of length 3 giving the bearing vector in the</span>
<span class="sd">        pose frame (will be normalized internally).</span>
<span class="sd">    :param sigma: Optional noise standard deviation. If ``None``,</span>
<span class="sd">        :attr:`SceneGraphNoiseConfig.pose_landmark_bearing_sigma` is used.</span>
<span class="sd">    :return: Integer factor id of the created bearing constraint.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bearing</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">b</span> <span class="o">/</span> <span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sigma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="o">.</span><span class="n">pose_landmark_bearing_sigma</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">sigma_to_weight</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>

    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;bearing_meas&quot;</span><span class="p">:</span> <span class="n">b</span><span class="p">,</span>
        <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="n">weight</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">remembered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remember_factor</span><span class="p">(</span>
        <span class="n">f_type</span><span class="o">=</span><span class="s2">&quot;pose_landmark_bearing&quot;</span><span class="p">,</span>
        <span class="n">var_ids</span><span class="o">=</span><span class="p">(</span><span class="n">pose_id</span><span class="p">,</span> <span class="n">landmark_id</span><span class="p">),</span>
        <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
        <span class="n">relation</span><span class="o">=</span><span class="s2">&quot;factor:pose_landmark_bearing&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_template_enabled</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assign_factor_slot</span><span class="p">(</span><span class="s2">&quot;pose_landmark_bearing&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">pose_id</span><span class="p">,</span> <span class="n">landmark_id</span><span class="p">),</span> <span class="n">params</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">remembered</span><span class="p">)</span>

    <span class="n">fid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">add_factor</span><span class="p">(</span>
        <span class="s2">&quot;pose_landmark_bearing&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="n">pose_id</span><span class="p">,</span> <span class="n">landmark_id</span><span class="p">),</span>
        <span class="n">params</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.scene_graph.SceneGraphWorld.add_pose_landmark_relative" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_pose_landmark_relative</span><span class="p">(</span><span class="n">pose_id</span><span class="p">,</span> <span class="n">landmark_id</span><span class="p">,</span> <span class="n">measurement</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Add a relative measurement between a pose and a 3D landmark.</p>
<p>The measurement is expressed in the pose frame.</p>
<p>:param pose_id: Node id of the SE(3) pose variable.
:param landmark_id: Node id of the 3D landmark variable.
:param measurement: Iterable of length 3 giving the expected landmark
    position in the pose frame.
:param sigma: Optional noise standard deviation. If <code>None</code>,
    :attr:<code>SceneGraphNoiseConfig.pose_landmark_sigma</code> is used.
:return: Integer factor id of the created relative landmark constraint.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_pose_landmark_relative</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">pose_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">landmark_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">measurement</span><span class="p">,</span>
    <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add a relative measurement between a pose and a 3D landmark.</span>

<span class="sd">    The measurement is expressed in the pose frame.</span>

<span class="sd">    :param pose_id: Node id of the SE(3) pose variable.</span>
<span class="sd">    :param landmark_id: Node id of the 3D landmark variable.</span>
<span class="sd">    :param measurement: Iterable of length 3 giving the expected landmark</span>
<span class="sd">        position in the pose frame.</span>
<span class="sd">    :param sigma: Optional noise standard deviation. If ``None``,</span>
<span class="sd">        :attr:`SceneGraphNoiseConfig.pose_landmark_sigma` is used.</span>
<span class="sd">    :return: Integer factor id of the created relative landmark constraint.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">meas</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">measurement</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,)</span>

    <span class="k">if</span> <span class="n">sigma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="o">.</span><span class="n">pose_landmark_sigma</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">sigma_to_weight</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>

    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;measurement&quot;</span><span class="p">:</span> <span class="n">meas</span><span class="p">,</span>
        <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="n">weight</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">remembered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remember_factor</span><span class="p">(</span>
        <span class="n">f_type</span><span class="o">=</span><span class="s2">&quot;pose_landmark_relative&quot;</span><span class="p">,</span>
        <span class="n">var_ids</span><span class="o">=</span><span class="p">(</span><span class="n">pose_id</span><span class="p">,</span> <span class="n">landmark_id</span><span class="p">),</span>
        <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
        <span class="n">relation</span><span class="o">=</span><span class="s2">&quot;factor:pose_landmark_relative&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_template_enabled</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assign_factor_slot</span><span class="p">(</span><span class="s2">&quot;pose_landmark_relative&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">pose_id</span><span class="p">,</span> <span class="n">landmark_id</span><span class="p">),</span> <span class="n">params</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">remembered</span><span class="p">)</span>

    <span class="n">fid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">add_factor</span><span class="p">(</span>
        <span class="s2">&quot;pose_landmark_relative&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="n">pose_id</span><span class="p">,</span> <span class="n">landmark_id</span><span class="p">),</span>
        <span class="n">params</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.scene_graph.SceneGraphWorld.add_pose_se3" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_pose_se3</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Add a generic SE(3) pose variable.</p>
<p>:param value: Length-6 array-like se(3) vector [tx, ty, tz, rx, ry, rz].
:return: Integer node id of the created pose variable.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_pose_se3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add a generic SE(3) pose variable.</span>

<span class="sd">    :param value: Length-6 array-like se(3) vector [tx, ty, tz, rx, ry, rz].</span>
<span class="sd">    :return: Integer node id of the created pose variable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_template_enabled</span><span class="p">:</span>
        <span class="n">nid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_assign_var_slot</span><span class="p">(</span><span class="s2">&quot;pose_se3&quot;</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;pose_se3&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_remember_node</span><span class="p">(</span><span class="n">nid</span><span class="p">,</span> <span class="s2">&quot;pose_se3&quot;</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">nid</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.scene_graph.SceneGraphWorld.add_pose_voxel_point" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_pose_voxel_point</span><span class="p">(</span><span class="n">pose_id</span><span class="p">,</span> <span class="n">voxel_id</span><span class="p">,</span> <span class="n">point_meas</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Constrain a voxel cell to align with a point measurement seen from a pose.</p>
<p>:param pose_id: Node id of the SE(3) pose variable.
:param voxel_id: Node id of the voxel cell variable.
:param point_meas: Iterable of length 3 giving a point in the pose
    frame (for example, a back-projected depth sample).
:param sigma: Optional noise standard deviation. If <code>None</code>,
    :attr:<code>SceneGraphNoiseConfig.pose_voxel_point_sigma</code> is used.
:return: Integer factor id of the created voxel-point constraint.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_pose_voxel_point</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">pose_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">voxel_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">point_meas</span><span class="p">,</span>
    <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Constrain a voxel cell to align with a point measurement seen from a pose.</span>

<span class="sd">    :param pose_id: Node id of the SE(3) pose variable.</span>
<span class="sd">    :param voxel_id: Node id of the voxel cell variable.</span>
<span class="sd">    :param point_meas: Iterable of length 3 giving a point in the pose</span>
<span class="sd">        frame (for example, a back-projected depth sample).</span>
<span class="sd">    :param sigma: Optional noise standard deviation. If ``None``,</span>
<span class="sd">        :attr:`SceneGraphNoiseConfig.pose_voxel_point_sigma` is used.</span>
<span class="sd">    :return: Integer factor id of the created voxel-point constraint.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">point_meas</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">point_meas</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,)</span>

    <span class="k">if</span> <span class="n">sigma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="o">.</span><span class="n">pose_voxel_point_sigma</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">sigma_to_weight</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>

    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;point_meas&quot;</span><span class="p">:</span> <span class="n">point_meas</span><span class="p">,</span>
        <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="n">weight</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">remembered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remember_factor</span><span class="p">(</span>
        <span class="n">f_type</span><span class="o">=</span><span class="s2">&quot;pose_voxel_point&quot;</span><span class="p">,</span>
        <span class="n">var_ids</span><span class="o">=</span><span class="p">(</span><span class="n">pose_id</span><span class="p">,</span> <span class="n">voxel_id</span><span class="p">),</span>
        <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
        <span class="n">relation</span><span class="o">=</span><span class="s2">&quot;factor:pose_voxel_point&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_template_enabled</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assign_factor_slot</span><span class="p">(</span><span class="s2">&quot;pose_voxel_point&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">pose_id</span><span class="p">,</span> <span class="n">voxel_id</span><span class="p">),</span> <span class="n">params</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">remembered</span><span class="p">)</span>

    <span class="n">fid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">add_factor</span><span class="p">(</span>
        <span class="s2">&quot;pose_voxel_point&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="n">pose_id</span><span class="p">,</span> <span class="n">voxel_id</span><span class="p">),</span>
        <span class="n">params</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.scene_graph.SceneGraphWorld.add_range_measurement" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_range_measurement</span><span class="p">(</span><span class="n">pose_nid</span><span class="p">,</span> <span class="n">target_nid</span><span class="p">,</span> <span class="n">measured_range</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Add a range-only sensor factor between a pose and a 3D target.</p>
<p>This creates a factor of type <code>"range"</code> whose residual is:</p>
<pre><code>r = ||target - pose|| - measured_range
</code></pre>
<p>The underlying residual is implemented in <code>slam.measurements.range_residual</code>.</p>
<p>:param pose_nid: NodeId of the pose (pose_se3) variable.
:param target_nid: NodeId of the target variable (e.g. place3d, voxel_cell, object3d).
:param measured_range: Observed distance (same units as world coordinates).
:param sigma: Optional standard deviation of the measurement noise. If provided,
              it will be converted to a weight as 1 / sigma^2.
:param weight: Optional explicit weight. If both <code>sigma</code> and <code>weight</code> are given,
               <code>weight</code> takes precedence.
:return: Integer factor id of the created range factor.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_range_measurement</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">pose_nid</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">target_nid</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">measured_range</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">weight</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add a range-only sensor factor between a pose and a 3D target.</span>

<span class="sd">    This creates a factor of type ``&quot;range&quot;`` whose residual is:</span>

<span class="sd">        r = ||target - pose|| - measured_range</span>

<span class="sd">    The underlying residual is implemented in ``slam.measurements.range_residual``.</span>

<span class="sd">    :param pose_nid: NodeId of the pose (pose_se3) variable.</span>
<span class="sd">    :param target_nid: NodeId of the target variable (e.g. place3d, voxel_cell, object3d).</span>
<span class="sd">    :param measured_range: Observed distance (same units as world coordinates).</span>
<span class="sd">    :param sigma: Optional standard deviation of the measurement noise. If provided,</span>
<span class="sd">                  it will be converted to a weight as 1 / sigma^2.</span>
<span class="sd">    :param weight: Optional explicit weight. If both ``sigma`` and ``weight`` are given,</span>
<span class="sd">                   ``weight`` takes precedence.</span>
<span class="sd">    :return: Integer factor id of the created range factor.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">sigma</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">sigma_to_weight</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="n">meas</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">measured_range</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;range&quot;</span><span class="p">:</span> <span class="n">meas</span><span class="p">,</span> <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="n">w</span><span class="p">}</span>
    <span class="n">remembered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remember_factor</span><span class="p">(</span>
        <span class="n">f_type</span><span class="o">=</span><span class="s2">&quot;range&quot;</span><span class="p">,</span>
        <span class="n">var_ids</span><span class="o">=</span><span class="p">(</span><span class="n">pose_nid</span><span class="p">,</span> <span class="n">target_nid</span><span class="p">),</span>
        <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
        <span class="n">relation</span><span class="o">=</span><span class="s2">&quot;factor:range&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_template_enabled</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assign_factor_slot</span><span class="p">(</span><span class="s2">&quot;range&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">pose_nid</span><span class="p">,</span> <span class="n">target_nid</span><span class="p">),</span> <span class="n">params</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">remembered</span><span class="p">)</span>

    <span class="n">fid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">add_factor</span><span class="p">(</span>
        <span class="s2">&quot;range&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="n">pose_nid</span><span class="p">,</span> <span class="n">target_nid</span><span class="p">),</span>
        <span class="n">params</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.scene_graph.SceneGraphWorld.add_room" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_room</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">center</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Add a 3D room node (R^3 center) with a semantic name.</p>
<p>This is a thin wrapper around a Euclidean variable, but exposes a
room-level abstraction for dynamic scene-graph experiments.</p>
<p>:param name: Identifier for the room (for example, <code>"room_A"</code>).
:param center: Iterable of length 3 giving the approximate room
    centroid in world coordinates.
:return: Integer node id of the created room variable.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_room</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">center</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add a 3D room node (R^3 center) with a semantic name.</span>

<span class="sd">    This is a thin wrapper around a Euclidean variable, but exposes a</span>
<span class="sd">    room-level abstraction for dynamic scene-graph experiments.</span>

<span class="sd">    :param name: Identifier for the room (for example, ``&quot;room_A&quot;``).</span>
<span class="sd">    :param center: Iterable of length 3 giving the approximate room</span>
<span class="sd">        centroid in world coordinates.</span>
<span class="sd">    :return: Integer node id of the created room variable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_template_enabled</span><span class="p">:</span>
        <span class="n">nid_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_assign_var_slot</span><span class="p">(</span><span class="s2">&quot;room3d&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nid_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;room3d&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_remember_node</span><span class="p">(</span><span class="n">nid_int</span><span class="p">,</span> <span class="s2">&quot;room3d&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">room_nodes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">nid_int</span>
    <span class="k">return</span> <span class="n">nid_int</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.scene_graph.SceneGraphWorld.add_room1d" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_room1d</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Add a 1D 'room' variable (just a scalar, wrapped as a length-1 vector).</p>
<p>The room is stored in :attr:<code>room_nodes</code> using an auto-generated
string key of the form <code>"room1d_{k}"</code> where <code>k</code> is the current
number of rooms.</p>
<p>:param x: 1D coordinate, shape <code>(1,)</code> or a scalar float.
:return: Integer node id of the created room variable.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_room1d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add a 1D &#39;room&#39; variable (just a scalar, wrapped as a length-1 vector).</span>

<span class="sd">    The room is stored in :attr:`room_nodes` using an auto-generated</span>
<span class="sd">    string key of the form ``&quot;room1d_{k}&quot;`` where ``k`` is the current</span>
<span class="sd">    number of rooms.</span>

<span class="sd">    :param x: 1D coordinate, shape ``(1,)`` or a scalar float.</span>
<span class="sd">    :return: Integer node id of the created room variable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Normalize to a length-1 float32 vector.</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;ndim&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,))</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_template_enabled</span><span class="p">:</span>
        <span class="n">nid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_assign_var_slot</span><span class="p">(</span><span class="s2">&quot;room1d&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;room1d&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>  <span class="c1"># after normalizing x</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_remember_node</span><span class="p">(</span><span class="n">nid</span><span class="p">,</span> <span class="s2">&quot;room1d&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;room1d_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">room_nodes</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">room_nodes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">nid</span>
    <span class="k">return</span> <span class="n">nid</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.scene_graph.SceneGraphWorld.add_room_place_edge" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_room_place_edge</span><span class="p">(</span><span class="n">room_id</span><span class="p">,</span> <span class="n">place_id</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Register a semantic edge between a room node and a place node.</p>
<p>This helper is intentionally lightweight: it does <em>not</em> add a numeric
factor to the underlying factor graph. Instead it records topological
connectivity for visualization and higher-level reasoning, similar to
classic dynamic scene-graph frameworks.</p>
<p>:param room_id: Integer node id of the room variable.
:param place_id: Integer node id of the place variable.
:return: None.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_room_place_edge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">room_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">place_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Register a semantic edge between a room node and a place node.</span>

<span class="sd">    This helper is intentionally lightweight: it does *not* add a numeric</span>
<span class="sd">    factor to the underlying factor graph. Instead it records topological</span>
<span class="sd">    connectivity for visualization and higher-level reasoning, similar to</span>
<span class="sd">    classic dynamic scene-graph frameworks.</span>

<span class="sd">    :param room_id: Integer node id of the room variable.</span>
<span class="sd">    :param place_id: Integer node id of the place variable.</span>
<span class="sd">    :return: None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">room_place_edges</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">room_id</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">place_id</span><span class="p">)))</span>
    <span class="c1"># Also register in the SceneGraph&#39;s factor memory for visualization.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_remember_factor</span><span class="p">(</span>
        <span class="n">f_type</span><span class="o">=</span><span class="s2">&quot;semantic_room_place&quot;</span><span class="p">,</span>
        <span class="n">var_ids</span><span class="o">=</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">room_id</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">place_id</span><span class="p">)),</span>
        <span class="n">params</span><span class="o">=</span><span class="p">{},</span>
        <span class="n">relation</span><span class="o">=</span><span class="s2">&quot;room-place&quot;</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.scene_graph.SceneGraphWorld.add_temporal_smoothness" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_temporal_smoothness</span><span class="p">(</span><span class="n">pose_id_t</span><span class="p">,</span> <span class="n">pose_id_t1</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Enforce smoothness between successive poses.</p>
<p>:param pose_id_t: Node id of the pose at time <code>t</code>.
:param pose_id_t1: Node id of the pose at time <code>t+1</code>.
:param sigma: Optional standard deviation of the pose difference; a
    larger value gives weaker smoothness. If <code>None</code>,
    :attr:<code>SceneGraphNoiseConfig.smooth_pose_sigma</code> is used.
:return: Integer factor id of the created smoothness constraint.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_temporal_smoothness</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">pose_id_t</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">pose_id_t1</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Enforce smoothness between successive poses.</span>

<span class="sd">    :param pose_id_t: Node id of the pose at time ``t``.</span>
<span class="sd">    :param pose_id_t1: Node id of the pose at time ``t+1``.</span>
<span class="sd">    :param sigma: Optional standard deviation of the pose difference; a</span>
<span class="sd">        larger value gives weaker smoothness. If ``None``,</span>
<span class="sd">        :attr:`SceneGraphNoiseConfig.smooth_pose_sigma` is used.</span>
<span class="sd">    :return: Integer factor id of the created smoothness constraint.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">sigma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="o">.</span><span class="n">smooth_pose_sigma</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">sigma_to_weight</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>

    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="n">weight</span><span class="p">}</span>
    <span class="n">remembered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remember_factor</span><span class="p">(</span>
        <span class="n">f_type</span><span class="o">=</span><span class="s2">&quot;pose_temporal_smoothness&quot;</span><span class="p">,</span>
        <span class="n">var_ids</span><span class="o">=</span><span class="p">(</span><span class="n">pose_id_t</span><span class="p">,</span> <span class="n">pose_id_t1</span><span class="p">),</span>
        <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
        <span class="n">relation</span><span class="o">=</span><span class="s2">&quot;factor:pose_temporal_smoothness&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_template_enabled</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assign_factor_slot</span><span class="p">(</span><span class="s2">&quot;pose_temporal_smoothness&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">pose_id_t</span><span class="p">,</span> <span class="n">pose_id_t1</span><span class="p">),</span> <span class="n">params</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">remembered</span><span class="p">)</span>

    <span class="n">fid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">add_factor</span><span class="p">(</span>
        <span class="s2">&quot;pose_temporal_smoothness&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="n">pose_id_t</span><span class="p">,</span> <span class="n">pose_id_t1</span><span class="p">),</span>
        <span class="n">params</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.scene_graph.SceneGraphWorld.add_voxel_cell" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_voxel_cell</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Add a voxel cell center in world coordinates (R^3).</p>
<p>:param xyz: Iterable of length 3 giving the voxel center position.
:return: Integer node id of the created voxel variable.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_voxel_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xyz</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add a voxel cell center in world coordinates (R^3).</span>

<span class="sd">    :param xyz: Iterable of length 3 giving the voxel center position.</span>
<span class="sd">    :return: Integer node id of the created voxel variable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_template_enabled</span><span class="p">:</span>
        <span class="n">nid_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_assign_var_slot</span><span class="p">(</span><span class="s2">&quot;voxel_cell&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nid_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;voxel_cell&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_remember_node</span><span class="p">(</span><span class="n">nid_int</span><span class="p">,</span> <span class="s2">&quot;voxel_cell&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">nid_int</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.scene_graph.SceneGraphWorld.add_voxel_point_observation" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_voxel_point_observation</span><span class="p">(</span><span class="n">voxel_id</span><span class="p">,</span> <span class="n">point_world</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Add an observation tying a voxel center to a 3D point in world coordinates.</p>
<p>:param voxel_id: Node id of the voxel cell variable.
:param point_world: Iterable of length 3 giving a world-frame point
    (for example, from fused depth or a point cloud).
:param sigma: Optional noise standard deviation. If <code>None</code>,
    :attr:<code>SceneGraphNoiseConfig.voxel_point_obs_sigma</code> is used.
:return: Integer factor id of the created observation constraint.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_voxel_point_observation</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">voxel_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">point_world</span><span class="p">,</span>
    <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add an observation tying a voxel center to a 3D point in world coordinates.</span>

<span class="sd">    :param voxel_id: Node id of the voxel cell variable.</span>
<span class="sd">    :param point_world: Iterable of length 3 giving a world-frame point</span>
<span class="sd">        (for example, from fused depth or a point cloud).</span>
<span class="sd">    :param sigma: Optional noise standard deviation. If ``None``,</span>
<span class="sd">        :attr:`SceneGraphNoiseConfig.voxel_point_obs_sigma` is used.</span>
<span class="sd">    :return: Integer factor id of the created observation constraint.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">point_world</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">point_world</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,)</span>

    <span class="k">if</span> <span class="n">sigma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="o">.</span><span class="n">voxel_point_obs_sigma</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">sigma_to_weight</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>

    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;point_world&quot;</span><span class="p">:</span> <span class="n">point_world</span><span class="p">,</span>
        <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="n">weight</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">remembered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remember_factor</span><span class="p">(</span>
        <span class="n">f_type</span><span class="o">=</span><span class="s2">&quot;voxel_point_obs&quot;</span><span class="p">,</span>
        <span class="n">var_ids</span><span class="o">=</span><span class="p">(</span><span class="n">voxel_id</span><span class="p">,),</span>
        <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
        <span class="n">relation</span><span class="o">=</span><span class="s2">&quot;factor:voxel_point_obs&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_template_enabled</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assign_factor_slot</span><span class="p">(</span><span class="s2">&quot;voxel_point_obs&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">voxel_id</span><span class="p">,),</span> <span class="n">params</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">remembered</span><span class="p">)</span>

    <span class="n">fid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">add_factor</span><span class="p">(</span>
        <span class="s2">&quot;voxel_point_obs&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="n">voxel_id</span><span class="p">,),</span>
        <span class="n">params</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.scene_graph.SceneGraphWorld.add_voxel_smoothness" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_voxel_smoothness</span><span class="p">(</span><span class="n">voxel_i_id</span><span class="p">,</span> <span class="n">voxel_j_id</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Enforce grid-like spacing between two voxel centers.</p>
<p>:param voxel_i_id: Node id of the first voxel cell.
:param voxel_j_id: Node id of the second voxel cell.
:param offset: Iterable of length 3 giving the expected vector from
    voxel <code>i</code> to voxel <code>j</code> (for example, <code>[dx, 0, 0]</code>).
:param sigma: Optional noise standard deviation. If <code>None</code>,
    :attr:<code>SceneGraphNoiseConfig.voxel_smoothness_sigma</code> is used.
:return: Integer factor id of the created smoothness constraint.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_voxel_smoothness</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">voxel_i_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">voxel_j_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">offset</span><span class="p">,</span>
    <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Enforce grid-like spacing between two voxel centers.</span>

<span class="sd">    :param voxel_i_id: Node id of the first voxel cell.</span>
<span class="sd">    :param voxel_j_id: Node id of the second voxel cell.</span>
<span class="sd">    :param offset: Iterable of length 3 giving the expected vector from</span>
<span class="sd">        voxel ``i`` to voxel ``j`` (for example, ``[dx, 0, 0]``).</span>
<span class="sd">    :param sigma: Optional noise standard deviation. If ``None``,</span>
<span class="sd">        :attr:`SceneGraphNoiseConfig.voxel_smoothness_sigma` is used.</span>
<span class="sd">    :return: Integer factor id of the created smoothness constraint.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,)</span>

    <span class="k">if</span> <span class="n">sigma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="o">.</span><span class="n">voxel_smoothness_sigma</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">sigma_to_weight</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>

    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="n">offset</span><span class="p">,</span>
        <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="n">weight</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">remembered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remember_factor</span><span class="p">(</span>
        <span class="n">f_type</span><span class="o">=</span><span class="s2">&quot;voxel_smoothness&quot;</span><span class="p">,</span>
        <span class="n">var_ids</span><span class="o">=</span><span class="p">(</span><span class="n">voxel_i_id</span><span class="p">,</span> <span class="n">voxel_j_id</span><span class="p">),</span>
        <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
        <span class="n">relation</span><span class="o">=</span><span class="s2">&quot;factor:voxel_smoothness&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_template_enabled</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assign_factor_slot</span><span class="p">(</span><span class="s2">&quot;voxel_smoothness&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">voxel_i_id</span><span class="p">,</span> <span class="n">voxel_j_id</span><span class="p">),</span> <span class="n">params</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">remembered</span><span class="p">)</span>

    <span class="n">fid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">add_factor</span><span class="p">(</span>
        <span class="s2">&quot;voxel_smoothness&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="n">voxel_i_id</span><span class="p">,</span> <span class="n">voxel_j_id</span><span class="p">),</span>
        <span class="n">params</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.scene_graph.SceneGraphWorld.attach_object_to_pose" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">attach_object_to_pose</span><span class="p">(</span><span class="n">pose_id</span><span class="p">,</span> <span class="n">obj_id</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Attach an object to a pose with an optional 3D offset.</p>
<p>:param pose_id: Node id of the SE(3) pose variable.
:param obj_id: Node id of the 3D object variable.
:param offset: Iterable of length 3 giving the offset from the pose
    frame to the object in pose coordinates.
:param sigma: Optional noise standard deviation. If <code>None</code>, falls
    back to :attr:<code>SceneGraphNoiseConfig.object_at_pose_sigma</code>.
:return: Integer factor id of the created object-at-pose constraint.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">attach_object_to_pose</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">pose_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">obj_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">offset</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
    <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Attach an object to a pose with an optional 3D offset.</span>

<span class="sd">    :param pose_id: Node id of the SE(3) pose variable.</span>
<span class="sd">    :param obj_id: Node id of the 3D object variable.</span>
<span class="sd">    :param offset: Iterable of length 3 giving the offset from the pose</span>
<span class="sd">        frame to the object in pose coordinates.</span>
<span class="sd">    :param sigma: Optional noise standard deviation. If ``None``, falls</span>
<span class="sd">        back to :attr:`SceneGraphNoiseConfig.object_at_pose_sigma`.</span>
<span class="sd">    :return: Integer factor id of the created object-at-pose constraint.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pose_dim</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">obj_dim</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">offset_arr</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,)</span>

    <span class="k">if</span> <span class="n">sigma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="o">.</span><span class="n">object_at_pose_sigma</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">sigma_to_weight</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>

    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;pose_dim&quot;</span><span class="p">:</span> <span class="n">pose_dim</span><span class="p">,</span>
        <span class="s2">&quot;obj_dim&quot;</span><span class="p">:</span> <span class="n">obj_dim</span><span class="p">,</span>
        <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="n">offset_arr</span><span class="p">,</span>
        <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="n">weight</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">remembered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remember_factor</span><span class="p">(</span>
        <span class="n">f_type</span><span class="o">=</span><span class="s2">&quot;object_at_pose&quot;</span><span class="p">,</span>
        <span class="n">var_ids</span><span class="o">=</span><span class="p">(</span><span class="n">pose_id</span><span class="p">,</span> <span class="n">obj_id</span><span class="p">),</span>
        <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
        <span class="n">relation</span><span class="o">=</span><span class="s2">&quot;factor:object_at_pose&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_template_enabled</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assign_factor_slot</span><span class="p">(</span><span class="s2">&quot;object_at_pose&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">pose_id</span><span class="p">,</span> <span class="n">obj_id</span><span class="p">),</span> <span class="n">params</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">remembered</span><span class="p">)</span>

    <span class="n">fid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">add_factor</span><span class="p">(</span>
        <span class="s2">&quot;object_at_pose&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="n">pose_id</span><span class="p">,</span> <span class="n">obj_id</span><span class="p">),</span>
        <span class="n">params</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.scene_graph.SceneGraphWorld.attach_pose_to_place_x" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">attach_pose_to_place_x</span><span class="p">(</span><span class="n">pose_id</span><span class="p">,</span> <span class="n">place_id</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Attach a pose to a 1D place along the x-coordinate.</p>
<p>This is a low-level helper that assumes a 6D pose and 1D place.</p>
<p>:param pose_id: Node id of the SE(3) pose variable.
:param place_id: Node id of the 1D place variable.
:return: Integer factor id of the created attachment constraint.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">attach_pose_to_place_x</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pose_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">place_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Attach a pose to a 1D place along the x-coordinate.</span>

<span class="sd">    This is a low-level helper that assumes a 6D pose and 1D place.</span>

<span class="sd">    :param pose_id: Node id of the SE(3) pose variable.</span>
<span class="sd">    :param place_id: Node id of the 1D place variable.</span>
<span class="sd">    :return: Integer factor id of the created attachment constraint.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pose_dim</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">place_dim</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">pose_coord_index</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="o">.</span><span class="n">pose_place_sigma</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">sigma_to_weight</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>

    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;pose_dim&quot;</span><span class="p">:</span> <span class="n">pose_dim</span><span class="p">,</span>
        <span class="s2">&quot;place_dim&quot;</span><span class="p">:</span> <span class="n">place_dim</span><span class="p">,</span>
        <span class="s2">&quot;pose_coord_index&quot;</span><span class="p">:</span> <span class="n">pose_coord_index</span><span class="p">,</span>
        <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="n">weight</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">remembered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remember_factor</span><span class="p">(</span>
        <span class="n">f_type</span><span class="o">=</span><span class="s2">&quot;pose_place_attachment&quot;</span><span class="p">,</span>
        <span class="n">var_ids</span><span class="o">=</span><span class="p">(</span><span class="n">pose_id</span><span class="p">,</span> <span class="n">place_id</span><span class="p">),</span>
        <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
        <span class="n">relation</span><span class="o">=</span><span class="s2">&quot;pose-place&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_template_enabled</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assign_factor_slot</span><span class="p">(</span><span class="s2">&quot;pose_place_attachment&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">pose_id</span><span class="p">,</span> <span class="n">place_id</span><span class="p">),</span> <span class="n">params</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">remembered</span><span class="p">)</span>

    <span class="n">fid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">add_factor</span><span class="p">(</span>
        <span class="s2">&quot;pose_place_attachment&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="n">pose_id</span><span class="p">,</span> <span class="n">place_id</span><span class="p">),</span>
        <span class="n">params</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.scene_graph.SceneGraphWorld.attach_pose_to_room_x" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">attach_pose_to_room_x</span><span class="p">(</span><span class="n">pose_id</span><span class="p">,</span> <span class="n">room_id</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Attach a pose to a 1D room along the x-coordinate.</p>
<p>This is analogous to :meth:<code>attach_pose_to_place_x</code> but uses a room
node instead of a place node.</p>
<p>:param pose_id: Node id of the SE(3) pose variable.
:param room_id: Node id of the 1D room variable.
:return: Integer factor id of the created attachment constraint.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span>
<span class="normal">955</span>
<span class="normal">956</span>
<span class="normal">957</span>
<span class="normal">958</span>
<span class="normal">959</span>
<span class="normal">960</span>
<span class="normal">961</span>
<span class="normal">962</span>
<span class="normal">963</span>
<span class="normal">964</span>
<span class="normal">965</span>
<span class="normal">966</span>
<span class="normal">967</span>
<span class="normal">968</span>
<span class="normal">969</span>
<span class="normal">970</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">attach_pose_to_room_x</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pose_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">room_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Attach a pose to a 1D room along the x-coordinate.</span>

<span class="sd">    This is analogous to :meth:`attach_pose_to_place_x` but uses a room</span>
<span class="sd">    node instead of a place node.</span>

<span class="sd">    :param pose_id: Node id of the SE(3) pose variable.</span>
<span class="sd">    :param room_id: Node id of the 1D room variable.</span>
<span class="sd">    :return: Integer factor id of the created attachment constraint.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pose_dim</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">place_dim</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">pose_coord_index</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="o">.</span><span class="n">pose_place_sigma</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">sigma_to_weight</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>

    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;pose_dim&quot;</span><span class="p">:</span> <span class="n">pose_dim</span><span class="p">,</span>
        <span class="s2">&quot;place_dim&quot;</span><span class="p">:</span> <span class="n">place_dim</span><span class="p">,</span>
        <span class="s2">&quot;pose_coord_index&quot;</span><span class="p">:</span> <span class="n">pose_coord_index</span><span class="p">,</span>
        <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="n">weight</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">remembered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remember_factor</span><span class="p">(</span>
        <span class="n">f_type</span><span class="o">=</span><span class="s2">&quot;pose_place_attachment&quot;</span><span class="p">,</span>
        <span class="n">var_ids</span><span class="o">=</span><span class="p">(</span><span class="n">pose_id</span><span class="p">,</span> <span class="n">room_id</span><span class="p">),</span>
        <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
        <span class="n">relation</span><span class="o">=</span><span class="s2">&quot;pose-place&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_template_enabled</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assign_factor_slot</span><span class="p">(</span><span class="s2">&quot;pose_place_attachment&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">pose_id</span><span class="p">,</span> <span class="n">room_id</span><span class="p">),</span> <span class="n">params</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">remembered</span><span class="p">)</span>

    <span class="n">fid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">add_factor</span><span class="p">(</span>
        <span class="s2">&quot;pose_place_attachment&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="n">pose_id</span><span class="p">,</span> <span class="n">room_id</span><span class="p">),</span>
        <span class="n">params</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.scene_graph.SceneGraphWorld.dump_state" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">dump_state</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Return a snapshot of all variable values in the world.</p>
<p>:return: Dictionary mapping integer node ids to JAX arrays of values.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1593</span>
<span class="normal">1594</span>
<span class="normal">1595</span>
<span class="normal">1596</span>
<span class="normal">1597</span>
<span class="normal">1598</span>
<span class="normal">1599</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">dump_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a snapshot of all variable values in the world.</span>

<span class="sd">    :return: Dictionary mapping integer node ids to JAX arrays of values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">nid</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">nid</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.scene_graph.SceneGraphWorld.enable_active_template" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">enable_active_template</span><span class="p">(</span><span class="n">template</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Enable fixed-capacity active-template mode.</p>
<p>In this mode, SceneGraphWorld retains full persistent memory, but
only a bounded active subset is mapped into the WorldModel slots.
This enables a single stable JIT compilation and constant-latency solves.</p>
<p>:param template: ActiveWindowTemplate instance (from world.model).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">enable_active_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Enable fixed-capacity active-template mode.</span>

<span class="sd">    In this mode, SceneGraphWorld retains full persistent memory, but</span>
<span class="sd">    only a bounded active subset is mapped into the WorldModel slots.</span>
<span class="sd">    This enables a single stable JIT compilation and constant-latency solves.</span>

<span class="sd">    :param template: ActiveWindowTemplate instance (from world.model).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">init_active_template</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_active_template_enabled</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_slot_capacity</span> <span class="o">=</span> <span class="p">{</span><span class="n">vs</span><span class="o">.</span><span class="n">var_type</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">vs</span><span class="o">.</span><span class="n">count</span><span class="p">)</span> <span class="k">for</span> <span class="n">vs</span> <span class="ow">in</span> <span class="n">template</span><span class="o">.</span><span class="n">var_slots</span><span class="p">}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_factor_slot_capacity</span> <span class="o">=</span> <span class="p">{</span><span class="n">fs</span><span class="o">.</span><span class="n">factor_type</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">fs</span><span class="o">.</span><span class="n">count</span><span class="p">)</span> <span class="k">for</span> <span class="n">fs</span> <span class="ow">in</span> <span class="n">template</span><span class="o">.</span><span class="n">factor_slots</span><span class="p">}</span>

    <span class="c1"># reset assignment state (SceneGraph memory remains intact)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_slot_assign</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_slot_fifo</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_factor_slot_next</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.scene_graph.SceneGraphWorld.get_object3d" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_object3d</span><span class="p">(</span><span class="n">obj_id</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Return the current 3D position of an object.</p>
<p>:param obj_id: Integer node id of the object variable.
:return: JAX array of shape <code>(3,)</code> giving the object position.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_object3d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the current 3D position of an object.</span>

<span class="sd">    :param obj_id: Integer node id of the object variable.</span>
<span class="sd">    :return: JAX array of shape ``(3,)`` giving the object position.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">oid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">obj_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">oid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No object registered in SceneGraph memory for id=</span><span class="si">{</span><span class="n">oid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">[</span><span class="n">oid</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.scene_graph.SceneGraphWorld.get_place" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_place</span><span class="p">(</span><span class="n">place_id</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Return the current scalar value of a 1D place.</p>
<p>:param place_id: Integer node id of the place variable.
:return: Floating-point scalar position.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1581</span>
<span class="normal">1582</span>
<span class="normal">1583</span>
<span class="normal">1584</span>
<span class="normal">1585</span>
<span class="normal">1586</span>
<span class="normal">1587</span>
<span class="normal">1588</span>
<span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_place</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">place_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the current scalar value of a 1D place.</span>

<span class="sd">    :param place_id: Integer node id of the place variable.</span>
<span class="sd">    :return: Floating-point scalar position.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">place_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No place registered in SceneGraph memory for id=</span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.scene_graph.SceneGraphWorld.get_pose" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_pose</span><span class="p">(</span><span class="n">pose_id</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Return the current SE(3) pose value.</p>
<p>:param pose_id: Integer node id of the pose variable.
:return: JAX array of shape <code>(6,)</code> containing the se(3) vector.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span>
<span class="normal">1576</span>
<span class="normal">1577</span>
<span class="normal">1578</span>
<span class="normal">1579</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_pose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pose_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the current SE(3) pose value.</span>

<span class="sd">    :param pose_id: Integer node id of the pose variable.</span>
<span class="sd">    :return: JAX array of shape ``(6,)`` containing the se(3) vector.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pose_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No pose registered in SceneGraph memory for id=</span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.scene_graph.SceneGraphWorld.optimize" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">optimize</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;gn&#39;</span><span class="p">,</span> <span class="n">iters</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Run nonlinear optimization over the current factor graph.
This optimizes the current WorldModel factor graph (which may be bounded active-template or unbounded, depending on configuration).</p>
<p>:param method: Optimization method name (currently <code>"gn"</code> for
    GaussNewton).
:param iters: Maximum number of iterations to run.
:return: <code>None</code>. The internal world model state is updated in-place.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;gn&quot;</span><span class="p">,</span> <span class="n">iters</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">40</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run nonlinear optimization over the current factor graph.</span>
<span class="sd">    This optimizes the current WorldModel factor graph (which may be bounded active-template or unbounded, depending on configuration).</span>

<span class="sd">    :param method: Optimization method name (currently ``&quot;gn&quot;`` for</span>
<span class="sd">        GaussNewton).</span>
<span class="sd">    :param iters: Maximum number of iterations to run.</span>
<span class="sd">    :return: ``None``. The internal world model state is updated in-place.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">iters</span><span class="o">=</span><span class="n">iters</span><span class="p">,</span> <span class="n">damping</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">max_step_norm</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">nid</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">fg</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">nid_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nid_int</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">[</span><span class="n">nid_int</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">value</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.scene_graph.SceneGraphWorld.optimize_active_batch" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">optimize_active_batch</span><span class="p">(</span><span class="n">iters</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">damping</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Optimize only the currently active bounded FG (active-template mode).</p>
<p>:param iters: An integer representing the maximum number of iterations for an optimization
:param damping: The minimum precision for a solve</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">optimize_active_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iters</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">damping</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Optimize only the currently active bounded FG (active-template mode).</span>

<span class="sd">    :param iters: An integer representing the maximum number of iterations for an optimization</span>
<span class="sd">    :param damping: The minimum precision for a solve</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_template_enabled</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">&quot;Active-template mode not enabled. Call enable_active_template(...)&quot;</span>
        <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span>
        <span class="n">method</span><span class="o">=</span><span class="s2">&quot;gn&quot;</span><span class="p">,</span>
        <span class="n">iters</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">iters</span><span class="p">),</span>
        <span class="n">damping</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">damping</span><span class="p">),</span>
        <span class="n">max_step_norm</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Pull optimized values back into SG memory for active slot variables</span>
    <span class="k">for</span> <span class="n">nid</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">fg</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">nid_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nid_int</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">[</span><span class="n">nid_int</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">value</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.scene_graph.SceneGraphWorld.optimize_global_offline" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">optimize_global_offline</span><span class="p">(</span><span class="n">iters</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">damping</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Full batch optimization over the entire persistent SceneGraph memory.</p>
<p>:param iters: An integer representing the maximum number of iterations for an optimization
:param damping: The minimum precision for a solve</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">optimize_global_offline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iters</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">40</span><span class="p">,</span> <span class="n">damping</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Full batch optimization over the entire persistent SceneGraph memory.</span>

<span class="sd">    :param iters: An integer representing the maximum number of iterations for an optimization</span>
<span class="sd">    :param damping: The minimum precision for a solve</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">WorldModel</span><span class="p">()</span>

    <span class="c1"># Register residuals from this SceneGraphWorld</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">_residual_registry</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">tmp</span><span class="o">.</span><span class="n">register_residual</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>

    <span class="c1"># Replay variables and keep remap</span>
    <span class="n">remap</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">nid</span><span class="p">,</span> <span class="n">st</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">new_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">var_type</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
        <span class="n">remap</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">nid</span><span class="p">)]</span> <span class="o">=</span> <span class="n">new_id</span>

    <span class="c1"># Replay factors (skip semantic-only and inactive)</span>
    <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_factor_memory</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rec</span><span class="o">.</span><span class="n">active</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">rec</span><span class="o">.</span><span class="n">f_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;semantic_&quot;</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="n">mapped</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">remap</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">rec</span><span class="o">.</span><span class="n">var_ids</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">remap</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mapped</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">var_ids</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="n">tmp</span><span class="o">.</span><span class="n">add_factor</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">f_type</span><span class="p">,</span> <span class="n">mapped</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">params</span><span class="p">))</span>

    <span class="n">tmp</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;gn&quot;</span><span class="p">,</span> <span class="n">iters</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">iters</span><span class="p">),</span> <span class="n">damping</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">damping</span><span class="p">),</span> <span class="n">max_step_norm</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="n">inv</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">remap</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="k">for</span> <span class="n">nid</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">tmp</span><span class="o">.</span><span class="n">fg</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">nid_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nid_int</span> <span class="ow">in</span> <span class="n">inv</span><span class="p">:</span>
            <span class="n">orig</span> <span class="o">=</span> <span class="n">inv</span><span class="p">[</span><span class="n">nid_int</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">orig</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">[</span><span class="n">orig</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">value</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.scene_graph.SceneGraphWorld.visualize_web" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">visualize_web</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8000</span><span class="p">,</span> <span class="n">open_browser</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Launch a local Three.js-based 3D viewer for this SceneGraph.</p>
<p>:param host: A string representing the Host IP, is configured for LocalHost by default
:param port: An integer representing a target host port to expose the webviewer</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span>
<span class="normal">1608</span>
<span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">visualize_web</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span>
    <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8000</span><span class="p">,</span>
    <span class="n">open_browser</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Launch a local Three.js-based 3D viewer for this SceneGraph.</span>

<span class="sd">    :param host: A string representing the Host IP, is configured for LocalHost by default</span>
<span class="sd">    :param port: An integer representing a target host port to expose the webviewer &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">dsg_jit.world.web_viewer</span><span class="w"> </span><span class="kn">import</span> <span class="n">run_scenegraph_web_viewer</span>

    <span class="n">run_scenegraph_web_viewer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span> <span class="n">open_browser</span><span class="o">=</span><span class="n">open_browser</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="world.scene_graph.SceneNodeState" class="doc doc-heading">
              <code class="highlight language-python"><span class="n">SceneNodeState</span><span class="p">(</span><span class="n">node_id</span><span class="p">,</span> <span class="n">var_type</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">



        <p>Lightweight cache of a scene-graph node's latest value.</p>
<p>This decouples the persistent scene graph from the underlying
optimization FactorGraph: even if a variable is marginalized or
removed from the FactorGraph (for example, in a sliding-window
setup), the SceneGraph can still serve its last optimized value.</p>











<div class="doc doc-children">












  </div>

    </div>

</div>




  </div>

    </div>

</div><hr />
<h2 id="worldvoxel_grid"><code>world.voxel_grid</code></h2>


<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">

        <p>Voxel grid utilities for differentiable volumetric scene representations.</p>
<p>This module defines helpers for constructing <em>voxel-level</em> variables and
their associated factors on top of the DSG-JIT world model.</p>
<h3 id="world.voxel_grid--key-responsibilities">Key responsibilities</h3>
<ul>
<li>Create voxel chains or grids:
     1D voxel chains (for smooth curves or lines in space).
     Higher-dimensional voxel layouts (as needed by experiments).</li>
<li>
<p>Register and attach voxel-related factors:
     Smoothness factors between neighboring voxels
      (using <code>voxel_smoothness_residual</code>).
     Point-observation factors tying voxels to measurements in world
      coordinates (using <code>voxel_point_observation_residual</code>).
     Optional voxel priors for regularization or supervision.</p>
</li>
<li>
<p>Provide convenience routines for:
     Initializing voxel positions (e.g. along an axis).
     Accessing the optimized voxel centers from the packed state.</p>
</li>
</ul>
<h3 id="world.voxel_grid--role-in-the-dsg-jit-stack">Role in the DSG-JIT stack</h3>
<p>Voxel grids are a key piece of the <em>volumetric</em> side of the engine.
They allow us to:</p>
<pre><code> Represent surfaces or occupancy with a differentiable structure.
 Run GaussNewton over large chains / grids of voxels.
 Jointly optimize voxels with SE3 poses and other scene graph nodes
  (hybrid SE3 + voxel experiments and benchmarks).
</code></pre>
<h3 id="world.voxel_grid--integration-points">Integration points</h3>
<ul>
<li>Uses <code>world.model.WorldModel</code> to create voxel variables and factors.</li>
<li>Relies on residuals defined in <code>slam.measurements</code> for:<ul>
<li>smoothness,</li>
<li>point observations,</li>
<li>and priors.</li>
</ul>
</li>
<li>Works seamlessly with <code>optimization.solvers.gauss_newton_manifold</code>
  and related JIT-compiled solvers.</li>
</ul>
<h3 id="world.voxel_grid--design-goals">Design goals</h3>
<ul>
<li><strong>Scalable</strong>:
    Able to create hundreds or thousands of voxel nodes and factors that
    still admit fast, JIT-compiled optimization.</li>
<li><strong>Composable</strong>:
    Plays nicely with SE3 poses, places, and other world entities in a
    single factor graph.</li>
<li><strong>Experiment-oriented</strong>:
    Keeps the voxel construction boilerplate out of experiment scripts,
    making it easier to design new voxel-based learning tasks.</li>
</ul>










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="world.voxel_grid.VoxelGridSpec" class="doc doc-heading">
              <code class="highlight language-python"><span class="n">VoxelGridSpec</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="n">resolution</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">



        <p>Specification for constructing a regular voxel grid.</p>
<p>This lightweight container defines the spatial layout of a voxel grid,
including its world-space origin, discrete grid dimensions, and the
physical resolution of each voxel cell.</p>
<p>:param origin: A 3-element array giving the world-space center of voxel
    coordinate (0, 0, 0). This is the reference point from which all voxel
    centers are computed.
:param dims: A tuple <code>(nx, ny, nz)</code> representing the number of voxels
    along the x-, y-, and z-axes respectively.
:param resolution: The edge length of each voxel cell in world units.
    The spacing between voxel centers is equal to this resolution.</p>











<div class="doc doc-children">












  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h2 id="world.voxel_grid.build_voxel_grid" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">build_voxel_grid</span><span class="p">(</span><span class="n">sg</span><span class="p">,</span> <span class="n">spec</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Construct a regular voxel grid inside the SceneGraphWorld.</p>
<p>This allocates one <code>voxel_cell</code> variable per grid coordinate <code>(ix, iy, iz)</code>
using the voxel resolution and origin defined in <code>spec</code>. Each voxel is
positioned at:</p>
<pre><code>center = origin + [ix * res, iy * res, iz * res]
</code></pre>
<p>The resulting mapping enables downstream creation of voxel smoothness
constraints and scene-graph integration.</p>
<p>:param sg: The active <code>SceneGraphWorld</code> instance where voxel nodes will be
    created. Must expose <code>add_voxel_cell(center)</code> which returns a node ID.
:param spec: Voxel grid specification containing:
    - <code>spec.origin</code>: 3D world origin of the grid.
    - <code>spec.dims</code>: Tuple <code>(nx, ny, nz)</code> specifying grid dimensions.
    - <code>spec.resolution</code>: Edge length of each voxel cell.
:return: A dictionary mapping each grid index <code>(ix, iy, iz)</code> to the
    corresponding voxel node ID allocated within the scene graph.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/voxel_grid.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_voxel_grid</span><span class="p">(</span>
    <span class="n">sg</span><span class="p">:</span> <span class="n">SceneGraphWorld</span><span class="p">,</span>
    <span class="n">spec</span><span class="p">:</span> <span class="n">VoxelGridSpec</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">GridIndex</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Construct a regular voxel grid inside the SceneGraphWorld.</span>

<span class="sd">    This allocates one `voxel_cell` variable per grid coordinate `(ix, iy, iz)`</span>
<span class="sd">    using the voxel resolution and origin defined in `spec`. Each voxel is</span>
<span class="sd">    positioned at:</span>

<span class="sd">        center = origin + [ix * res, iy * res, iz * res]</span>

<span class="sd">    The resulting mapping enables downstream creation of voxel smoothness</span>
<span class="sd">    constraints and scene-graph integration.</span>

<span class="sd">    :param sg: The active `SceneGraphWorld` instance where voxel nodes will be</span>
<span class="sd">        created. Must expose `add_voxel_cell(center)` which returns a node ID.</span>
<span class="sd">    :param spec: Voxel grid specification containing:</span>
<span class="sd">        - `spec.origin`: 3D world origin of the grid.</span>
<span class="sd">        - `spec.dims`: Tuple `(nx, ny, nz)` specifying grid dimensions.</span>
<span class="sd">        - `spec.resolution`: Edge length of each voxel cell.</span>
<span class="sd">    :return: A dictionary mapping each grid index `(ix, iy, iz)` to the</span>
<span class="sd">        corresponding voxel node ID allocated within the scene graph.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">origin</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,)</span>
    <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">dims</span>
    <span class="n">res</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">resolution</span><span class="p">)</span>

    <span class="n">index_to_id</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">GridIndex</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nx</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">iy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ny</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">iz</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nz</span><span class="p">):</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ix</span> <span class="o">*</span> <span class="n">res</span><span class="p">,</span> <span class="n">iy</span> <span class="o">*</span> <span class="n">res</span><span class="p">,</span> <span class="n">iz</span> <span class="o">*</span> <span class="n">res</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="n">center</span> <span class="o">=</span> <span class="n">origin</span> <span class="o">+</span> <span class="n">offset</span>
                <span class="n">nid</span> <span class="o">=</span> <span class="n">sg</span><span class="o">.</span><span class="n">add_voxel_cell</span><span class="p">(</span><span class="n">center</span><span class="p">)</span>
                <span class="n">index_to_id</span><span class="p">[(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">)]</span> <span class="o">=</span> <span class="n">nid</span>

    <span class="k">return</span> <span class="n">index_to_id</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="world.voxel_grid.connect_grid_neighbors_1d_x" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">connect_grid_neighbors_1d_x</span><span class="p">(</span><span class="n">sg</span><span class="p">,</span> <span class="n">index_to_id</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Connect 3D voxel grid nodes along the +x direction using smoothness factors.</p>
<p>This function iterates over all voxel indices <code>(ix, iy, iz)</code> such that
<code>ix + 1 &lt; nx</code>, and adds a voxel smoothness constraint between each voxel
and its +x neighbor. The enforced residual encourages:</p>
<pre><code>voxel(ix+1, iy, iz) - voxel(ix, iy, iz)  [resolution, 0, 0]
</code></pre>
<p>This is sufficient to enforce a 1D chain structure along the x-axis
and is used when constructing structured voxel grids for optimization.</p>
<p>:param sg: The active <code>SceneGraphWorld</code> instance to which smoothness
    factors will be added. Must expose <code>add_voxel_smoothness(i, j, offset, sigma)</code>.
:param index_to_id: Mapping from grid index <code>(ix, iy, iz)</code> to the corresponding
    node ID in the scene graph or factor graph.
:param spec: Voxel grid specification containing dimensions and voxel resolution.
    Expected to provide:
        - <code>spec.dims</code>: Tuple <code>(nx, ny, nz)</code> with number of voxels.
        - <code>spec.resolution</code>: Voxel edge length in world units.
:param sigma: Optional noise standard deviation for the smoothness factor.
    If <code>None</code>, the default sigma inside <code>sg.add_voxel_smoothness</code> is used.
:return: None. This function mutates the scene graph world in-place by
    adding smoothness edges between neighboring x-axis voxels.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/voxel_grid.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">connect_grid_neighbors_1d_x</span><span class="p">(</span>
    <span class="n">sg</span><span class="p">:</span> <span class="n">SceneGraphWorld</span><span class="p">,</span>
    <span class="n">index_to_id</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">GridIndex</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
    <span class="n">spec</span><span class="p">:</span> <span class="n">VoxelGridSpec</span><span class="p">,</span>
    <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Connect 3D voxel grid nodes along the +x direction using smoothness factors.</span>

<span class="sd">    This function iterates over all voxel indices `(ix, iy, iz)` such that</span>
<span class="sd">    `ix + 1 &lt; nx`, and adds a voxel smoothness constraint between each voxel</span>
<span class="sd">    and its +x neighbor. The enforced residual encourages:</span>

<span class="sd">        voxel(ix+1, iy, iz) - voxel(ix, iy, iz)  [resolution, 0, 0]</span>

<span class="sd">    This is sufficient to enforce a 1D chain structure along the x-axis</span>
<span class="sd">    and is used when constructing structured voxel grids for optimization.</span>

<span class="sd">    :param sg: The active `SceneGraphWorld` instance to which smoothness</span>
<span class="sd">        factors will be added. Must expose `add_voxel_smoothness(i, j, offset, sigma)`.</span>
<span class="sd">    :param index_to_id: Mapping from grid index `(ix, iy, iz)` to the corresponding</span>
<span class="sd">        node ID in the scene graph or factor graph.</span>
<span class="sd">    :param spec: Voxel grid specification containing dimensions and voxel resolution.</span>
<span class="sd">        Expected to provide:</span>
<span class="sd">            - `spec.dims`: Tuple `(nx, ny, nz)` with number of voxels.</span>
<span class="sd">            - `spec.resolution`: Voxel edge length in world units.</span>
<span class="sd">    :param sigma: Optional noise standard deviation for the smoothness factor.</span>
<span class="sd">        If `None`, the default sigma inside `sg.add_voxel_smoothness` is used.</span>
<span class="sd">    :return: None. This function mutates the scene graph world in-place by</span>
<span class="sd">        adding smoothness edges between neighboring x-axis voxels.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">dims</span>
    <span class="n">res</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">resolution</span><span class="p">)</span>

    <span class="n">offset</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">res</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">iy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ny</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">iz</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nz</span><span class="p">):</span>
                <span class="n">vid_i</span> <span class="o">=</span> <span class="n">index_to_id</span><span class="p">[(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">)]</span>
                <span class="n">vid_j</span> <span class="o">=</span> <span class="n">index_to_id</span><span class="p">[(</span><span class="n">ix</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">)]</span>
                <span class="n">sg</span><span class="o">.</span><span class="n">add_voxel_smoothness</span><span class="p">(</span><span class="n">vid_i</span><span class="p">,</span> <span class="n">vid_j</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><hr />
<h2 id="worldtraining"><code>world.training</code></h2>


<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">

        <p>High-level training utilities for differentiable scene graph experiments.</p>
<p>This module provides a small training harness that sits on top of:</p>
<pre><code> `world.model.WorldModel` / `world.scene_graph.SceneGraphWorld`
 JAX-based optimizers and GaussNewton solvers
 Residual functions from `slam.measurements`
</code></pre>
<p>Its main role is to support <em>meta-learning</em> and <em>hyperparameter learning</em>
over the differentiable DSG-JIT engine. Examples include:</p>
<pre><code> Learning factor-type weights (e.g. odometry vs. observation).
 Learning measurement parameters (odom SE3 chains, voxel obs).
 Running outer-loop gradient descent over:
    - log-scale weights,
    - observation locations,
    - or other theta parameters that influence the inner solve.
</code></pre>
<h3 id="world.training--typical-structure">Typical structure</h3>
<p>A typical training loop implemented here follows this pattern:</p>
<pre><code>1. Build a world / scene graph for a given scenario.
2. Build a residual function that depends both on:
       - the state x (poses, voxels, etc.), and
       - learnable parameters  (e.g. measurements, log-scales).
3. Run an inner optimization (GaussNewton or gradient descent)
   to obtain x*().
4. Compute a supervised loss L(x*(), target).
5. Differentiate L w.r.t.  using JAX (`jax.grad` or `jax.value_and_grad`).
6. Update  with an outer optimizer step.
</code></pre>
<p>The <code>DSGTrainer</code> (or equivalent helper) encapsulates this pattern,
exposing <code>step</code> / <code>train_step</code>style methods that return both the new
parameters and useful diagnostics (loss, gradient norms, etc.).</p>
<h3 id="world.training--design-goals">Design goals</h3>
<ul>
<li><strong>Keep experiments small</strong>:
    Training logic lives here so individual experiments can focus on
    constructing the world and defining the supervision signal.</li>
<li><strong>JAX-first design</strong>:
    Training functions are written to be JIT-able and differentiable,
    allowing seamless scaling from toy experiments to larger graphs.</li>
<li><strong>Research-friendly</strong>:
    The code is intentionally lightweight and easy to modify for new
    research ideas around learnable costs, priors, and structure.</li>
</ul>










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="world.training.DSGTrainer" class="doc doc-heading">
              <code class="highlight language-python"><span class="n">DSGTrainer</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">factor_type_order</span><span class="p">,</span> <span class="n">inner_cfg</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">



        <p>High-level trainer for differentiable DSG experiments.</p>
<p>This class encapsulates a simple bi-level optimization pattern where:
an inner loop solves for the scene graph state x, and an outer loop
optimizes meta-parameters such as factor-type weights.</p>
<p>:param wm: World model containing the factor graph and scene graph.
:param factor_type_order: Ordered list of factor type names; each entry corresponds to a log-scale entry in the weight vector.
:param inner_cfg: Configuration for the inner gradientdescent solver applied to the state.</p>











<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="world.training.DSGTrainer.__post_init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">__post_init__</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Post-initialization hook.</p>
<p>This method caches the underlying factor graph from the world model
and builds a residual function that accepts per-factor-type log-scales.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/training.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Post-initialization hook.</span>

<span class="sd">    This method caches the underlying factor graph from the world model</span>
<span class="sd">    and builds a residual function that accepts per-factor-type log-scales.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fg</span><span class="p">:</span> <span class="n">FactorGraph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">fg</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">residual_w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fg</span><span class="o">.</span><span class="n">build_residual_function_with_type_weights</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">factor_type_order</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.training.DSGTrainer.solve_state" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">solve_state</span><span class="p">(</span><span class="n">log_scales</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Run the inner optimization to solve for the state vector.</p>
<p>Given a vector of log-scales for factor types, this method performs
explicit gradient descent on the objective</p>
<pre><code>0.5 * || r(x, log_scales) ||^2,
</code></pre>
<p>where r is the weighted residual function built from the factor graph.</p>
<p>:param log_scales: Array of shape <code>(T,)</code> containing per-factor-type log-scale weights.
:return: Optimized flat state vector <code>x</code> after the inner GD loop.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/training.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">solve_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_scales</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run the inner optimization to solve for the state vector.</span>

<span class="sd">    Given a vector of log-scales for factor types, this method performs</span>
<span class="sd">    explicit gradient descent on the objective</span>

<span class="sd">        0.5 * || r(x, log_scales) ||^2,</span>

<span class="sd">    where r is the weighted residual function built from the factor graph.</span>

<span class="sd">    :param log_scales: Array of shape ``(T,)`` containing per-factor-type log-scale weights.</span>
<span class="sd">    :return: Optimized flat state vector ``x`` after the inner GD loop.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x0</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">pack_state</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">loss_x</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">log_scales</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">residual_w</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">log_scales</span><span class="p">)</span>
        <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">r</span><span class="p">)</span>

    <span class="n">grad_loss_x</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">loss_x</span><span class="p">)</span>

    <span class="c1"># plain Python loop (no jax.lax.while_loop, easier to debug)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x0</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inner_cfg</span><span class="o">.</span><span class="n">max_iters</span><span class="p">):</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">grad_loss_x</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">log_scales</span><span class="p">)</span>

        <span class="c1"># gradient may be large; clamp the step</span>
        <span class="n">step</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">inner_cfg</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">*</span> <span class="n">g</span>
        <span class="n">step_norm</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
        <span class="n">max_norm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inner_cfg</span><span class="o">.</span><span class="n">max_step_norm</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">clamp_step</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">step_norm</span><span class="p">,</span> <span class="n">max_norm</span><span class="p">):</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="n">max_norm</span> <span class="o">/</span> <span class="p">(</span><span class="n">step_norm</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">step</span> <span class="o">*</span> <span class="n">scale</span>

        <span class="n">step</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span>
            <span class="n">step_norm</span> <span class="o">&gt;</span> <span class="n">max_norm</span><span class="p">,</span>
            <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">clamp_step</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">step_norm</span><span class="p">,</span> <span class="n">max_norm</span><span class="p">),</span>
            <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">step</span><span class="p">,</span>
            <span class="n">operand</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">step</span>

    <span class="k">return</span> <span class="n">x</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.training.DSGTrainer.unpack_state" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">unpack_state</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Unpack a flat state vector into a NodeId-keyed dictionary.</p>
<p>This is a thin wrapper around the factor graph's <code>unpack_state</code>
that uses the index structure implied by the current world model.</p>
<p>:param x: Flat state vector to be unpacked.
:return: Mapping from <code>NodeId</code> to the corresponding slice of <code>x</code> as a JAX array.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/training.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">unpack_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Unpack a flat state vector into a NodeId-keyed dictionary.</span>

<span class="sd">    This is a thin wrapper around the factor graph&#39;s ``unpack_state``</span>
<span class="sd">    that uses the index structure implied by the current world model.</span>

<span class="sd">    :param x: Flat state vector to be unpacked.</span>
<span class="sd">    :return: Mapping from ``NodeId`` to the corresponding slice of ``x`` as a JAX array.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">pack_state</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">unpack_state</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="world.training.InnerGDConfig" class="doc doc-heading">
              <code class="highlight language-python"><span class="n">InnerGDConfig</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">max_iters</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">max_step_norm</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">



        <p>Configuration for the inner gradientdescent solver.</p>
<p>:param learning_rate: Step size used for each inner GD update on the state.
:param max_iters: Maximum number of inner GD iterations.
:param max_step_norm: Maximum allowed L2 norm of a single GD step; used to clamp overly large updates for numerical stability.</p>











<div class="doc doc-children">












  </div>

    </div>

</div>




  </div>

    </div>

</div><h2 id="worldvisualization"><code>world.visualization</code></h2>


<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">

        <p>Visualization utilities for DSG-JIT.</p>
<p>This module provides lightweight 2D and 3D rendering tools for visualizing
factor graphs, scene graphs, and mixed-level semantic structures. It is
designed to support both debugging and demonstration of DSG-JITs hierarchical
representations, including robot poses, voxel cells, places, rooms, and
arbitrary semantic objects.</p>
<p>The visualization pipeline follows three main steps:</p>
<ol>
<li>
<p><strong>Exporting graph data</strong><br />
<code>export_factor_graph_for_vis()</code> converts an internal <code>FactorGraph</code> into
   color-coded <code>VisNode</code> and <code>VisEdge</code> lists. Variable types such as
   <code>pose_se3</code>, <code>voxel_cell</code>, <code>place1d</code>, and <code>room1d</code> are mapped to coarse
   visualization categories, and heuristic 3D positions are extracted for
   rendering.</p>
</li>
<li>
<p><strong>2D top-down rendering</strong><br />
<code>plot_factor_graph_2d()</code> produces a Matplotlib top-down view (xy plane)
   with automatically computed bounds, node type coloring, and optional label
   rendering. This is especially useful for SE(3) SLAM chains, grid-based
   voxel fields, and planar semantic graphs.</p>
</li>
<li>
<p><strong>Full 3D scene graph rendering</strong><br />
<code>plot_factor_graph_3d()</code> draws a complete 3D view of poses, voxels, places,
   rooms, and objects. Edges between nodes represent geometric or semantic
   relationships. Aspect ratios are normalized so spatial structure remains
   visually meaningful regardless of scale.</p>
</li>
</ol>
<p>These visualizers are intentionally decoupled from the high-level world model
(<code>SceneGraphWorld</code>) so they can be used directly on raw factor graphs produced
by optimization procedures or experiment scripts.</p>
<p>Example usage is provided in:
- <code>experiments/exp17_visual_factor_graph.py</code> (basic 2D + 3D factor graph)
- <code>experiments/exp18_scenegraph_3d.py</code> (HYDRA-style multi-level scene graph)
- <code>experiments/exp18_scenegraph_demo.py</code> (HYDRA-style 2D + 3D scene graph)
- <code>experiments/exp19_dynamic_scene_graph_demo.py</code> (dynamic agent trajectories)</p>


<details class="module-contents" open>
  <summary>Module contents</summary>
  <ul>
<li><code>VisNode</code>: Lightweight typed node container for visualization.</li>
<li><code>VisEdge</code>: Lightweight edge container (factor connections).</li>
<li><code>_infer_node_type()</code>: Maps variable types  canonical visualization types.</li>
<li><code>_extract_position()</code>: Extracts a 3D coordinate from variable states.</li>
<li><code>export_factor_graph_for_vis()</code>: Converts a FactorGraph  vis nodes &amp; edges.</li>
<li><code>plot_factor_graph_2d()</code>: Renders a 2D top-down view of the graph.</li>
<li><code>plot_factor_graph_3d()</code>: Renders a full 3D scene graph with semantic layers.</li>
<li><code>plot_scenegraph_3d()</code>: Renders a scene graph with semantic layers and (optionally) agent trajectories.</li>
<li><code>plot_dynamic_trajectories_3d()</code>: Renders 3D agent trajectories with time-encoded color.</li>
</ul>
</details>        <p>This module is designed to be extendablefor example:
- Additional node types can be added via <code>_infer_node_type</code>.
- SceneGraphWorld can later provide richer semantic annotations.
- Future versions may support interactive or WebGL visualizations.</p>










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="world.visualization.VisEdge" class="doc doc-heading">
              <code class="highlight language-python"><span class="n">VisEdge</span><span class="p">(</span><span class="n">var_ids</span><span class="p">,</span> <span class="n">factor_type</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">



        <p>Lightweight edge representation for visualization.</p>











<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="world.visualization.VisNode" class="doc doc-heading">
              <code class="highlight language-python"><span class="n">VisNode</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">



        <p>Lightweight node representation for visualization.</p>











<div class="doc doc-children">












  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h2 id="world.visualization.export_factor_graph_for_vis" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">export_factor_graph_for_vis</span><span class="p">(</span><span class="n">fg</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Export a FactorGraph into a visualization-friendly node/edge list.</p>
<p>This does <em>not</em> require any SceneGraphWorld; it just uses variables/factors.</p>
<p>:param fg: The factor graph to visualize.
:return: (nodes, edges) where nodes is a list of VisNode and edges is a list of VisEdge.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/visualization.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">export_factor_graph_for_vis</span><span class="p">(</span><span class="n">fg</span><span class="p">:</span> <span class="n">FactorGraph</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">VisNode</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">VisEdge</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Export a FactorGraph into a visualization-friendly node/edge list.</span>

<span class="sd">    This does *not* require any SceneGraphWorld; it just uses variables/factors.</span>

<span class="sd">    :param fg: The factor graph to visualize.</span>
<span class="sd">    :return: (nodes, edges) where nodes is a list of VisNode and edges is a list of VisEdge.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nodes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">VisNode</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">edges</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">VisEdge</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Nodes</span>
    <span class="k">for</span> <span class="n">nid</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">fg</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">ntype</span> <span class="o">=</span> <span class="n">_infer_node_type</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">_extract_position</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">VisNode</span><span class="p">(</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">nid</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">ntype</span><span class="p">,</span>
                <span class="n">position</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ntype</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">nid</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># Edges (one edge per factor, between all its variables)</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fg</span><span class="o">.</span><span class="n">factors</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">edges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">VisEdge</span><span class="p">(</span><span class="n">var_ids</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">var_ids</span><span class="p">),</span> <span class="n">factor_type</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">type</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">edges</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="world.visualization.plot_dynamic_trajectories_3d" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_dynamic_trajectories_3d</span><span class="p">(</span><span class="n">dsg</span><span class="p">,</span> <span class="n">x_opt</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Dynamic 3D Scene Graph&#39;</span><span class="p">,</span> <span class="n">color_by_time</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Render 3D agent trajectories with time encoded as color.</p>
<p>This helper is intended for <code>DynamicSceneGraph</code>-style structures where
agents move through time. It treats time as an implicit fourth
dimension and visualizes it via either a color gradient or a solid
color per agent.</p>
<p>:param dsg: Dynamic scene graph object exposing an iterable
    <code>agents</code> attribute and a
    <code>get_agent_trajectory(agent, x_opt, index)</code> method that returns
    an array of shape <code>(T, 6)</code> or <code>(T, 3)</code>. Only the translational
    components <code>(x, y, z)</code> are visualized.
:param x_opt: Optimized flat state vector used to decode agent poses.
:param index: Mapping from node identifier to slice or <code>(start, dim)</code>
    describing how to extract each nodes state from <code>x_opt</code>. This is
    passed through to <code>dsg.get_agent_trajectory</code>.
:param title: Optional figure title for the 3D plot.
:param color_by_time: If <code>True</code>, encode time as a colormap gradient
    along each trajectory; if <code>False</code>, use a single solid color per
    agent.
:return: None. The function creates and displays a Matplotlib 3D figure.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/visualization.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_dynamic_trajectories_3d</span><span class="p">(</span>
    <span class="n">dsg</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">x_opt</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">index</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">slice</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]],</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Dynamic 3D Scene Graph&quot;</span><span class="p">,</span>
    <span class="n">color_by_time</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Render 3D agent trajectories with time encoded as color.</span>

<span class="sd">    This helper is intended for ``DynamicSceneGraph``-style structures where</span>
<span class="sd">    agents move through time. It treats time as an implicit fourth</span>
<span class="sd">    dimension and visualizes it via either a color gradient or a solid</span>
<span class="sd">    color per agent.</span>

<span class="sd">    :param dsg: Dynamic scene graph object exposing an iterable</span>
<span class="sd">        ``agents`` attribute and a</span>
<span class="sd">        ``get_agent_trajectory(agent, x_opt, index)`` method that returns</span>
<span class="sd">        an array of shape ``(T, 6)`` or ``(T, 3)``. Only the translational</span>
<span class="sd">        components ``(x, y, z)`` are visualized.</span>
<span class="sd">    :param x_opt: Optimized flat state vector used to decode agent poses.</span>
<span class="sd">    :param index: Mapping from node identifier to slice or ``(start, dim)``</span>
<span class="sd">        describing how to extract each nodes state from ``x_opt``. This is</span>
<span class="sd">        passed through to ``dsg.get_agent_trajectory``.</span>
<span class="sd">    :param title: Optional figure title for the 3D plot.</span>
<span class="sd">    :param color_by_time: If ``True``, encode time as a colormap gradient</span>
<span class="sd">        along each trajectory; if ``False``, use a single solid color per</span>
<span class="sd">        agent.</span>
<span class="sd">    :return: None. The function creates and displays a Matplotlib 3D figure.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s2">&quot;3d&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

    <span class="n">all_pts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dsg</span><span class="p">,</span> <span class="s2">&quot;agents&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Dynamic scene graph object must expose an &#39;agents&#39; attribute&quot;</span><span class="p">)</span>

    <span class="c1"># Use a base list of colors when not color-coding by time.</span>
    <span class="n">base_colors</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;axes.prop_cycle&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">by_key</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span> <span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="s2">&quot;C2&quot;</span><span class="p">,</span> <span class="s2">&quot;C3&quot;</span><span class="p">])</span>  <span class="c1"># type: ignore[index]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">agent</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dsg</span><span class="o">.</span><span class="n">agents</span><span class="p">):</span>
        <span class="n">traj</span> <span class="o">=</span> <span class="n">dsg</span><span class="o">.</span><span class="n">get_agent_trajectory</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">x_opt</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
        <span class="n">traj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">traj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">traj</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">traj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">xyz</span> <span class="o">=</span> <span class="n">traj</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">all_pts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">color_by_time</span> <span class="ow">and</span> <span class="n">xyz</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Encode time as a gradient along the trajectory</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">xyz</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s2">&quot;viridis&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">xyz</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="n">xyz</span><span class="p">[</span><span class="n">j</span> <span class="p">:</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                    <span class="n">xyz</span><span class="p">[</span><span class="n">j</span> <span class="p">:</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                    <span class="n">xyz</span><span class="p">[</span><span class="n">j</span> <span class="p">:</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">base_colors</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">base_colors</span><span class="p">)]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">xyz</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="n">xyz</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">xyz</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="si">}</span><span class="s2">_traj&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="c1"># Autoscale axes to include all trajectories</span>
    <span class="k">if</span> <span class="n">all_pts</span><span class="p">:</span>
        <span class="n">stacked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">all_pts</span><span class="p">)</span>
        <span class="n">mins</span> <span class="o">=</span> <span class="n">stacked</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">maxs</span> <span class="o">=</span> <span class="n">stacked</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">center</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">mins</span> <span class="o">+</span> <span class="n">maxs</span><span class="p">)</span>
        <span class="n">extent</span> <span class="o">=</span> <span class="nb">float</span><span class="p">((</span><span class="n">maxs</span> <span class="o">-</span> <span class="n">mins</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">extent</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">extent</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="mf">0.6</span> <span class="o">*</span> <span class="n">extent</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">scale</span><span class="p">,</span> <span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">scale</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">scale</span><span class="p">,</span> <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">scale</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_zlim</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">scale</span><span class="p">,</span> <span class="n">center</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">scale</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">)</span>

    <span class="c1"># Only show legend entries when not using per-segment colors.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">color_by_time</span><span class="p">:</span>
        <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">labels</span><span class="p">:</span>
            <span class="n">uniq</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">handles</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">l</span> <span class="ow">and</span> <span class="n">l</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">uniq</span><span class="p">:</span>
                    <span class="n">uniq</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">uniq</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">uniq</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="world.visualization.plot_factor_graph_2d" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_factor_graph_2d</span><span class="p">(</span><span class="n">fg</span><span class="p">,</span> <span class="n">show_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Simple top-down 2D visualization of the factor graph.</p>
<ul>
<li>nodes colored by type</li>
<li>edges drawn between connected variable nodes (projected to xy)</li>
<li>dynamic aspect ratio and bounds based on node extents</li>
</ul>
<p>:param fg: The factor graph to visualize.
:param show_labels: Whether to draw node labels.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/visualization.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_factor_graph_2d</span><span class="p">(</span><span class="n">fg</span><span class="p">:</span> <span class="n">FactorGraph</span><span class="p">,</span> <span class="n">show_labels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple top-down 2D visualization of the factor graph.</span>

<span class="sd">    - nodes colored by type</span>
<span class="sd">    - edges drawn between connected variable nodes (projected to xy)</span>
<span class="sd">    - dynamic aspect ratio and bounds based on node extents</span>

<span class="sd">    :param fg: The factor graph to visualize.</span>
<span class="sd">    :param show_labels: Whether to draw node labels.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nodes</span><span class="p">,</span> <span class="n">edges</span> <span class="o">=</span> <span class="n">export_factor_graph_for_vis</span><span class="p">(</span><span class="n">fg</span><span class="p">)</span>

    <span class="c1"># color palette per node type</span>
    <span class="n">type_to_color</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;pose&quot;</span><span class="p">:</span> <span class="s2">&quot;C0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;voxel&quot;</span><span class="p">:</span> <span class="s2">&quot;C1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;place&quot;</span><span class="p">:</span> <span class="s2">&quot;C2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;room&quot;</span><span class="p">:</span> <span class="s2">&quot;C3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;other&quot;</span><span class="p">:</span> <span class="s2">&quot;C4&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># Build quick lookup for positions and types</span>
    <span class="n">node_pos</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeId</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">n</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="n">n</span><span class="o">.</span><span class="n">position</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">}</span>
    <span class="n">node_type</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeId</span><span class="p">,</span> <span class="n">NodeType</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">n</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="n">n</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">}</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>

    <span class="c1"># Draw edges (as lines between all pairs in each factor)</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
        <span class="n">var_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">var_ids</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">var_ids</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">var_ids</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">ida</span> <span class="o">=</span> <span class="n">var_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">idb</span> <span class="o">=</span> <span class="n">var_ids</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">node_pos</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ida</span><span class="p">)</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">node_pos</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">idb</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">b</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">kind</span> <span class="o">=</span> <span class="n">_classify_edge_kind</span><span class="p">(</span><span class="n">node_type</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ida</span><span class="p">,</span> <span class="s2">&quot;other&quot;</span><span class="p">),</span>
                                       <span class="n">node_type</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">idb</span><span class="p">,</span> <span class="s2">&quot;other&quot;</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;room-place&quot;</span><span class="p">:</span>
                <span class="n">color</span><span class="p">,</span> <span class="n">ls</span><span class="p">,</span> <span class="n">lw</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="s2">&quot;magenta&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">0.6</span>
            <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;place-object&quot;</span><span class="p">:</span>
                <span class="n">color</span><span class="p">,</span> <span class="n">ls</span><span class="p">,</span> <span class="n">lw</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="s2">&quot;magenta&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">,</span> <span class="mf">0.6</span>
            <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;pose-edge&quot;</span><span class="p">:</span>
                <span class="n">color</span><span class="p">,</span> <span class="n">ls</span><span class="p">,</span> <span class="n">lw</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.4</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">color</span><span class="p">,</span> <span class="n">ls</span><span class="p">,</span> <span class="n">lw</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.2</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span>
                <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="n">lw</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
                <span class="n">linestyle</span><span class="o">=</span><span class="n">ls</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="c1"># Draw nodes</span>
    <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">type_to_color</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">)</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">xs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">ys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show_labels</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;x [m]&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;y [m]&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;DSG-JIT Factor Graph (2D / top-down)&quot;</span><span class="p">)</span>

    <span class="c1"># Dynamic bounds with equal aspect</span>
    <span class="k">if</span> <span class="n">xs</span> <span class="ow">and</span> <span class="n">ys</span><span class="p">:</span>
        <span class="n">min_x</span><span class="p">,</span> <span class="n">max_x</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">xs</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
        <span class="n">min_y</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ys</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span>
        <span class="n">max_range</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_x</span> <span class="o">-</span> <span class="n">min_x</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">-</span> <span class="n">min_y</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="k">if</span> <span class="n">max_range</span> <span class="o">&lt;</span> <span class="mf">1e-3</span><span class="p">:</span>
            <span class="n">max_range</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">mid_x</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_x</span> <span class="o">+</span> <span class="n">min_x</span><span class="p">)</span>
        <span class="n">mid_y</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_y</span> <span class="o">+</span> <span class="n">min_y</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">mid_x</span> <span class="o">-</span> <span class="n">max_range</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">,</span> <span class="n">mid_x</span> <span class="o">+</span> <span class="n">max_range</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">mid_y</span> <span class="o">-</span> <span class="n">max_range</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">,</span> <span class="n">mid_y</span> <span class="o">+</span> <span class="n">max_range</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="world.visualization.plot_factor_graph_3d" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_factor_graph_3d</span><span class="p">(</span><span class="n">fg</span><span class="p">,</span> <span class="n">show_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>3D visualization of the factor graph.</p>
<ul>
<li>Nodes plotted as (x, y, z)</li>
<li>Edges drawn as 3D line segments</li>
<li>Colors by node type</li>
</ul>
<p>:param fg: The factor graph to visualize.
:param show_labels: Whether to draw node labels in 3D.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/visualization.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_factor_graph_3d</span><span class="p">(</span><span class="n">fg</span><span class="p">:</span> <span class="n">FactorGraph</span><span class="p">,</span> <span class="n">show_labels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    3D visualization of the factor graph.</span>

<span class="sd">    - Nodes plotted as (x, y, z)</span>
<span class="sd">    - Edges drawn as 3D line segments</span>
<span class="sd">    - Colors by node type</span>

<span class="sd">    :param fg: The factor graph to visualize.</span>
<span class="sd">    :param show_labels: Whether to draw node labels in 3D.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nodes</span><span class="p">,</span> <span class="n">edges</span> <span class="o">=</span> <span class="n">export_factor_graph_for_vis</span><span class="p">(</span><span class="n">fg</span><span class="p">)</span>

    <span class="n">type_to_color</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;pose&quot;</span><span class="p">:</span> <span class="s2">&quot;C0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;voxel&quot;</span><span class="p">:</span> <span class="s2">&quot;C1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;place&quot;</span><span class="p">:</span> <span class="s2">&quot;C2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;room&quot;</span><span class="p">:</span> <span class="s2">&quot;C3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;other&quot;</span><span class="p">:</span> <span class="s2">&quot;C4&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">node_pos</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeId</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">n</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="n">n</span><span class="o">.</span><span class="n">position</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">}</span>
    <span class="n">node_type</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeId</span><span class="p">,</span> <span class="n">NodeType</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">n</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="n">n</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">}</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s2">&quot;3d&quot;</span><span class="p">)</span>

    <span class="c1"># Draw edges</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
        <span class="n">var_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">var_ids</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">var_ids</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">var_ids</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">ida</span> <span class="o">=</span> <span class="n">var_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">idb</span> <span class="o">=</span> <span class="n">var_ids</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">node_pos</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ida</span><span class="p">)</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">node_pos</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">idb</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">b</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">kind</span> <span class="o">=</span> <span class="n">_classify_edge_kind</span><span class="p">(</span><span class="n">node_type</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ida</span><span class="p">,</span> <span class="s2">&quot;other&quot;</span><span class="p">),</span>
                                       <span class="n">node_type</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">idb</span><span class="p">,</span> <span class="s2">&quot;other&quot;</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;room-place&quot;</span><span class="p">:</span>
                <span class="n">color</span><span class="p">,</span> <span class="n">ls</span><span class="p">,</span> <span class="n">lw</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="s2">&quot;magenta&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">0.6</span>
            <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;place-object&quot;</span><span class="p">:</span>
                <span class="n">color</span><span class="p">,</span> <span class="n">ls</span><span class="p">,</span> <span class="n">lw</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="s2">&quot;magenta&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">,</span> <span class="mf">0.6</span>
            <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;pose-edge&quot;</span><span class="p">:</span>
                <span class="n">color</span><span class="p">,</span> <span class="n">ls</span><span class="p">,</span> <span class="n">lw</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.4</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">color</span><span class="p">,</span> <span class="n">ls</span><span class="p">,</span> <span class="n">lw</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.2</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span>
                <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span>
                <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">])],</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="n">lw</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
                <span class="n">linestyle</span><span class="o">=</span><span class="n">ls</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="c1"># Draw nodes</span>
    <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">zs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">type_to_color</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">)</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">position</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">xs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">ys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">zs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show_labels</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;x [m]&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;y [m]&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s2">&quot;z [m]&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;DSG-JIT Factor Graph (3D)&quot;</span><span class="p">)</span>

    <span class="c1"># Make aspect ratio equal in 3D</span>
    <span class="k">if</span> <span class="n">xs</span> <span class="ow">and</span> <span class="n">ys</span> <span class="ow">and</span> <span class="n">zs</span><span class="p">:</span>
        <span class="n">min_x</span><span class="p">,</span> <span class="n">max_x</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">xs</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
        <span class="n">min_y</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ys</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span>
        <span class="n">min_z</span><span class="p">,</span> <span class="n">max_z</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">zs</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">zs</span><span class="p">)</span>
        <span class="n">max_range</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_x</span> <span class="o">-</span> <span class="n">min_x</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">-</span> <span class="n">min_y</span><span class="p">,</span> <span class="n">max_z</span> <span class="o">-</span> <span class="n">min_z</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="k">if</span> <span class="n">max_range</span> <span class="o">&lt;</span> <span class="mf">1e-3</span><span class="p">:</span>
            <span class="n">max_range</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">mid_x</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_x</span> <span class="o">+</span> <span class="n">min_x</span><span class="p">)</span>
        <span class="n">mid_y</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_y</span> <span class="o">+</span> <span class="n">min_y</span><span class="p">)</span>
        <span class="n">mid_z</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_z</span> <span class="o">+</span> <span class="n">min_z</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">mid_x</span> <span class="o">-</span> <span class="n">max_range</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">,</span> <span class="n">mid_x</span> <span class="o">+</span> <span class="n">max_range</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">mid_y</span> <span class="o">-</span> <span class="n">max_range</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">,</span> <span class="n">mid_y</span> <span class="o">+</span> <span class="n">max_range</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_zlim</span><span class="p">(</span><span class="n">mid_z</span> <span class="o">-</span> <span class="n">max_range</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">,</span> <span class="n">mid_z</span> <span class="o">+</span> <span class="n">max_range</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="world.visualization.plot_scenegraph_3d" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_scenegraph_3d</span><span class="p">(</span><span class="n">sg</span><span class="p">,</span> <span class="n">x_opt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Scene Graph 3D&#39;</span><span class="p">,</span> <span class="n">dsg</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Render a 3D scene graph with rooms, places, objects, place attachments,
and optional agent trajectories.</p>
<p>This function supports two modes:
- If <code>sg</code> exposes a <code>_memory</code> attribute (the SceneGraph memory layer introduced in <code>SceneGraphWorld</code>),
  node positions are read from this memory and <code>x_opt</code> and <code>index</code> are ignored.
- If no memory is present, the function falls back to the previous behavior using <code>x_opt</code> and <code>index</code>
  to decode node states.</p>
<p>:param sg: Scene-graph world instance. It is expected to expose
    attributes such as <code>rooms</code>, <code>places</code>, <code>objects</code>,
    <code>place_parents</code>, <code>object_parents</code>, and <code>place_attachments</code>,
    following the conventions used by :class:<code>SceneGraphWorld</code>.
:param x_opt: (Optional) Optimized flat state vector (e.g. from
    :meth:<code>WorldModel.pack_state</code>), containing the current estimates
    of all node states. Not required if <code>sg</code> exposes a <code>_memory</code> layer.
:param index: (Optional) Mapping from node identifier to either a slice or
    <code>(start, dim)</code> tuple describing where that nodes state lives
    inside <code>x_opt</code>. Not required if <code>sg</code> exposes a <code>_memory</code> layer.
:param title: Optional figure title for the Matplotlib 3D axes.
:param dsg: Optional dynamic scene graph used to overlay agent
    trajectories. It should expose an iterable <code>agents</code> attribute
    and a <code>get_agent_trajectory(agent, x_opt, index)</code> method that
    returns an array of shape <code>(T, 6)</code> or <code>(T, 3)</code>.
:return: None. The function creates and displays a Matplotlib 3D figure.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/visualization.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_scenegraph_3d</span><span class="p">(</span>
    <span class="n">sg</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">x_opt</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">slice</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Scene Graph 3D&quot;</span><span class="p">,</span>
    <span class="n">dsg</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Render a 3D scene graph with rooms, places, objects, place attachments,</span>
<span class="sd">    and optional agent trajectories.</span>

<span class="sd">    This function supports two modes:</span>
<span class="sd">    - If ``sg`` exposes a ``_memory`` attribute (the SceneGraph memory layer introduced in ``SceneGraphWorld``),</span>
<span class="sd">      node positions are read from this memory and ``x_opt`` and ``index`` are ignored.</span>
<span class="sd">    - If no memory is present, the function falls back to the previous behavior using ``x_opt`` and ``index``</span>
<span class="sd">      to decode node states.</span>

<span class="sd">    :param sg: Scene-graph world instance. It is expected to expose</span>
<span class="sd">        attributes such as ``rooms``, ``places``, ``objects``,</span>
<span class="sd">        ``place_parents``, ``object_parents``, and ``place_attachments``,</span>
<span class="sd">        following the conventions used by :class:`SceneGraphWorld`.</span>
<span class="sd">    :param x_opt: (Optional) Optimized flat state vector (e.g. from</span>
<span class="sd">        :meth:`WorldModel.pack_state`), containing the current estimates</span>
<span class="sd">        of all node states. Not required if ``sg`` exposes a ``_memory`` layer.</span>
<span class="sd">    :param index: (Optional) Mapping from node identifier to either a slice or</span>
<span class="sd">        ``(start, dim)`` tuple describing where that nodes state lives</span>
<span class="sd">        inside ``x_opt``. Not required if ``sg`` exposes a ``_memory`` layer.</span>
<span class="sd">    :param title: Optional figure title for the Matplotlib 3D axes.</span>
<span class="sd">    :param dsg: Optional dynamic scene graph used to overlay agent</span>
<span class="sd">        trajectories. It should expose an iterable ``agents`` attribute</span>
<span class="sd">        and a ``get_agent_trajectory(agent, x_opt, index)`` method that</span>
<span class="sd">        returns an array of shape ``(T, 6)`` or ``(T, 3)``.</span>
<span class="sd">    :return: None. The function creates and displays a Matplotlib 3D figure.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">has_memory</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sg</span><span class="p">,</span> <span class="s2">&quot;_memory&quot;</span><span class="p">)</span>
    <span class="n">mem</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sg</span><span class="p">,</span> <span class="s2">&quot;_memory&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_partition_memory_by_type</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Derive rooms / places / objects mappings from the SceneGraphWorld</span>
<span class="sd">        memory layer when explicit dictionaries (sg.rooms, sg.places,</span>
<span class="sd">        sg.objects) are not available or are empty.</span>

<span class="sd">        This assumes each memory entry is a small dataclass-like object</span>
<span class="sd">        exposing ``node_id`` and ``var_type`` attributes, where</span>
<span class="sd">        ``var_type`` starts with e.g. ``&quot;room&quot;``, ``&quot;place&quot;``, or</span>
<span class="sd">        ``&quot;object&quot;`` / ``&quot;voxel&quot;``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rooms_m</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">places_m</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">objects_m</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_memory</span> <span class="ow">or</span> <span class="n">mem</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rooms_m</span><span class="p">,</span> <span class="n">places_m</span><span class="p">,</span> <span class="n">objects_m</span>

        <span class="c1"># Iterate over stored node states and group by var_type prefix.</span>
        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="s2">&quot;values&quot;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="p">[])():</span>
            <span class="n">vt</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;var_type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">nid</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;node_id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># Construct simple human-readable names when no explicit names exist.</span>
            <span class="k">if</span> <span class="n">vt</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;room&quot;</span><span class="p">):</span>
                <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;room_</span><span class="si">{</span><span class="n">nid</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">rooms_m</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nid</span>
            <span class="k">elif</span> <span class="n">vt</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;place&quot;</span><span class="p">):</span>
                <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;place_</span><span class="si">{</span><span class="n">nid</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">places_m</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nid</span>
            <span class="k">elif</span> <span class="n">vt</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;object&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">vt</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;voxel&quot;</span><span class="p">):</span>
                <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;obj_</span><span class="si">{</span><span class="n">nid</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">objects_m</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nid</span>
        <span class="k">return</span> <span class="n">rooms_m</span><span class="p">,</span> <span class="n">places_m</span><span class="p">,</span> <span class="n">objects_m</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_has_state</span><span class="p">(</span><span class="n">nid</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check whether we have a stored state for the given node id.</span>

<span class="sd">        When using SceneGraphWorld memory, we support both integer keys</span>
<span class="sd">        and arbitrary NodeId-like keys by trying ``nid`` directly first</span>
<span class="sd">        and then falling back to ``int(nid)`` if conversion is possible.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">has_memory</span><span class="p">:</span>
            <span class="c1"># Try raw key as-is</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">nid</span> <span class="ow">in</span> <span class="n">mem</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="c1"># Some key types may not support `in` with this nid</span>
                <span class="k">pass</span>
            <span class="c1"># Fallback: try integer-cast key</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">nid_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nid</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="n">nid_int</span> <span class="ow">in</span> <span class="n">mem</span>
        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">nid</span> <span class="ow">in</span> <span class="n">index</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_vec</span><span class="p">(</span><span class="n">nid</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">has_memory</span><span class="p">:</span>
            <span class="c1"># Support both direct nid keys and integer-cast keys.</span>
            <span class="n">state</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># Try raw nid first</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">mem</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nid</span><span class="p">)</span>  <span class="c1"># type: ignore[call-arg]</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="c1"># If _memory is not a Mapping, fall back to direct indexing</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">state</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span>  <span class="c1"># type: ignore[index]</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">state</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Fallback: try integer-cast key</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">nid_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nid</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No state in SceneGraph memory for node id=</span><span class="si">{</span><span class="n">nid</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">state</span> <span class="o">=</span> <span class="n">mem</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nid_int</span><span class="p">)</span>  <span class="c1"># type: ignore[call-arg]</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="n">state</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="n">nid_int</span><span class="p">]</span>  <span class="c1"># type: ignore[index]</span>
            <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No state in SceneGraph memory for node id=</span><span class="si">{</span><span class="n">nid</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">v</span>
        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">x_opt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;x_opt and index must be provided when SceneGraph memory is not available&quot;</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">index</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="n">sl</span> <span class="o">=</span> <span class="n">idx</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="n">idx</span>
            <span class="n">sl</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="n">length</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x_opt</span><span class="p">[</span><span class="n">sl</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="c1"># Safely grab scene-graph structures (with defaults if missing).</span>
    <span class="n">rooms</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sg</span><span class="p">,</span> <span class="s2">&quot;rooms&quot;</span><span class="p">,</span> <span class="p">{})</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="n">places</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sg</span><span class="p">,</span> <span class="s2">&quot;places&quot;</span><span class="p">,</span> <span class="p">{})</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="n">objects</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sg</span><span class="p">,</span> <span class="s2">&quot;objects&quot;</span><span class="p">,</span> <span class="p">{})</span> <span class="ow">or</span> <span class="p">{}</span>

    <span class="c1"># If we have a memory layer but no explicit named dicts, derive them from memory.</span>
    <span class="k">if</span> <span class="n">has_memory</span> <span class="ow">and</span> <span class="n">mem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rooms</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rooms</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">mem_rooms</span><span class="p">,</span> <span class="n">mem_places</span><span class="p">,</span> <span class="n">mem_objects</span> <span class="o">=</span> <span class="n">_partition_memory_by_type</span><span class="p">()</span>
            <span class="c1"># Only fill in from memory when each layer is empty; this way,</span>
            <span class="c1"># user-provided names (if any) take precedence.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rooms</span><span class="p">:</span>
                <span class="n">rooms</span> <span class="o">=</span> <span class="n">mem_rooms</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">places</span><span class="p">:</span>
                <span class="n">places</span> <span class="o">=</span> <span class="n">mem_places</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">objects</span><span class="p">:</span>
                <span class="n">objects</span> <span class="o">=</span> <span class="n">mem_objects</span>

    <span class="n">place_parents</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sg</span><span class="p">,</span> <span class="s2">&quot;place_parents&quot;</span><span class="p">,</span> <span class="p">{})</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="n">object_parents</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sg</span><span class="p">,</span> <span class="s2">&quot;object_parents&quot;</span><span class="p">,</span> <span class="p">{})</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="n">attachments</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sg</span><span class="p">,</span> <span class="s2">&quot;place_attachments&quot;</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>

    <span class="c1"># -------------------------------------------------</span>
    <span class="c1"># Collect pose node ids (for rendering trajectories / agent poses).</span>
    <span class="c1"># We look in both the memory layer and the place-attachment edges.</span>
    <span class="n">pose_ids</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="c1"># From attachments: first element of each tuple is assumed to be a pose node id.</span>
    <span class="k">for</span> <span class="n">pose_nid</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">attachments</span><span class="p">:</span>
        <span class="n">pose_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pose_nid</span><span class="p">)</span>

    <span class="c1"># From memory: any node whose var_type starts with &quot;pose&quot; is treated as a pose.</span>
    <span class="k">if</span> <span class="n">has_memory</span> <span class="ow">and</span> <span class="n">mem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="s2">&quot;values&quot;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="p">[])():</span>
            <span class="n">vt</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;var_type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">vt</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;pose&quot;</span><span class="p">):</span>
                <span class="n">nid</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;node_id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">nid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">pose_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nid</span><span class="p">)</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s2">&quot;3d&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

    <span class="n">all_pts</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># ------------------------------</span>
    <span class="c1"># Rooms: large semi-transparent markers</span>
    <span class="c1"># ------------------------------</span>
    <span class="n">first_room</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">rooms</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">nid</span> <span class="ow">in</span> <span class="n">rooms</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_has_state</span><span class="p">(</span><span class="n">nid</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">_vec</span><span class="p">(</span><span class="n">nid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># If we only have 1D, pad to 3D for visualization</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">)</span>
        <span class="n">all_pts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;room&quot;</span> <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="n">first_room</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">s</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;s&quot;</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
            <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># ------------------------------</span>
    <span class="c1"># Places: medium spheres</span>
    <span class="c1"># ------------------------------</span>
    <span class="n">first_place</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">places</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">nid</span> <span class="ow">in</span> <span class="n">places</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_has_state</span><span class="p">(</span><span class="n">nid</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">_vec</span><span class="p">(</span><span class="n">nid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">)</span>
        <span class="n">all_pts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;place&quot;</span> <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="n">first_place</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># ------------------------------</span>
    <span class="c1"># Objects: small pyramids/triangles</span>
    <span class="c1"># ------------------------------</span>
    <span class="n">first_obj</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">objects</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">nid</span> <span class="ow">in</span> <span class="n">objects</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_has_state</span><span class="p">(</span><span class="n">nid</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">_vec</span><span class="p">(</span><span class="n">nid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">)</span>
        <span class="n">all_pts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;object&quot;</span> <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="n">first_obj</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">s</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;^&quot;</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># ------------------------------</span>
    <span class="c1"># Poses: agent pose nodes (small spheres)</span>
    <span class="c1"># ------------------------------</span>
    <span class="n">first_pose</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">pose_ids</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">nid</span> <span class="ow">in</span> <span class="n">pose_ids</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_has_state</span><span class="p">(</span><span class="n">nid</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">_vec</span><span class="p">(</span><span class="n">nid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">)</span>
        <span class="n">all_pts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;pose&quot;</span> <span class="k">if</span> <span class="n">nid</span> <span class="o">==</span> <span class="n">first_pose</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">s</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># ------------------------------</span>
    <span class="c1"># Hierarchical edges: room -&gt; place, place -&gt; object</span>
    <span class="c1"># ------------------------------</span>
    <span class="k">for</span> <span class="n">place_nid</span><span class="p">,</span> <span class="n">room_nid</span> <span class="ow">in</span> <span class="n">place_parents</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">_has_state</span><span class="p">(</span><span class="n">place_nid</span><span class="p">)</span> <span class="ow">and</span> <span class="n">_has_state</span><span class="p">(</span><span class="n">room_nid</span><span class="p">)):</span>
            <span class="k">continue</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">_vec</span><span class="p">(</span><span class="n">place_nid</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">_vec</span><span class="p">(</span><span class="n">room_nid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">r</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
            <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
            <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">for</span> <span class="n">obj_nid</span><span class="p">,</span> <span class="n">place_nid</span> <span class="ow">in</span> <span class="n">object_parents</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">_has_state</span><span class="p">(</span><span class="n">obj_nid</span><span class="p">)</span> <span class="ow">and</span> <span class="n">_has_state</span><span class="p">(</span><span class="n">place_nid</span><span class="p">)):</span>
            <span class="k">continue</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">_vec</span><span class="p">(</span><span class="n">obj_nid</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">_vec</span><span class="p">(</span><span class="n">place_nid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">o</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">o</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="p">[</span><span class="n">o</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
            <span class="p">[</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
            <span class="p">[</span><span class="n">o</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># ------------------------------</span>
    <span class="c1"># Place attachments: pose -&gt; place (dashed)</span>
    <span class="c1"># ------------------------------</span>
    <span class="k">for</span> <span class="n">pose_nid</span><span class="p">,</span> <span class="n">place_nid</span> <span class="ow">in</span> <span class="n">attachments</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">_has_state</span><span class="p">(</span><span class="n">pose_nid</span><span class="p">)</span> <span class="ow">and</span> <span class="n">_has_state</span><span class="p">(</span><span class="n">place_nid</span><span class="p">)):</span>
            <span class="k">continue</span>
        <span class="n">pose</span> <span class="o">=</span> <span class="n">_vec</span><span class="p">(</span><span class="n">pose_nid</span><span class="p">)</span>
        <span class="n">plc</span> <span class="o">=</span> <span class="n">_vec</span><span class="p">(</span><span class="n">place_nid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pose</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">pose</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">pose</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">pose</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">plc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">plc</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">plc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="p">[</span><span class="n">pose</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">plc</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
            <span class="p">[</span><span class="n">pose</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">plc</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
            <span class="p">[</span><span class="n">pose</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">plc</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># ------------------------------</span>
    <span class="c1"># Optional: agent trajectories from DynamicSceneGraph</span>
    <span class="c1"># ------------------------------</span>
    <span class="k">if</span> <span class="n">dsg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dsg</span><span class="p">,</span> <span class="s2">&quot;agents&quot;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">dsg</span><span class="o">.</span><span class="n">agents</span><span class="p">:</span>
            <span class="n">traj</span> <span class="o">=</span> <span class="n">dsg</span><span class="o">.</span><span class="n">get_agent_trajectory</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">x_opt</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
            <span class="n">traj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">traj</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">traj</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">traj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">zs</span> <span class="o">=</span> <span class="n">traj</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">traj</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">traj</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
            <span class="n">all_pts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">traj</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">zs</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="si">}</span><span class="s2">_traj&quot;</span><span class="p">)</span>

    <span class="c1"># ------------------------------</span>
    <span class="c1"># Autoscale axes to fit everything</span>
    <span class="c1"># ------------------------------</span>
    <span class="k">if</span> <span class="n">all_pts</span><span class="p">:</span>
        <span class="n">all_pts_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">all_pts</span><span class="p">)</span>
        <span class="n">mins</span> <span class="o">=</span> <span class="n">all_pts_arr</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">maxs</span> <span class="o">=</span> <span class="n">all_pts_arr</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">center</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">mins</span> <span class="o">+</span> <span class="n">maxs</span><span class="p">)</span>
        <span class="n">extent</span> <span class="o">=</span> <span class="nb">float</span><span class="p">((</span><span class="n">maxs</span> <span class="o">-</span> <span class="n">mins</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">extent</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">extent</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="mf">0.6</span> <span class="o">*</span> <span class="n">extent</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">scale</span><span class="p">,</span> <span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">scale</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">scale</span><span class="p">,</span> <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">scale</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_zlim</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">scale</span><span class="p">,</span> <span class="n">center</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">scale</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">)</span>

    <span class="c1"># Deduplicate legend entries</span>
    <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">labels</span><span class="p">:</span>
        <span class="n">uniq</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">handles</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">l</span> <span class="ow">and</span> <span class="n">l</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">uniq</span><span class="p">:</span>
                <span class="n">uniq</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">uniq</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">uniq</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h2 id="worlddynamic_scene_graph"><code>world.dynamic_scene_graph</code></h2>


<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">

        <p>Dynamic scene-graph utilities built on top of :mod:<code>world.scene_graph</code>.</p>
<p>This module provides a lightweight wrapper around :class:<code>world.scene_graph.SceneGraphWorld</code>
that makes <em>dynamic</em> (time-indexed) scene graphs easier to build and reason about.</p>
<p>The goal is to keep all of the optimization and factor-graph logic in the existing
engine, while giving users a small, ergonomic API for working with trajectories and
other time-varying entities.</p>
<h3 id="world.dynamic_scene_graph--design-goals">Design goals</h3>
<ul>
<li><strong>Don't duplicate state</strong>: the underlying :class:<code>SceneGraphWorld</code> and
  :class:<code>WorldModel</code> remain the single source of truth.</li>
<li><strong>Time-aware helpers</strong>: convenience functions for adding agent trajectories,
  querying poses across time, and wiring odometry factors between consecutive
  poses.</li>
<li><strong>Engine-friendly</strong>: everything ultimately calls into existing
  <code>SceneGraphWorld</code> methods, so this module is safe to ignore if you want to
  use the lower-level API directly.</li>
</ul>
<h3 id="world.dynamic_scene_graph--typical-usage">Typical usage</h3>
<p>.. code-block:: python</p>
<pre><code>from world.scene_graph import SceneGraphWorld
from world.dynamic_scene_graph import DynamicSceneGraph
import jax.numpy as jnp

sg = SceneGraphWorld()
dsg = DynamicSceneGraph(sg)

agent = "robot0"

# Add a short trajectory
dsg.add_agent_pose(agent, t=0, pose_se3=jnp.zeros(6))
dsg.add_agent_pose(agent, t=1, pose_se3=jnp.array([1.0, 0, 0, 0, 0, 0]))

# Connect poses with odometry in the x-direction
dsg.add_odom_tx(agent, t0=0, t1=1, dx=1.0, weight=10.0)

# Later, after optimization, you can recover the optimized trajectory with
# dsg.get_agent_trajectory(...).
</code></pre>










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="world.dynamic_scene_graph.DynamicSceneGraph" class="doc doc-heading">
              <code class="highlight language-python"><span class="n">DynamicSceneGraph</span><span class="p">(</span><span class="n">world</span><span class="p">,</span> <span class="n">agents</span><span class="o">=</span><span class="nb">set</span><span class="p">())</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">



        <p>Helper for building dynamic (time-indexed) scene graphs.</p>
<p>This class is a thin faade over :class:<code>world.scene_graph.SceneGraphWorld</code>.
It does <strong>not</strong> introduce new optimization logic or state; instead it
organizes common patterns for working with agent trajectories and other
dynamic structures.</p>
<h4 id="world.dynamic_scene_graph.DynamicSceneGraph--parameters">Parameters</h4>
<p>world:
    The underlying :class:<code>SceneGraphWorld</code> instance. All variables and
    factors are ultimately added to <code>world.wm</code>.
agents:
    Optional set of agent identifiers. You usually don't need to pass
    this explicitly; agents are registered lazily when you call
    :meth:<code>add_agent</code> or :meth:<code>add_agent_pose</code>.</p>











<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="world.dynamic_scene_graph.DynamicSceneGraph.add_agent" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_agent</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Register an agent identifier.</p>
<p>This does not create any variables by itself; it simply tracks the
identifier so you can discover which agents exist in the graph.</p>
<p>:param agent_id: Hashable identifier for the agent (for example, <code>"robot0"</code>).
:type agent_id: Hashable
:return: The same <code>agent_id</code> that was passed in, for convenience.
:rtype: Hashable</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/dynamic_scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_agent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="n">Hashable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Hashable</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Register an agent identifier.</span>

<span class="sd">    This does not create any variables by itself; it simply tracks the</span>
<span class="sd">    identifier so you can discover which agents exist in the graph.</span>

<span class="sd">    :param agent_id: Hashable identifier for the agent (for example, ``&quot;robot0&quot;``).</span>
<span class="sd">    :type agent_id: Hashable</span>
<span class="sd">    :return: The same ``agent_id`` that was passed in, for convenience.</span>
<span class="sd">    :rtype: Hashable</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">agent_id</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.dynamic_scene_graph.DynamicSceneGraph.add_agent_pose" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_agent_pose</span><span class="p">(</span><span class="n">agent_id</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">pose_se3</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Add an SE(3) pose variable for a given agent and time.</p>
<p>This delegates directly to :meth:<code>SceneGraphWorld.add_agent_pose_se3</code>
and records the agent identifier in :attr:<code>agents</code>.</p>
<p>:param agent_id: Identifier for the agent.
:type agent_id: Hashable
:param t: Discrete time index (for example, frame or step index).
:type t: int
:param pose_se3: 6D se(3) vector <code>[tx, ty, tz, rx, ry, rz]</code>.
:type pose_se3: jax.numpy.ndarray
:return: The node identifier of the newly created pose variable.
:rtype: NodeId</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/dynamic_scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_agent_pose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="n">Hashable</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">pose_se3</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NodeId</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add an SE(3) pose variable for a given agent and time.</span>

<span class="sd">    This delegates directly to :meth:`SceneGraphWorld.add_agent_pose_se3`</span>
<span class="sd">    and records the agent identifier in :attr:`agents`.</span>

<span class="sd">    :param agent_id: Identifier for the agent.</span>
<span class="sd">    :type agent_id: Hashable</span>
<span class="sd">    :param t: Discrete time index (for example, frame or step index).</span>
<span class="sd">    :type t: int</span>
<span class="sd">    :param pose_se3: 6D se(3) vector ``[tx, ty, tz, rx, ry, rz]``.</span>
<span class="sd">    :type pose_se3: jax.numpy.ndarray</span>
<span class="sd">    :return: The node identifier of the newly created pose variable.</span>
<span class="sd">    :rtype: NodeId</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">add_agent_pose_se3</span><span class="p">(</span><span class="n">agent_id</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">pose_se3</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.dynamic_scene_graph.DynamicSceneGraph.add_agent_trajectory" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_agent_trajectory</span><span class="p">(</span><span class="n">agent_id</span><span class="p">,</span> <span class="n">poses_se3</span><span class="p">,</span> <span class="n">start_t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">add_odom</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default_dx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Add a contiguous trajectory for one agent and optionally wire odometry.</p>
<p>This is a convenience helper that repeatedly calls :meth:<code>add_agent_pose</code>
and, if <code>add_odom</code> is <code>True</code>, :meth:<code>add_odom_tx</code> between consecutive
time steps.</p>
<p>:param agent_id: Identifier for the agent.
:type agent_id: Hashable
:param poses_se3: Iterable of se(3) pose vectors. The first element is
    placed at <code>t = start_t</code>, the next at <code>t = start_t + 1</code>, and so on.
:type poses_se3: Iterable[jax.numpy.ndarray]
:param start_t: Time index to use for the first pose.
:type start_t: int
:param add_odom: If <code>True</code>, automatically connect consecutive poses with
    a 1D odometry factor along <code>x</code> via :meth:<code>add_odom_tx</code>.
:type add_odom: bool
:param default_dx: If not <code>None</code>, use this value as the expected
    displacement in <code>x</code> between each consecutive pair of poses. If
    <code>None</code> and <code>add_odom</code> is <code>True</code>, the displacement is inferred as
    <code>poses_se3[k+1][0] - poses_se3[k][0]</code>.
:type default_dx: float | None
:param weight: Scalar weight used for each odometry factor when
    <code>add_odom</code> is enabled.
:type weight: float
:return: Node identifiers of all created pose variables, in temporal order.
:rtype: list[NodeId]</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/dynamic_scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_agent_trajectory</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">agent_id</span><span class="p">:</span> <span class="n">Hashable</span><span class="p">,</span>
    <span class="n">poses_se3</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
    <span class="n">start_t</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">add_odom</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">default_dx</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">weight</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">NodeId</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a contiguous trajectory for one agent and optionally wire odometry.</span>

<span class="sd">    This is a convenience helper that repeatedly calls :meth:`add_agent_pose`</span>
<span class="sd">    and, if ``add_odom`` is ``True``, :meth:`add_odom_tx` between consecutive</span>
<span class="sd">    time steps.</span>

<span class="sd">    :param agent_id: Identifier for the agent.</span>
<span class="sd">    :type agent_id: Hashable</span>
<span class="sd">    :param poses_se3: Iterable of se(3) pose vectors. The first element is</span>
<span class="sd">        placed at ``t = start_t``, the next at ``t = start_t + 1``, and so on.</span>
<span class="sd">    :type poses_se3: Iterable[jax.numpy.ndarray]</span>
<span class="sd">    :param start_t: Time index to use for the first pose.</span>
<span class="sd">    :type start_t: int</span>
<span class="sd">    :param add_odom: If ``True``, automatically connect consecutive poses with</span>
<span class="sd">        a 1D odometry factor along ``x`` via :meth:`add_odom_tx`.</span>
<span class="sd">    :type add_odom: bool</span>
<span class="sd">    :param default_dx: If not ``None``, use this value as the expected</span>
<span class="sd">        displacement in ``x`` between each consecutive pair of poses. If</span>
<span class="sd">        ``None`` and ``add_odom`` is ``True``, the displacement is inferred as</span>
<span class="sd">        ``poses_se3[k+1][0] - poses_se3[k][0]``.</span>
<span class="sd">    :type default_dx: float | None</span>
<span class="sd">    :param weight: Scalar weight used for each odometry factor when</span>
<span class="sd">        ``add_odom`` is enabled.</span>
<span class="sd">    :type weight: float</span>
<span class="sd">    :return: Node identifiers of all created pose variables, in temporal order.</span>
<span class="sd">    :rtype: list[NodeId]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">node_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">NodeId</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">start_t</span>
    <span class="n">prev_t</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">prev_pose</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">pose</span> <span class="ow">in</span> <span class="n">poses_se3</span><span class="p">:</span>
        <span class="n">nid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_agent_pose</span><span class="p">(</span><span class="n">agent_id</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">pose</span><span class="p">)</span>
        <span class="n">node_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nid</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">add_odom</span> <span class="ow">and</span> <span class="n">prev_t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">default_dx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dx</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">default_dx</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Infer displacement along x from the raw pose guesses</span>
                <span class="n">dx</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">pose</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">prev_pose</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_odom_tx</span><span class="p">(</span><span class="n">agent_id</span><span class="p">,</span> <span class="n">prev_t</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="n">dx</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">weight</span><span class="p">)</span>

        <span class="n">prev_t</span> <span class="o">=</span> <span class="n">t</span>
        <span class="n">prev_pose</span> <span class="o">=</span> <span class="n">pose</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">node_ids</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.dynamic_scene_graph.DynamicSceneGraph.add_odom_tx" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_odom_tx</span><span class="p">(</span><span class="n">agent_id</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Connect two consecutive poses with a 1D odometry factor in <code>x</code>.</p>
<p>This is a convenience wrapper around
:meth:<code>SceneGraphWorld.add_odom_se3_additive</code>, which interprets <code>dx</code> as a
translation along the <code>x</code> axis and assumes identity rotation.</p>
<p>:param agent_id: Agent identifier.
:type agent_id: Hashable
:param t0: Time index of the <em>from</em> pose.
:type t0: int
:param t1: Time index of the <em>to</em> pose.
:type t1: int
:param dx: Expected displacement in <code>x</code> from pose <code>(agent_id, t0)</code> to
    pose <code>(agent_id, t1)</code>.
:type dx: float
:param weight: Scalar weight applied to the odometry residual.
:type weight: float
:return: <code>None</code>.
:rtype: None</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/dynamic_scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_odom_tx</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">agent_id</span><span class="p">:</span> <span class="n">Hashable</span><span class="p">,</span>
    <span class="n">t0</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">t1</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">dx</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">weight</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Connect two consecutive poses with a 1D odometry factor in ``x``.</span>

<span class="sd">    This is a convenience wrapper around</span>
<span class="sd">    :meth:`SceneGraphWorld.add_odom_se3_additive`, which interprets ``dx`` as a</span>
<span class="sd">    translation along the ``x`` axis and assumes identity rotation.</span>

<span class="sd">    :param agent_id: Agent identifier.</span>
<span class="sd">    :type agent_id: Hashable</span>
<span class="sd">    :param t0: Time index of the *from* pose.</span>
<span class="sd">    :type t0: int</span>
<span class="sd">    :param t1: Time index of the *to* pose.</span>
<span class="sd">    :type t1: int</span>
<span class="sd">    :param dx: Expected displacement in ``x`` from pose ``(agent_id, t0)`` to</span>
<span class="sd">        pose ``(agent_id, t1)``.</span>
<span class="sd">    :type dx: float</span>
<span class="sd">    :param weight: Scalar weight applied to the odometry residual.</span>
<span class="sd">    :type weight: float</span>
<span class="sd">    :return: ``None``.</span>
<span class="sd">    :rtype: None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">pose_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">pose_trajectory</span><span class="p">[(</span><span class="n">agent_id</span><span class="p">,</span> <span class="n">t0</span><span class="p">)]</span>
    <span class="n">pose_j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">pose_trajectory</span><span class="p">[(</span><span class="n">agent_id</span><span class="p">,</span> <span class="n">t1</span><span class="p">)]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">add_odom_se3_additive</span><span class="p">(</span><span class="n">pose_i</span><span class="p">,</span> <span class="n">pose_j</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="n">dx</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">weight</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.dynamic_scene_graph.DynamicSceneGraph.add_range_obs" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_range_obs</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">target_nid</span><span class="p">,</span> <span class="n">measured_range</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Add a range measurement from an agent's pose at time t to a target node.</p>
<p>This wraps :meth:<code>SceneGraphWorld.add_range_measurement</code>, using the
pose node from <code>pose_trajectory[(agent, t)]</code>.</p>
<p>:param agent: Agent key, e.g. <code>"robot0"</code>.
:param t: Integer time step.
:param target_nid: NodeId of the target (place3d, voxel_cell, object3d, etc.).
:param measured_range: Observed distance.
:param sigma: Optional measurement noise standard deviation.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/dynamic_scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_range_obs</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">agent</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">t</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">target_nid</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">measured_range</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add a range measurement from an agent&#39;s pose at time t to a target node.</span>

<span class="sd">    This wraps :meth:`SceneGraphWorld.add_range_measurement`, using the</span>
<span class="sd">    pose node from ``pose_trajectory[(agent, t)]``.</span>

<span class="sd">    :param agent: Agent key, e.g. ``&quot;robot0&quot;``.</span>
<span class="sd">    :param t: Integer time step.</span>
<span class="sd">    :param target_nid: NodeId of the target (place3d, voxel_cell, object3d, etc.).</span>
<span class="sd">    :param measured_range: Observed distance.</span>
<span class="sd">    :param sigma: Optional measurement noise standard deviation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pose_nid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">pose_trajectory</span><span class="p">[(</span><span class="n">agent</span><span class="p">,</span> <span class="n">t</span><span class="p">)]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">add_range_measurement</span><span class="p">(</span>
        <span class="n">pose_nid</span><span class="o">=</span><span class="n">pose_nid</span><span class="p">,</span>
        <span class="n">target_nid</span><span class="o">=</span><span class="n">target_nid</span><span class="p">,</span>
        <span class="n">measured_range</span><span class="o">=</span><span class="n">measured_range</span><span class="p">,</span>
        <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.dynamic_scene_graph.DynamicSceneGraph.all_pose_time_keys" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">all_pose_time_keys</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Return all <code>(agent, t)</code> keys present in the underlying world.</p>
<p>This is mainly useful for debugging or for building custom visualizations
and exporters.</p>
<p>:return: All time-index keys found in
    :attr:<code>SceneGraphWorld.pose_trajectory</code>.
:rtype: list[TimeKey]</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/dynamic_scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">all_pose_time_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">TimeKey</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return all ``(agent, t)`` keys present in the underlying world.</span>

<span class="sd">    This is mainly useful for debugging or for building custom visualizations</span>
<span class="sd">    and exporters.</span>

<span class="sd">    :return: All time-index keys found in</span>
<span class="sd">        :attr:`SceneGraphWorld.pose_trajectory`.</span>
<span class="sd">    :rtype: list[TimeKey]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">pose_trajectory</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.dynamic_scene_graph.DynamicSceneGraph.get_agent_pose_nodes" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_agent_pose_nodes</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Return the sequence of pose node IDs for an agent, ordered by time.</p>
<p>:param agent_id: Agent identifier.
:type agent_id: Hashable
:return: Pose node IDs for the given agent, sorted by their time index.
:rtype: list[NodeId]</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/dynamic_scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_agent_pose_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="n">Hashable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">NodeId</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the sequence of pose node IDs for an agent, ordered by time.</span>

<span class="sd">    :param agent_id: Agent identifier.</span>
<span class="sd">    :type agent_id: Hashable</span>
<span class="sd">    :return: Pose node IDs for the given agent, sorted by their time index.</span>
<span class="sd">    :rtype: list[NodeId]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_agent_times</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">pose_trajectory</span><span class="p">[(</span><span class="n">agent_id</span><span class="p">,</span> <span class="n">t</span><span class="p">)]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">times</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.dynamic_scene_graph.DynamicSceneGraph.get_agent_times" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_agent_times</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Return the sorted list of time indices for which this agent has poses.</p>
<p>:param agent_id: Agent identifier.
:type agent_id: Hashable
:return: Sorted time indices where <code>(agent_id, t)</code> exists in
    :attr:<code>SceneGraphWorld.pose_trajectory</code>.
:rtype: list[int]</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/dynamic_scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_agent_times</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="n">Hashable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the sorted list of time indices for which this agent has poses.</span>

<span class="sd">    :param agent_id: Agent identifier.</span>
<span class="sd">    :type agent_id: Hashable</span>
<span class="sd">    :return: Sorted time indices where ``(agent_id, t)`` exists in</span>
<span class="sd">        :attr:`SceneGraphWorld.pose_trajectory`.</span>
<span class="sd">    :rtype: list[int]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">times</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">pose_trajectory</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="n">agent_id</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.dynamic_scene_graph.DynamicSceneGraph.get_agent_trajectory" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_agent_trajectory</span><span class="p">(</span><span class="n">agent_id</span><span class="p">,</span> <span class="n">x_opt</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Extract an optimized trajectory for one agent from a flat state vector.</p>
<p>:param agent_id: Agent identifier.
:type agent_id: Hashable
:param x_opt: Optimized flat state vector produced by one of the
    GaussNewton solvers, such as
    :func:<code>optimization.solvers.gauss_newton_manifold</code>.
:type x_opt: jax.numpy.ndarray
:param index: Mapping from :class:<code>NodeId</code> to <code>(start, dim)</code> tuples as
    returned by :meth:<code>world.model.WorldModel.pack_state</code>.
:type index: Mapping[NodeId, Tuple[int, int]]
:return: Array of shape <code>(T, 6)</code> containing the se(3) vectors for each
    time step in chronological order.
:rtype: jax.numpy.ndarray</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/dynamic_scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_agent_trajectory</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">agent_id</span><span class="p">:</span> <span class="n">Hashable</span><span class="p">,</span>
    <span class="n">x_opt</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">index</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">NodeId</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract an optimized trajectory for one agent from a flat state vector.</span>

<span class="sd">    :param agent_id: Agent identifier.</span>
<span class="sd">    :type agent_id: Hashable</span>
<span class="sd">    :param x_opt: Optimized flat state vector produced by one of the</span>
<span class="sd">        GaussNewton solvers, such as</span>
<span class="sd">        :func:`optimization.solvers.gauss_newton_manifold`.</span>
<span class="sd">    :type x_opt: jax.numpy.ndarray</span>
<span class="sd">    :param index: Mapping from :class:`NodeId` to ``(start, dim)`` tuples as</span>
<span class="sd">        returned by :meth:`world.model.WorldModel.pack_state`.</span>
<span class="sd">    :type index: Mapping[NodeId, Tuple[int, int]]</span>
<span class="sd">    :return: Array of shape ``(T, 6)`` containing the se(3) vectors for each</span>
<span class="sd">        time step in chronological order.</span>
<span class="sd">    :rtype: jax.numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_agent_pose_nodes</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span>
    <span class="n">traj</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">nid</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
        <span class="n">start</span><span class="p">,</span> <span class="n">dim</span> <span class="o">=</span> <span class="n">index</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span>
        <span class="n">traj</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_opt</span><span class="p">[</span><span class="n">start</span> <span class="p">:</span> <span class="n">start</span> <span class="o">+</span> <span class="n">dim</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">traj</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="world.dynamic_scene_graph.DynamicSceneGraph.get_all_trajectories" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_all_trajectories</span><span class="p">(</span><span class="n">x_opt</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Extract trajectories for all known agents from an optimized state.</p>
<p>This is a convenience wrapper around :meth:<code>get_agent_trajectory</code> that
iterates over :attr:<code>agents</code> and returns a mapping from agent identifier
to a <code>(T_i, 6)</code> array of se(3) poses.</p>
<p>:param x_opt: Optimized flat state vector produced by one of the
    GaussNewton solvers.
:type x_opt: jax.numpy.ndarray
:param index: Mapping from :class:<code>NodeId</code> to <code>(start, dim)</code> tuples as
    returned by :meth:<code>world.model.WorldModel.pack_state</code>.
:type index: Mapping[NodeId, Tuple[int, int]]
:return: Dictionary mapping each agent identifier to its optimized
    trajectory as an array of shape <code>(T_i, 6)</code>.
:rtype: dict[Hashable, jax.numpy.ndarray]</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>dsg-jit/dsg_jit/world/dynamic_scene_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_all_trajectories</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">x_opt</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">index</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">NodeId</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Hashable</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract trajectories for all known agents from an optimized state.</span>

<span class="sd">    This is a convenience wrapper around :meth:`get_agent_trajectory` that</span>
<span class="sd">    iterates over :attr:`agents` and returns a mapping from agent identifier</span>
<span class="sd">    to a ``(T_i, 6)`` array of se(3) poses.</span>

<span class="sd">    :param x_opt: Optimized flat state vector produced by one of the</span>
<span class="sd">        GaussNewton solvers.</span>
<span class="sd">    :type x_opt: jax.numpy.ndarray</span>
<span class="sd">    :param index: Mapping from :class:`NodeId` to ``(start, dim)`` tuples as</span>
<span class="sd">        returned by :meth:`world.model.WorldModel.pack_state`.</span>
<span class="sd">    :type index: Mapping[NodeId, Tuple[int, int]]</span>
<span class="sd">    :return: Dictionary mapping each agent identifier to its optimized</span>
<span class="sd">        trajectory as an array of shape ``(T_i, 6)``.</span>
<span class="sd">    :rtype: dict[Hashable, jax.numpy.ndarray]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">trajectories</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Hashable</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">agent_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">:</span>
        <span class="n">trajectories</span><span class="p">[</span><span class="n">agent_id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_agent_trajectory</span><span class="p">(</span><span class="n">agent_id</span><span class="p">,</span> <span class="n">x_opt</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">trajectories</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.sections", "navigation.tracking", "content.code.annotate", "content.tabs.link", "content.code.copy", "search.highlight", "search.suggest"], "search": "../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
    
  </body>
</html>